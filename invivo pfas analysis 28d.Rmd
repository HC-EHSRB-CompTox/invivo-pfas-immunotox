#Load libraries
```{r}
library(readxl)
library(forcats) 
library(tidyr)  
library(dplyr)  
library(ggsignif)
library(ggplot2)
library(broom) 
library(rstatix)
library(ggpubr)
library(stringr)
library(viridis)
library(emmeans)
library(purrr)
library(car)
library(extrafont)
library(plotrix)
library(FSA) 
library(ggpubr)  
R.Version()

```
#Liver tox
##Biochem stats and plot
```{r}
data_bio <- read.csv("../invivo-pfas-immunotox/R input 28d/biochemistry 28d.csv")

data_bio <- data_bio %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_bio <- data_bio %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

controls <- data_bio %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_bio <- data_bio %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_bio <- data_bio %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose),
    names_to = "Marker",
    values_to = "Value"
  )


data_bio <- data_bio %>% filter(!is.na(Value))

data_bio$Value <- as.numeric(data_bio$Value)
data_female <- data_bio %>% filter(Sex == "Female")
data_male <- data_bio %>% filter(Sex == "Male")
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}


sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)
unique_markers <- unique(data_bio$Marker)


##########################################################################################################################
#Normalize 
data_bio <- data_bio %>%
  group_by(Sex, PFAS, Marker) %>%
  mutate(vehicle_median = median(Value[Dose == "Vehicle"], na.rm = TRUE),
         normalized = Value / vehicle_median,
         percent_of_vehicle = (Value / vehicle_median) * 100) %>%
  ungroup()
data_female <- data_bio %>% filter(Sex == "Female")
data_male <- data_bio %>% filter(Sex == "Male")


get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      kw_test <- kruskal.test(normalized ~ Dose, data = subset_data)

      if (kw_test$p.value < 0.05) {
        dunn_result <- dunnTest(normalized ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$normalized, na.rm = TRUE)
          increment <- max_y * 0.1
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + 10)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")

significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)

#############################################################################################################
#Heatmap
sig_for_heatmap <- significance_df_non_parametric %>%
  mutate(
    Dose = str_remove(group1, ".* "),
    Dose = ifelse(group1 %in% c("Naive", "Vehicle"), group1, Dose),
    Marker = as.character(Marker)  # ensure type consistency
  ) %>%
  dplyr::select(Sex, PFAS, Marker, Dose, significance)
heatmap_data <- data_bio %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(median_norm = median(normalized, na.rm = TRUE), .groups = "drop")
heatmap_with_sig <- heatmap_data %>%
  left_join(sig_for_heatmap, by = c("Sex", "PFAS", "Marker", "Dose"))

heatmap_with_sig$Dose <- factor(heatmap_with_sig$Dose, levels = c( "1.5","Vehicle", "Naive"))
heatmap_with_sig$Marker <- factor(heatmap_with_sig$Marker, levels = c("ALP",	"ALT",	"CA",	"CHOL",	"FT4", "LDH","TBI",	"TGL"))
                           
heatmap_bio <- ggplot(heatmap_with_sig, aes(x = Marker, y = Dose, fill = median_norm)) +
  geom_tile(color = "black", size = 0.4) +
  geom_text(aes(label = round(median_norm, 2)), size = 2.5, color = "black") +
  #geom_text(aes(label = significance), vjust = 0.4, size = 6, color = "black", fontface = "bold") +
  scale_fill_gradient2(
    low = "#330597", mid = "white", high = "red", midpoint = 1,
    name = "Normalized\nMedian", limits = c(0, 4),  oob = scales::squish 
  ) +
  facet_grid(Sex ~ PFAS) +
scale_x_discrete(position = "top") + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
  text = element_text(size = 12, family = "Arial"),
  axis.text.x = element_text(angle = 45, hjust = 0, size = 12),
  axis.text.y = element_text(size = 12),
  panel.grid = element_blank(),
 strip.text = element_text(face = "bold", size = 12)
)+ coord_fixed(ratio = 1)

n_markers <- length(unique(heatmap_with_sig$Marker))
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
n_doses <- length(dose_levels)
tile_width_in <- 1
tile_height_in <- 1
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in 


ggsave(
  filename = "../invivo-pfas-immunotox/R input 28d/plots/bio_heatmap.png",
  plot = heatmap_bio,
  width = plot_width,
  height = plot_height,
  dpi = 300,
  bg = "white"
)
print(heatmap_bio)
##########################################################################################################################
#Dose-response curve
pfas_order <- c("PFOS", "PFOA")
dose_levels <- c("Naive", "Vehicle", "1.5")
marker_levels <- c("ALP",	"ALT",	"CA",	"CHOL",	"FT4", "LDH","TBI",	"TGL")

data_bio$PFAS <- factor(data_bio$PFAS, levels = pfas_order)
data_bio$Dose <- factor(data_bio$Dose, levels = dose_levels)
data_bio$Marker <- factor(data_bio$Marker, levels = marker_levels)

n_markers <- length(unique(heatmap_with_sig$Marker))/2
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
n_doses <- length(dose_levels)
tile_width_in <- 2.5
tile_height_in <- 2.5
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in * n_sex * n_pfas


summary_data <- data_bio %>%
  group_by(Sex, PFAS, Marker, Dose) %>%
  summarise(
    median_stat = median(Value, na.rm = TRUE),
    Q1 = quantile(Value, 0.25, na.rm = TRUE),
    Q3 = quantile(Value, 0.75, na.rm = TRUE),
    IQR = Q3 - Q1,
    lower = median_stat - 1.5 * IQR,
    upper = median_stat + 1.5 * IQR,
    .groups = "drop"
  ) %>%
  mutate(
    y_position_label = upper + 1,
    Marker = factor(Marker, levels = marker_levels),
    Dose_factor = factor(Dose, levels = dose_levels)
  )

summary_data <- summary_data %>%
  left_join(
    significance_df_non_parametric %>%
      dplyr::select(PFAS, Marker, group1, significance) %>%
      rename(Dose = group1),
    by = c("PFAS", "Marker", "Dose")
  )
vehicle_medians <- data_bio %>%
  filter(Dose == "Vehicle") %>%
  group_by(Sex, PFAS, Marker) %>%
  summarise(vehicle_median = median(Value, na.rm = TRUE), .groups = "drop")
summary_data <- summary_data %>%
  left_join(vehicle_medians, by = c("Sex", "PFAS", "Marker"))

summary_data$Marker <- factor(summary_data$Marker, levels = marker_levels)

custom_colors_named <- c(
  "Naive" = "#330597",
  "Vehicle" = "#8405a7",
  "1.5" = "#fec029"
)

sex_colors <- c("Male" = "#1f77b4", "Female" = "#e377c2")

plot <- ggplot(data_bio, aes(x = interaction(Dose, Sex), y = Value)) +
  geom_jitter(
    aes(color = Dose),
    size = 1, alpha = 0.4, width = 0.2
  ) +
  geom_boxplot(
    aes(group = interaction(Dose, Sex, Marker), fill = Dose),
    outlier.shape = NA, alpha = 0.3, color = "black", width = 0.6,
    position = position_dodge(width = 0.75)
  ) +
  geom_hline(
    data = summary_data,
    aes(yintercept = vehicle_median, color = Sex, group = interaction(Sex, Marker)),
    linetype = "dotted", size = 0.8, alpha = 0.7,
    inherit.aes = FALSE
  ) +
  facet_wrap(PFAS ~ Marker, scales = "free_y", nrow = 4) +
  scale_color_manual(
    name = "Color",
    values = c(custom_colors_named, sex_colors)
  ) +
  scale_fill_manual(
    name = "Dose",
    values = custom_colors_named
  ) +
  labs(
    title = "Normalized Response by Dose and Sex",
    x = "Dose and Sex",
    y = "Value"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )

print(plot)
ggsave(filename = "../invivo-pfas-immunotox/R input 28d/plots/bio_dr_28.png", plot = plot,
  width = plot_width,
  height =  14,
  dpi = 300,
  bg = "white")
replicate_summary <- data_bio%>%
  group_by(Sex, Dose, PFAS, Marker) %>% 
  summarise(n = n(), .groups = "drop")

min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```


##Tissue weight stats and plot
```{r}
data_tissue <- read.csv("../invivo-pfas-immunotox/R input 28d/tissue weight norm 28d.csv")

data_tissue <- data_tissue %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_tissue <- data_tissue %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

controls <- data_tissue %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))


data_tissue <- data_tissue %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_tissue <- data_tissue %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose),
    names_to = "Marker",
    values_to = "Value"
  )

data_tissue <- data_tissue %>% filter(!is.na(Value))
data_tissue$Value <- as.numeric(data_tissue$Value)
data_female <- data_tissue %>% filter(Sex == "Female")
data_male <- data_tissue %>% filter(Sex == "Male")

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}


sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")

significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)
unique_markers <- unique(data_tissue$Marker)
##########################################################################################################################
#Normalize 
data_tissue <- data_tissue %>%
  group_by(Sex, PFAS, Marker) %>%
  mutate(vehicle_median = median(Value[Dose == "Vehicle"], na.rm = TRUE),
         normalized = Value / vehicle_median,
         percent_of_vehicle = (Value / vehicle_median) * 100) %>%
  ungroup()
data_female <- data_tissue %>% filter(Sex == "Female")
data_male <- data_tissue %>% filter(Sex == "Male")

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      kw_test <- kruskal.test(normalized ~ Dose, data = subset_data)

      if (kw_test$p.value < 0.05) {
        dunn_result <- dunnTest(normalized ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$normalized, na.rm = TRUE)
          increment <- max_y * 0.1
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + 10)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)

##########################################################################################################################
#Heatmap
sig_for_heatmap <- significance_df_non_parametric %>%
  mutate(
    Dose = str_remove(group1, ".* "),  
    Dose = ifelse(group1 %in% c("Naive", "Vehicle"), group1, Dose),
    Marker = as.character(Marker) 
  ) %>%
  dplyr::select(Sex, PFAS, Marker, Dose, significance)
heatmap_data <- data_tissue %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(median_norm = median(normalized, na.rm = TRUE), .groups = "drop")
heatmap_with_sig <- heatmap_data %>%
  left_join(sig_for_heatmap, by = c("Sex", "PFAS", "Marker", "Dose"))

heatmap_with_sig$Dose <- factor(heatmap_with_sig$Dose, levels = c( "1.5","Vehicle", "Naive"))
heatmap_with_sig$Marker <- factor(heatmap_with_sig$Marker, levels = c("Liver", "Pancreas", "Spleen", "Thymus", "Kidneys", "GI.Tract"))
                           
heatmap_tissue <- ggplot(heatmap_with_sig, aes(x = Marker, y = Dose, fill = median_norm)) +
  geom_tile(color = "black", size = 0.4) +
  geom_text(aes(label = round(median_norm, 2)), size = 2.5, color = "black") +
  #geom_text(aes(label = significance), vjust = 0.4, size = 6, color = "black", fontface = "bold") +
  scale_fill_gradient2(
    low = "#330597", mid = "white", high = "red", midpoint = 1,
    name = "Normalized\nMedian", limits = c(0, 2),  oob = scales::squish 
  ) +
  facet_grid(Sex ~ PFAS) +
scale_x_discrete(position = "top") + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
  text = element_text(size = 12, family = "Arial"),
  axis.text.x = element_text(angle = 45, hjust = 0, size = 12),
  axis.text.y = element_text(size = 12),
  panel.grid = element_blank(),
 strip.text = element_text(face = "bold", size = 12)
)+ coord_fixed(ratio = 1)

n_markers <- length(unique(heatmap_with_sig$Marker))
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
dose_levels <- c("Naive", "Vehicle", "1.5")
n_doses <- length(dose_levels)
tile_width_in <- 1
tile_height_in <- 1
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in 

ggsave(
  filename = "../invivo-pfas-immunotox/R input 28d/plots/tissue_heatmap.png",
  plot = heatmap_tissue,
  width = plot_width,
  height = plot_height,
  dpi = 300,
  bg = "white"
)
print(heatmap_tissue)
##########################################################################################################################
#Dose-response curve
pfas_order <- c("PFOS", "PFOA")
dose_levels <- c("Naive", "Vehicle", "1.5")
marker_levels <- c("Liver", "Pancreas", "Spleen", "Thymus", "Kidneys", "GI.Tract")

data_tissue$PFAS <- factor(data_tissue$PFAS, levels = pfas_order)
data_tissue$Dose <- factor(data_tissue$Dose, levels = dose_levels)
data_tissue$Marker <- factor(data_tissue$Marker, levels = marker_levels)

n_markers <- length(unique(heatmap_with_sig$Marker))
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
n_doses <- length(dose_levels)
tile_width_in <- 2.5
tile_height_in <- 2.5
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in * n_sex * n_pfas

summary_data <- data_tissue %>%
  group_by(Sex, PFAS, Marker, Dose) %>%
  summarise(
    median_stat = median(Value, na.rm = TRUE),
    Q1 = quantile(Value, 0.25, na.rm = TRUE),
    Q3 = quantile(Value, 0.75, na.rm = TRUE),
    IQR = Q3 - Q1,
    lower = median_stat - 1.5 * IQR,
    upper = median_stat + 1.5 * IQR,
    .groups = "drop"
  ) %>%
  mutate(
    y_position_label = upper + 1,
    Marker = factor(Marker, levels = marker_levels),
    Dose_factor = factor(Dose, levels = dose_levels)
  )

summary_data <- summary_data %>%
  left_join(
    significance_df_non_parametric %>%
      dplyr::select(PFAS, Marker, group1, significance) %>%
      rename(Dose = group1),
    by = c("PFAS", "Marker", "Dose")
  )
vehicle_medians <- data_tissue %>%
  filter(Dose == "Vehicle") %>%
  group_by(Sex, PFAS, Marker) %>%
  summarise(vehicle_median = median(Value, na.rm = TRUE), .groups = "drop")
summary_data <- summary_data %>%
  left_join(vehicle_medians, by = c("Sex", "PFAS", "Marker"))

summary_data$Marker <- factor(summary_data$Marker, levels = marker_levels)

custom_colors_named <- c(
  "Naive" = "#330597",
  "Vehicle" = "#8405a7",
  "1.5" = "#fec029"
)

sex_colors <- c("Male" = "#1f77b4", "Female" = "#e377c2")

plot <- ggplot(data_tissue, aes(x = interaction(Dose, Sex), y = Value)) +
  geom_jitter(
    aes(color = Dose),
    size = 1, alpha = 0.4, width = 0.2
  ) +
  geom_boxplot(
    aes(group = interaction(Dose, Sex, Marker), fill = Dose),
    outlier.shape = NA, alpha = 0.3, color = "black", width = 0.6,
    position = position_dodge(width = 0.75)
  ) +
  geom_hline(
    data = summary_data,
    aes(yintercept = vehicle_median, color = Sex, group = interaction(Sex, Marker)),
    linetype = "dotted", size = 0.8, alpha = 0.7,
    inherit.aes = FALSE
  ) +
  facet_wrap(PFAS ~ Marker, scales = "free_y", nrow = 2) +
  scale_color_manual(
    name = "Color",
    values = c(custom_colors_named, sex_colors)
  ) +
  scale_fill_manual(
    name = "Dose",
    values = custom_colors_named
  ) +
  labs(
    title = "Normalized Response by Dose and Sex",
    x = "Dose and Sex",
    y = "Value"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )

print(plot)
ggsave(filename = "../invivo-pfas-immunotox/R input 28d/plots/tissue_dr.png", plot = plot,
  width = plot_width,
  height = 7,
  dpi = 300,
  bg = "white")
replicate_summary <- data_tissue%>%
  group_by(Sex, Dose, PFAS, Marker) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```

##Liver conc
```{r}
#If multiple RR used first (checked that they were similar)
data_conc <- read.csv("../invivo-pfas-immunotox/R input 28d/Liver PFAS values phase 1 28d.csv")

#mouse livers switched (plasma data okay) mice removed
data_conc <- data_conc %>%
  filter(!Mouse.ID %in% c("FS46", "FV28"))

doses <- c("Naive", "Vehicle", " PFOA 1.5",  " PFOS 1.5")
pfas_cols <- c(
  "PFOA", "PFOS", "PFBA", "PFPeA", "PFHxA", "PFHpA", "PFNA", "PFDA", "PFUdA", "PFDoA", "PFTrDA", "PFTeDA",
  "PFBS", "PFPeS", "PFHxS", "PFHpS", "PFNS", "PFDS",
  "X4_2.FTS", "X6_2_FTS", "X8_2.FTS", "N.MeFOSAA", "N.EtFOSAA", "FOSA"
)
mdls_naive_vehicle <- c(
  PFOA = 0.184, PFOS = 0.285, PFBA = 0.139, PFPeA = 0.164, PFHxA = 0.138,
  PFHpA = 0.107, PFNA = 0.153, PFDA = 0.114, PFUdA = 0.115, PFDoA = 0.087,
  PFTrDA = 0.104, PFTeDA = 0.145, PFBS = 0.526, PFPeS = 0.297, PFHxS = 0.758,
  PFHpS = 0.251, PFNS = 0.232, PFDS = 0.202, `X4_2.FTS` = 0.211, `X6_2_FTS` = 0.306,
  `X8_2.FTS` = 0.231
)

mdls_dose_1_15 <-  c(
  PFOA = 0.781, PFOS = 1.148, PFBA = 0.392, PFPeA = 0.426, PFHxA = 0.573,
  PFHpA = 0.233, PFNA = 0.766, PFDA = 1.030, PFUdA = 0.372, PFDoA = 0.575,
  PFTrDA = 0.524, PFTeDA = 0.562, PFBS = 0.748, PFPeS = 1.263, PFHxS = 0.776,
  PFHpS = 0.932, PFNS = 0.822, PFDS = 1.309, `X4_2.FTS` = 0.369, `X6_2_FTS` = 1.381,
  `X8_2.FTS` = 1.354, N.MeFOSAA = 1.455, N.EtFOSAA = 0.854, FOSA = 0.513
)

mdls_df <- bind_rows(
  tibble(Group = "Naive", !!!mdls_naive_vehicle),
  tibble(Group = "Vehicle", !!!mdls_naive_vehicle),
  tibble(Group = "1.5", !!!mdls_dose_1_15)
) %>%
  pivot_longer(
    -Group,
    names_to = "PFAS",
    values_to = "MDL"
  )


pfas_cols <- mdls_df$PFAS %>% unique()
data_conc[pfas_cols] <- lapply(data_conc[pfas_cols], as.character)

for (pfas_name in unique(mdls_df$PFAS)) {
  if (pfas_name %in% colnames(data_conc)) {
    for (dose_level in unique(mdls_df$Group)) {
      mdl_val <- mdls_df %>%
        filter(PFAS == pfas_name, Group == dose_level) %>%
        pull(MDL)

      if (length(mdl_val) == 1 && !is.na(mdl_val)) {
        dose_match <- trimws(gsub("^.*\\s", "", data_conc$Group))
        idx <- which(dose_match == dose_level & data_conc[[pfas_name]] == "<MDL")

        if (length(idx) > 0) {
          data_conc[idx, pfas_name] <- mdl_val / 2
        }
      }
    }
  }
}

pfas_cols <- unique(mdls_df$PFAS)
data_conc[pfas_cols] <- lapply(data_conc[pfas_cols], as.numeric)
pfas_cols <- unique(mdls_df$PFAS)
data_conc[data_conc$Group %in% c("Naive", "Vehicle"), pfas_cols] <-
  data_conc[data_conc$Group %in% c("Naive", "Vehicle"), pfas_cols] / 1000

data_conc_subset <- data_conc %>%
  dplyr::select(Mouse.ID, Sex, Group, all_of(pfas_cols))

#write.csv(data_conc, file = "../invivo-pfas-immunotox/R input 28d/Liver_PFAS_values_fixed_28d.csv", row.names = FALSE)

other_pfas <- setdiff(pfas_cols, c("PFOS", "PFOA"))
plasma_colors <- viridis(length(other_pfas), option = "plasma")
names(plasma_colors) <- other_pfas

custom_colors <- c(
  "PFOS" = "red",   
  "PFOA" = "blue",    
  plasma_colors          
)

group_levels <- c(
  "Naive", "Vehicle",
  paste("PFOS", c("0.166", "0.5", "1", "1.5")),
  paste("PFOA", c("0.166", "0.5", "1", "1.5"))
)

data_combined_long <- data_conc %>%
  pivot_longer(
    cols = all_of(pfas_cols),
    names_to = "PFAS_name",
    values_to = "PFAS_conc"
  ) %>%
  filter(!is.na(PFAS_conc)) %>%
  mutate(
    PFAS_conc = as.numeric(PFAS_conc),
    group = factor(Group, levels = group_levels),
    PFAS_name = factor(PFAS_name, levels = names(custom_colors)) 
  )

p <-ggplot(data_combined_long, aes(x = group, y = PFAS_conc, color =  PFAS_name, shape= Sex)) +
    geom_jitter(alpha = 0.7, size = 2.2, width = 0.2, height = 0) +
  scale_color_manual(values = custom_colors) +
  labs(
    x = "Group",
    y = "Liver PFAS concentration (mg/kg)",
    color = "PFAS"
  ) +
   coord_cartesian(ylim = c(0, 800)) +  
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )
print(p)
ggsave(filename = "../invivo-pfas-immunotox/R input 28d/plots/liver_conc.png", plot = p, width = 5, height = 5, dpi = 300,bg = "white")
replicate_summary <- data_conc%>%
  group_by(Group) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```

#Plasma toxicity using real values
```{r}
#If multiple RR used first (checked that they were similar)
#fs49 recorded wromg name removed that mouse because i am unsure

data_conc <- read.csv("../invivo-pfas-immunotox/R input 28d/plasma 28d.csv")
data_conc <- data_conc %>%
  filter(!Mouse.ID %in% c("FS48"))
doses <- c("Naive", "Vehicle", " PFOA 1.5", " PFOS 1.5")
colnames(data_conc)
pfas_cols <- c(
  "PFOA", "PFOS", "PFBA", "PFPeA", "PFHxA", "PFHpA", "PFNA", "PFDA", "PFUdA", "PFDoA",
  "PFTrDA", "PFTeDA", "PFBS", "PFPeS", "PFHxS_T", "PFHpS", "PFNS", "PFDS",
  "X4_2.FTS", "X6_2_FTS", "X8_2.FTS", "N.MeFOSAA", "N.EtFOSAA", "FOSA"
)


mdls_naive_vehicle <- c(
  PFOS = 0.284, PFOA = 0.219, PFBA = 0.146, PFPeA = 0.231, PFHxA = 0.168,
  PFHpA = 0.096, PFNA = 0.123, PFDA = 0.130, PFUdA = 0.124, PFDoA = 0.131,
  PFTrDA = 0.103, PFTeDA = 0.101, PFBS = 0.134, PFPeS = 0.161, PFHxS_T = 0.188,
  PFHpS = 0.170, PFNS = 0.227, PFDS = 0.242, `X4_2.FTS` = 0.175, `X6_2_FTS` = 0.250,
  `X8_2.FTS` = 0.271, `N.MeFOSAA` = NA, `N.EtFOSAA` = NA, FOSA = NA
)

mdls_dose_1_15 <-  c(
  PFOS = 0.230, PFOA = 0.156, PFBA = 0.078, PFPeA = 0.085, PFHxA = 0.115,
  PFHpA = 0.047, PFNA = 0.153, PFDA = 0.206, PFUdA = 0.074, PFDoA = 0.115,
  PFTrDA = 0.105, PFTeDA = 0.112, PFBS = 0.150, PFPeS = 0.253, PFHxS_T = 0.155,
  PFHpS = 0.186, PFNS = 0.164, PFDS = 0.262, `X4_2.FTS` = 0.074, `X6_2_FTS` = 0.276,
  `X8_2.FTS` = 0.271, `N.MeFOSAA` = 0.291, `N.EtFOSAA` = 0.171, FOSA = 0.103
)

mdls_df <- bind_rows(
  tibble(Group = "Naive", !!!mdls_naive_vehicle),
  tibble(Group = "Vehicle", !!!mdls_naive_vehicle),
  tibble(Group = "1.5", !!!mdls_dose_1_15)
) %>%
  pivot_longer(
    -Group,
    names_to = "PFAS",
    values_to = "MDL"
  )

pfas_cols <- mdls_df$PFAS %>% unique()
data_conc[pfas_cols] <- lapply(data_conc[pfas_cols], as.character)

for (pfas_name in unique(mdls_df$PFAS)) {
  if (pfas_name %in% colnames(data_conc)) {
    for (dose_level in unique(mdls_df$Group)) {
      mdl_val <- mdls_df %>%
        filter(PFAS == pfas_name, Group == dose_level) %>%
        pull(MDL)

      if (length(mdl_val) == 1 && !is.na(mdl_val)) {
        dose_match <- trimws(gsub("^.*\\s", "", data_conc$Group))
        idx <- which(dose_match == dose_level & data_conc[[pfas_name]] == "<MDL")

        if (length(idx) > 0) {
          data_conc[idx, pfas_name] <- mdl_val / 2
        }
      }
    }
  }
}


pfas_cols <- unique(mdls_df$PFAS)
data_conc[pfas_cols] <- lapply(data_conc[pfas_cols], as.numeric)

data_conc[data_conc$Group %in% c("Naive", "Vehicle"), pfas_cols] <-
  data_conc[data_conc$Group %in% c("Naive", "Vehicle"), pfas_cols] / 1000
pfas_cols <- unique(mdls_df$PFAS)

data_conc_subset <- data_conc %>%
  dplyr::select(Mouse.ID, Sex, Group, all_of(pfas_cols))

#write.csv(data_conc, file = "../invivo-pfas-immunotox/R input 28d/Liver_PFAS_values_fixed_28d.csv", row.names = FALSE)

other_pfas <- setdiff(pfas_cols, c("PFOS", "PFOA"))
plasma_colors <- viridis(length(other_pfas), option = "plasma")
names(plasma_colors) <- other_pfas

custom_colors <- c(
  "PFOS" = "red",    
  "PFOA" = "blue",  
  plasma_colors          
)

group_levels <- c(
  "Naive", "Vehicle",
  paste("PFOS", c( "1.5")),
  paste("PFOA", c("1.5"))
)

data_combined_long <- data_conc %>%
  pivot_longer(
    cols = all_of(pfas_cols),
    names_to = "PFAS_name",
    values_to = "PFAS_conc"
  ) %>%
  filter(!is.na(PFAS_conc)) %>%
  mutate(
    PFAS_conc = as.numeric(PFAS_conc),
    group = factor(Group, levels = group_levels),
    PFAS_name = factor(PFAS_name, levels = names(custom_colors)) 
  )

# Plot
p <-ggplot(data_combined_long, aes(x = group, y = PFAS_conc, color =  PFAS_name, shape= Sex)) +
    geom_jitter(alpha = 0.7, size = 2.2, width = 0.2, height = 0) +
  scale_color_manual(values = custom_colors) +
  labs(
    x = "Group",
    y = "Liver PFAS concentration (mg/kg)",
    color = "PFAS"
  ) +
   coord_cartesian(ylim = c(0, 300)) +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "non"
  )
print(p)
ggsave(filename = "../invivo-pfas-immunotox/R input 28d/plots/plasma_conc.png", plot = p, width = 5, height = 5, dpi = 300,bg = "white")
replicate_summary <- data_conc%>%
  group_by(Group) %>% 
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```
#Body weight
```{r}
data_bw <- read.csv("../invivo-pfas-immunotox/R input 28d/Body weight 28d.csv")

data_bw <- data_bw %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"), paste("control", group), group)) %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

data_bw$Dose <- factor(data_bw$Dose, levels = c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5"))

controls <- data_bw %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_bw <- data_bw %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls) %>%
  filter(PFAS %in% c("PFOS", "PFOA")) %>%
  mutate(across(matches("^Baseline$|^Week[0-9]+$"), as.numeric))

data_bw <- data_bw %>%
  pivot_longer(cols = -c(Sample., Sex, group, PFAS, Dose),
               names_to = "Marker", values_to = "Value") %>%
  filter(!is.na(Value)) %>%
  mutate(Value = as.numeric(Value),
         Marker = factor(Marker, levels = c("Baseline", paste0("Week", 1:8))))

data_bw <- data_bw %>%
  group_by(Sample.) %>%
  mutate(Change_from_baseline = Value - Value[Marker == "Baseline"]) %>%
  ungroup()

data_bw <- data_bw %>%
  mutate(DoseSex = case_when(
    Sex == "Male" & Dose == "Vehicle" ~ "Vehicle",
    Sex == "Male" & Dose %in% c("0.166", "0.5", "1", "1.5") ~ "HighM",
    Sex == "Female" & Dose == "Vehicle" ~ "Vehicle",
    Sex == "Female" & Dose %in% c("0.166", "0.5", "1", "1.5") ~ "HighF",
    TRUE ~ as.character(Dose)
  ))

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      subset_data <- data %>% filter(PFAS == chem, Marker == marker)
      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
      pairwise_results <- dunn_result$res %>%
        filter(str_detect(Comparison, "Vehicle")) %>%
        mutate(
          group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
          group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
          significance = case_when(
            P.adj < 0.001 ~ "***",
            P.adj < 0.01 ~ "**",
            P.adj < 0.05 ~ "*",
            TRUE ~ "ns"
          ),
          PFAS = chem,
          Marker = marker,
          Sex = sex_label
        )
      if (nrow(pairwise_results) > 0) {
        max_y <- max(subset_data$Value, na.rm = TRUE)
        pairwise_results <- pairwise_results %>%
          mutate(y.position = max_y + (row_number() - 1) * 2 + 20)
        results[[paste(sex_label, chem, marker, sep = "_")]] <- pairwise_results
      }
    }
  }
  bind_rows(results)
}

data_female <- data_bw %>% filter(Sex == "Female")
data_male <- data_bw %>% filter(Sex == "Male")

sig_female_pfos <- get_significance_non_parametric(data_female %>% filter(PFAS == "PFOS"), "Female")
sig_female_pfoa <- get_significance_non_parametric(data_female %>% filter(PFAS == "PFOA"), "Female")
sig_male_pfos   <- get_significance_non_parametric(data_male %>% filter(PFAS == "PFOS"), "Male")
sig_male_pfoa   <- get_significance_non_parametric(data_male %>% filter(PFAS == "PFOA"), "Male")

significance_df_non_parametric <- bind_rows(
  sig_female_pfos, sig_female_pfoa, sig_male_pfos, sig_male_pfoa
)
print(significance_df_non_parametric)
#Summary 
summary_stats <- data_bw %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(
    median = median(Change_from_baseline, na.rm = TRUE),
    Q1 = quantile(Change_from_baseline, 0.25, na.rm = TRUE),
    Q3 = quantile(Change_from_baseline, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    DoseSex = paste0(Dose, "_", substr(Sex, 1, 1)),
    lower = Q1,
    upper = Q3
  )

female_colors <- c(
  "Naive"   = "#fee2e2",
"Vehicle" = "black",
"0.166"   = "#fecaca",
"0.5"     = "#fca5a5",
"1"       = "#f87171",
"1.5"     = "#e53e3e"
)

male_colors <- c(
  "Naive"   = "#eff6ff",
"Vehicle" = "black",
"0.166"   = "#bfdbfe",
"0.5"     = "#93c5fd",
"1"       = "#60a5fa",
"1.5"     = "#3b82f6"
)

dose_levels <- names(female_colors)

dose_sex_colors <- c(
  setNames(female_colors, paste0(dose_levels, "_F")),
  setNames(male_colors, paste0(dose_levels, "_M"))
)

p <- ggplot(summary_stats, aes(x = Marker, y = median, group = DoseSex, color = DoseSex)) +
  geom_line(size = 1, linetype = "solid") + 
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  facet_wrap(Sex ~ PFAS, scales = "free_y") +
  scale_color_manual(values = dose_sex_colors) +
  labs(
    title = "Median Body Weight Change Over Time (± IQR)",
    x = "Week",
    y = "Δ Body Weight (g)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(p)
ggsave(filename = "../invivo-pfas-immunotox/R input 28d/plots/body_weight.png", plot = p, width = 7, height = 5, dpi = 300, bg = "white")
replicate_summary <- data_bw%>%
  group_by(Dose, PFAS, Sex, Marker) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```

#Water consumption
```{r}
data_water <- read.csv("../invivo-pfas-immunotox/R input 28d/water 28d.csv")

data_water <- data_water %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"), paste("control", group), group)) %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

data_water$Dose <- factor(data_water$Dose, levels = c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5"))

controls <- data_water %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_water <- data_water %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls) %>%
  filter(PFAS %in% c("PFOS", "PFOA")) %>%
  mutate(across(matches("^Baseline$|^Week[0-9]+$"), as.numeric))

data_water <- data_water %>%
  pivot_longer(cols = -c(Sample., Sex, group, PFAS, Dose),
               names_to = "Marker", values_to = "Value") %>%
  filter(!is.na(Value)) %>%
  mutate(Value = as.numeric(Value),
         Marker = factor(Marker, levels = c("Baseline", paste0("Week", 1:8))))

data_water <- data_water %>%
  group_by(Sample.) %>%
  mutate(Change_from_baseline = Value - Value[Marker == "Baseline"]) %>%
  ungroup()

data_water <- data_water %>%
  mutate(DoseSex = case_when(
    Sex == "Male" & Dose == "Vehicle" ~ "Vehicle",
    Sex == "Male" & Dose %in% c("0.166", "0.5", "1", "1.5") ~ "HighM",
    Sex == "Female" & Dose == "Vehicle" ~ "Vehicle",
    Sex == "Female" & Dose %in% c("0.166", "0.5", "1", "1.5") ~ "HighF",
    TRUE ~ as.character(Dose)
  ))

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      subset_data <- data %>% filter(PFAS == chem, Marker == marker)
      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
      pairwise_results <- dunn_result$res %>%
        filter(str_detect(Comparison, "Vehicle")) %>%
        mutate(
          group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
          group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
          significance = case_when(
            P.adj < 0.001 ~ "***",
            P.adj < 0.01 ~ "**",
            P.adj < 0.05 ~ "*",
            TRUE ~ "ns"
          ),
          PFAS = chem,
          Marker = marker,
          Sex = sex_label
        )
      if (nrow(pairwise_results) > 0) {
        max_y <- max(subset_data$Value, na.rm = TRUE)
        pairwise_results <- pairwise_results %>%
          mutate(y.position = max_y + (row_number() - 1) * 2 + 20)
        results[[paste(sex_label, chem, marker, sep = "_")]] <- pairwise_results
      }
    }
  }
  bind_rows(results)
}

data_female <- data_water %>% filter(Sex == "Female")
data_male <- data_water %>% filter(Sex == "Male")

sig_female_pfos <- get_significance_non_parametric(data_female %>% filter(PFAS == "PFOS"), "Female")
sig_female_pfoa <- get_significance_non_parametric(data_female %>% filter(PFAS == "PFOA"), "Female")
sig_male_pfos   <- get_significance_non_parametric(data_male %>% filter(PFAS == "PFOS"), "Male")
sig_male_pfoa   <- get_significance_non_parametric(data_male %>% filter(PFAS == "PFOA"), "Male")

significance_df_non_parametric <- bind_rows(
  sig_female_pfos, sig_female_pfoa, sig_male_pfos, sig_male_pfoa
)
print(significance_df_non_parametric)

summary_stats <- data_water %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(
    median = median(Change_from_baseline, na.rm = TRUE),
    Q1 = quantile(Change_from_baseline, 0.25, na.rm = TRUE),
    Q3 = quantile(Change_from_baseline, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    DoseSex = paste0(Dose, "_", substr(Sex, 1, 1)),
    lower = Q1,
    upper = Q3
  )

female_colors <- c(
  "Naive"   = "#fee2e2",
"Vehicle" = "black",
"1.5"     = "#e53e3e"
)

male_colors <- c(
  "Naive"   = "#eff6ff",
"Vehicle" = "black",
"1.5"     = "#3b82f6"
)


dose_levels <- names(female_colors)

dose_sex_colors <- c(
  setNames(female_colors, paste0(dose_levels, "_F")),
  setNames(male_colors, paste0(dose_levels, "_M"))
)

p <- ggplot(summary_stats, aes(x = Marker, y = median, group = DoseSex, color = DoseSex)) +
  geom_line(size = 1, linetype = "solid") +  # solid lines for all
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  facet_wrap(Sex ~ PFAS, scales = "free_y") +
  scale_color_manual(values = dose_sex_colors) +
  labs(
    title = "Median Body Weight Change Over Time (± IQR)",
    x = "Week",
    y = "Δ Body Weight (g)"
  ) +
  coord_cartesian(ylim = c(-20, 30)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(p)
ggsave(filename = "../invivo-pfas-immunotox/R input 28d/plots/water_consumption.png", plot = p, width = 7, height = 5, dpi = 300, bg = "white")

replicate_summary <- data_water %>%
  filter(Sex == "Female") %>%  # <-- only keep females
  group_by(group, Marker, PFAS) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d FEMALE mice/group\n", min_n, max_n))

replicate_summary <- data_water %>%
  filter(Sex == "Male") %>%  # <-- only keep females
  group_by(group, Marker, PFAS) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d male mice/group\n", min_n, max_n))

```
