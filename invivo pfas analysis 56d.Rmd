
#Load libraries
```{r}
library(readxl)
library(forcats) 
library(tidyr)  
library(dplyr)  
library(ggsignif)
library(ggplot2)
library(broom) 
library(rstatix)
library(ggpubr)
library(stringr)
library(viridis)
library(emmeans)
library(purrr)
library(car)
library(extrafont)
library(plotrix)
library(FSA) 
library(ggpubr) 
library(drc)
library(eulerr)
```
#Immune
##Spleen stats and plot
```{r}
data_spleen <- read.csv("../invivo-pfas-immunotox/R input 56d/Flow Results Spleen.csv")
data_spleen <- data_spleen[ , !(names(data_spleen) %in% c("B220..F4.80.","B220.macs","CD4.CD25.CD69.ve","CD4.CD69","CD4.DP","CD4.DCs","CD8.CD69","CD8dcs"))]

data_spleen <- data_spleen %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_spleen <- data_spleen %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

controls <- data_spleen %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_spleen <- data_spleen %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_spleen <- data_spleen %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose),
    names_to = "Marker",
    values_to = "Value"
  )

data_spleen <- data_spleen %>% filter(!is.na(Value))

data_spleen$Value <- as.numeric(data_spleen$Value)

data_female <- data_spleen %>% filter(Sex == "Female")

data_male <- data_spleen %>% filter(Sex == "Male")

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)
if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {
        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              P.adj >= 0.05 & P.adj < 0.099 ~ ".",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")

significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)
unique_markers <- unique(data_spleen$Marker)
##########################################################################################################################
#Normalize 
data_spleen <- data_spleen %>%
  group_by(Sex, PFAS, Marker) %>%
  mutate(vehicle_median = median(Value[Dose == "Vehicle"], na.rm = TRUE),
         normalized = Value / vehicle_median,
         percent_of_vehicle = (Value / vehicle_median) * 100) %>%
  ungroup()
data_female <- data_spleen %>% filter(Sex == "Female")
data_male <- data_spleen %>% filter(Sex == "Male")

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      kw_test <- kruskal.test(normalized ~ Dose, data = subset_data)

      if (kw_test$p.value < 0.05) {
        dunn_result <- dunnTest(normalized ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              P.adj >= 0.05 & P.adj < 0.099 ~ ".",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$normalized, na.rm = TRUE)
          increment <- max_y * 0.1
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + 10)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")

significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)
##########################################################################################################################
#Heatmap
sig_for_heatmap <- significance_df_non_parametric %>%
  mutate(
    Dose = str_remove(group1, ".* "), 
    Dose = ifelse(group1 %in% c("Naive", "Vehicle"), group1, Dose),
    Marker = as.character(Marker) 
  ) %>%
  dplyr::select(Sex, PFAS, Marker, Dose, significance)
heatmap_data <- data_spleen %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(median_norm = median(normalized, na.rm = TRUE), .groups = "drop")
heatmap_with_sig <- heatmap_data %>%
  left_join(sig_for_heatmap, by = c("Sex", "PFAS", "Marker", "Dose"))

heatmap_with_sig$Marker <- factor(heatmap_with_sig$Marker, levels = c("T.cells","CD4.T.cells","CD8", "B.Cells","DCs","NK"))
heatmap_with_sig$Dose <- factor(heatmap_with_sig$Dose, levels = c( "1.5", "1", "0.5", "0.166","Vehicle", "Naive"))
colnames(data_spleen)
                                  
heatmap_spleen <- ggplot(heatmap_with_sig, aes(x = Marker, y = Dose, fill = median_norm)) +
  geom_tile(color = "black", size = 0.4) +
  geom_text(aes(label = round(median_norm, 2)), size = 2.5, color = "black") +
  geom_text(aes(label = significance), vjust = 0.4, size = 6, color = "black", fontface = "bold") +
  scale_fill_gradient2(
    low = "#330597", mid = "white", high = "red", midpoint = 1,
    name = "Normalized\nMedian", limits = c(0, 1.5),  oob = scales::squish 
  ) +
  facet_grid(Sex ~ PFAS) +
scale_x_discrete(position = "top") + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
  text = element_text(size = 12, family = "Arial"),
  axis.text.x = element_text(angle = 45, hjust = 0, size = 12),
  axis.text.y = element_text(size = 12),
  panel.grid = element_blank(),
 strip.text = element_text(face = "bold", size = 12)
)+ coord_fixed(ratio = 1)

n_markers <- length(unique(heatmap_with_sig$Marker))
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
n_doses <- length(dose_levels)
tile_width_in <- 1
tile_height_in <- 1
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in 


ggsave(
  filename = "../invivo-pfas-immunotox/R input 56d/plots/spleen_heatmap.png",
  plot = heatmap_spleen,
  width = plot_width,
  height = plot_height,
  dpi = 300,
  bg = "white",limitsize = FALSE
)
print(heatmap_spleen)
##########################################################################################################################
#Dose-response curve

custom_colors <- c("#0d0887", "#7e03a8", "#b52f8c", "#de5f65","#ed7953", "#f89540", "#fdb42f"
)

pfas_order <- c("PFOS", "PFOA")
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
marker_levels <- c("T.cells","CD4.T.cells","CD8", "B.Cells","DCs","NK")

data_spleen$PFAS <- factor(data_spleen$PFAS, levels = pfas_order)
data_spleen$Dose <- factor(data_spleen$Dose, levels = dose_levels)
data_spleen$Marker <- factor(data_spleen$Marker, levels = marker_levels)

n_markers <- length(unique(heatmap_with_sig$Marker))
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
n_doses <- length(dose_levels)
tile_width_in <- 2.5
tile_height_in <- 2.5
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in * n_sex * n_pfas


summary_data <- data_spleen %>%
  group_by(Sex, PFAS, Marker, Dose) %>%
  summarise(
    median_stat = median(Value, na.rm = TRUE),
    Q1 = quantile(Value, 0.25, na.rm = TRUE),
    Q3 = quantile(Value, 0.75, na.rm = TRUE),
    IQR = Q3 - Q1,
    lower = median_stat - 1.5 * IQR,
    upper = median_stat + 1.5 * IQR,
    .groups = "drop"
  ) %>%
  mutate(
    y_position_label = upper + 1,
    Marker = factor(Marker, levels = marker_levels),
    Dose_factor = factor(Dose, levels = dose_levels)
  )

summary_data <- summary_data %>%
  left_join(
    significance_df_non_parametric %>%
      dplyr::select(PFAS, Marker, group1, significance) %>%
      dplyr::rename(Dose = group1),
    by = c("PFAS", "Marker", "Dose")
  )
vehicle_medians <- data_spleen %>%
  filter(Dose == "Vehicle") %>%
  group_by(Sex, PFAS, Marker) %>%
  summarise(vehicle_median = median(Value, na.rm = TRUE), .groups = "drop")
summary_data <- summary_data %>%
  left_join(vehicle_medians, by = c("Sex", "PFAS", "Marker"))

summary_data$Marker <- factor(summary_data$Marker, levels = marker_levels)

custom_colors_named <- c(
  "Naive"   = "#330597",
  "Vehicle" = "#8405a7",
  "0.166"   = "#b12a90",
  "0.5"     = "#d35171",
  "1"       = "#f68f44",
  "1.5"     = "#fec029"
)

sex_colors <- c("Male" = "#1f77b4", "Female" = "#e377c2")

plot <- ggplot(data_spleen, aes(x = interaction(Dose, Sex), y = Value)) +
  geom_jitter(
    aes(color = Dose),
    size = 1, alpha = 0.4, width = 0.2
  ) +
  geom_boxplot(
    aes(group = interaction(Dose, Sex, Marker), fill = Dose),
    outlier.shape = NA, alpha = 0.3, color = "black", width = 0.6,
    position = position_dodge(width = 0.75)
  ) +
  geom_hline(
    data = summary_data,
    aes(yintercept = vehicle_median, color = Sex, group = interaction(Sex, Marker)),
    linetype = "dotted", size = 0.8, alpha = 0.7,
    inherit.aes = FALSE
  ) +
  facet_wrap(PFAS ~ Marker, scales = "free_y", nrow = 2) +
  scale_color_manual(
    name = "Color",
    values = c(custom_colors_named, sex_colors)
  ) +
  scale_fill_manual(
    name = "Dose",
    values = custom_colors_named
  ) +
  labs(
    title = "Normalized Response by Dose and Sex",
    x = "Dose and Sex",
    y = "Value"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )

print(plot)
ggsave(filename = "../invivo-pfas-immunotox/R input 56d/plots/spleen_dr.png", plot = plot,
  width = plot_width,
  height = 7,
  dpi = 300,
  bg = "white")

replicate_summary <- data_spleen%>%
  group_by(Sex, Dose, PFAS, Marker) %>%  
  summarise(n = n(), .groups = "drop")

min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)

cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```

##Blood stats and plot
```{r}
data_blood <- read.csv("../invivo-pfas-immunotox/R input 56d/Blood_flow.csv")
data_blood <- data_blood[ , !(names(data_blood) %in% c("CD25..CD4", "DN.T.Cells", "DN.DP", "DN.CD3"))]

data_blood <- data_blood %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_blood <- data_blood %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

controls <- data_blood %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_blood <- data_blood %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_blood <- data_blood %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose, Organ, Phase),
    names_to = "Marker",
    values_to = "Value"
  )


data_blood <- data_blood %>% filter(!is.na(Value))

data_blood$Value <- as.numeric(data_blood$Value)
data_female <- data_blood %>% filter(Sex == "Female")
data_male <- data_blood %>% filter(Sex == "Male")

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              P.adj >= 0.05 & P.adj < 0.099 ~ ".",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}


sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")

significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)

##########################################################################################################################
#Normalize 
data_blood <- data_blood %>%
  group_by(Sex, PFAS, Marker) %>%
  mutate(vehicle_median = median(Value[Dose == "Vehicle"], na.rm = TRUE),
         normalized = Value / vehicle_median,
         percent_of_vehicle = (Value / vehicle_median) * 100) %>%
  ungroup()
data_female <- data_blood %>% filter(Sex == "Female")
data_male <- data_blood %>% filter(Sex == "Male")

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      kw_test <- kruskal.test(normalized ~ Dose, data = subset_data)

      if (kw_test$p.value < 0.05) {
        dunn_result <- dunnTest(normalized ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              P.adj >= 0.05 & P.adj < 0.099 ~ ".",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$normalized, na.rm = TRUE)
          increment <- max_y * 0.1
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + 10)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")

significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)

##########################################################################################################################
#Heatmap
sig_for_heatmap <- significance_df_non_parametric %>%
  mutate(
    Dose = str_remove(group1, ".* "), 
    Dose = ifelse(group1 %in% c("Naive", "Vehicle"), group1, Dose),
    Marker = as.character(Marker)  
  ) %>%
  dplyr::select(Sex, PFAS, Marker, Dose, significance)
heatmap_data <- data_blood %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(median_norm = median(normalized, na.rm = TRUE), .groups = "drop")
heatmap_with_sig <- heatmap_data %>%
  left_join(sig_for_heatmap, by = c("Sex", "PFAS", "Marker", "Dose"))

heatmap_with_sig$Marker <- factor(heatmap_with_sig$Marker, levels = c("T.Cells","CD4","CD8","B.Cells","Monocytes"))
heatmap_with_sig$Dose <- factor(heatmap_with_sig$Dose, levels = c( "1.5", "1", "0.5", "0.166","Vehicle", "Naive"))
               
heatmap_blood <- ggplot(heatmap_with_sig, aes(x = Marker, y = Dose, fill = median_norm)) +
  geom_tile(color = "black", size = 0.4) +
  geom_text(aes(label = round(median_norm, 2)), size = 2, color = "black") +
  geom_text(aes(label = significance), vjust = 0.4, size = 6, color = "black", fontface = "bold") +
  scale_fill_gradient2(
    low = "#330597", mid = "white", high = "red", midpoint = 1,
    name = "Normalized\nMedian", limits = c(0, 1.5),  oob = scales::squish 
  ) +
  facet_grid(Sex ~ PFAS) +
scale_x_discrete(position = "top") + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
  text = element_text(size = 12, family = "Arial"),
  axis.text.x = element_text(angle = 45, hjust = 0, size = 12),
  axis.text.y = element_text(size = 12),
  panel.grid = element_blank(),
  strip.text = element_text(face = "bold", size = 12)
)+ coord_fixed(ratio = 1)


n_markers <- length(unique(heatmap_with_sig$Marker))
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
n_doses <- length(dose_levels)
tile_width_in <- 1
tile_height_in <- 1
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in 


ggsave(
  filename = "../invivo-pfas-immunotox/R input 56d/plots/blood_heatmap.png",
  plot = heatmap_blood,
  width = plot_width,
  height = plot_height,
  dpi = 300,
  bg = "white",limitsize = FALSE
)

print(heatmap_blood)
##########################################################################################################################
#Dose-response curve

custom_colors <- c("#0d0887","#6101a6","#bc2981","#f16b37","#fcdf27")

pfas_order <- c("PFOS", "PFOA")
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
marker_levels <- c("T.Cells","CD4","CD8","B.Cells","Monocytes")

data_blood$PFAS <- factor(data_blood$PFAS, levels = pfas_order)
data_blood$Dose <- factor(data_blood$Dose, levels = dose_levels)
data_blood$Marker <- factor(data_blood$Marker, levels = marker_levels)

n_markers <- length(unique(heatmap_with_sig$Marker))
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
n_doses <- length(dose_levels)
tile_width_in <- 2.5
tile_height_in <- 2.5
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in * n_sex * n_pfas

summary_data <- data_blood %>%
  group_by(Sex, PFAS, Marker, Dose) %>%
  summarise(
    median_stat = median(Value, na.rm = TRUE),
    Q1 = quantile(Value, 0.25, na.rm = TRUE),
    Q3 = quantile(Value, 0.75, na.rm = TRUE),
    IQR = Q3 - Q1,
    lower = median_stat - 1.5 * IQR,
    upper = median_stat + 1.5 * IQR,
    .groups = "drop"
  ) %>%
  mutate(
    y_position_label = upper + 1,
    Marker = factor(Marker, levels = marker_levels),
    Dose_factor = factor(Dose, levels = dose_levels)
  )

summary_data <- summary_data %>%
  left_join(
    significance_df_non_parametric %>%
      dplyr::select(PFAS, Marker, group1, significance) %>%
      dplyr::rename(Dose = group1),
    by = c("PFAS", "Marker", "Dose")
  )
vehicle_medians <- data_blood %>%
  filter(Dose == "Vehicle") %>%
  group_by(Sex, PFAS, Marker) %>%
  summarise(vehicle_median = median(Value, na.rm = TRUE), .groups = "drop")
summary_data <- summary_data %>%
  left_join(vehicle_medians, by = c("Sex", "PFAS", "Marker"))

summary_data$Marker <- factor(summary_data$Marker, levels = marker_levels)

custom_colors_named <- c(
  "Naive"   = "#330597",
  "Vehicle" = "#8405a7",
  "0.166"   = "#b12a90",
  "0.5"     = "#d35171",
  "1"       = "#f68f44",
  "1.5"     = "#fec029"
)

sex_colors <- c("Male" = "#1f77b4", "Female" = "#e377c2")

plot <- ggplot(data_blood, aes(x = interaction(Dose, Sex), y = Value)) +
  geom_jitter(
    aes(color = Dose),
    size = 1, alpha = 0.4, width = 0.2
  ) +
  geom_boxplot(
    aes(group = interaction(Dose, Sex, Marker), fill = Dose),
    outlier.shape = NA, alpha = 0.3, color = "black", width = 0.6,
    position = position_dodge(width = 0.75)
  ) +
  geom_hline(
    data = summary_data,
    aes(yintercept = vehicle_median, color = Sex, group = interaction(Sex, Marker)),
    linetype = "dotted", size = 0.8, alpha = 0.7,
    inherit.aes = FALSE
  ) +
  facet_wrap(PFAS ~ Marker, scales = "free_y", nrow = 2) +
  scale_color_manual(
    name = "Color",
    values = c(custom_colors_named, sex_colors)
  ) +
  scale_fill_manual(
    name = "Dose",
    values = custom_colors_named
  ) +
  labs(
    title = "Normalized Response by Dose and Sex",
    x = "Dose and Sex",
    y = "Value"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )

print(plot)
ggsave(filename = "../invivo-pfas-immunotox/R input 56d/plots/blood_dr.png", plot = plot,
  width = plot_width,
  height = 7,
  dpi = 300,
  bg = "white")
replicate_summary <- data_blood%>%
  group_by(Sex, Dose, PFAS, Marker) %>%   
  summarise(n = n(), .groups = "drop")


min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```

##Thymus stats and plot
```{r}
data_thymus <- read.csv("../invivo-pfas-immunotox/R input 56d/Thymus_flow.csv")
data_thymus <- data_thymus[ , !(names(data_thymus) %in% c("Macrophages", "B.Cells", "Dendritic.Cells", "CD3.CD69.", "CD3.CD69..3", "DP.CD69"))]

data_thymus <- data_thymus %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_thymus <- data_thymus %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

controls <- data_thymus %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_thymus <- data_thymus %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_thymus <- data_thymus %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose),
    names_to = "Marker",
    values_to = "Value"
  )

data_thymus <- data_thymus %>% filter(!is.na(Value))

data_thymus$Value <- as.numeric(data_thymus$Value)
data_female <- data_thymus %>% filter(Sex == "Female")
data_male <- data_thymus %>% filter(Sex == "Male")

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      
      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

       
        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              P.adj >= 0.05 & P.adj < 0.099 ~ ".",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")

significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)
##########################################################################################################################
#Normalize 
data_thymus <- data_thymus %>%
  group_by(Sex, PFAS, Marker) %>%
  mutate(vehicle_median = median(Value[Dose == "Vehicle"], na.rm = TRUE),
         normalized = Value / vehicle_median,
         percent_of_vehicle = (Value / vehicle_median) * 100) %>%
  ungroup()
data_female <- data_thymus %>% filter(Sex == "Female")
data_male <- data_thymus %>% filter(Sex == "Male")

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next


      kw_test <- kruskal.test(normalized ~ Dose, data = subset_data)

      if (kw_test$p.value < 0.05) {

        dunn_result <- dunnTest(normalized ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              P.adj >= 0.05 & P.adj < 0.099 ~ ".",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$normalized, na.rm = TRUE)
          increment <- max_y * 0.1
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + 10)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")

significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)
##########################################################################################################################
#Heatmap
sig_for_heatmap <- significance_df_non_parametric %>%
  mutate(
    Dose = str_remove(group1, ".* "), 
    Dose = ifelse(group1 %in% c("Naive", "Vehicle"), group1, Dose),
    Marker = as.character(Marker) 
  ) %>%
  dplyr::select(Sex, PFAS, Marker, Dose, significance)
heatmap_data <- data_thymus %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(median_norm = median(normalized, na.rm = TRUE), .groups = "drop")
heatmap_with_sig <- heatmap_data %>%
  left_join(sig_for_heatmap, by = c("Sex", "PFAS", "Marker", "Dose"))

heatmap_with_sig$Marker <- factor(heatmap_with_sig$Marker, levels = c("DN", "DN.CD25", "DN.DN", "DP","CD3.CD69..2", "CD3.CD69..1", "CD3.", "CD69.", "SP4", "SP4.CD69", "SP8", "SP8.CD69"))
heatmap_with_sig$Dose <- factor(heatmap_with_sig$Dose, levels = c( "1.5", "1", "0.5", "0.166","Vehicle", "Naive"))

heatmap_thymus <- ggplot(heatmap_with_sig, aes(x = Marker, y = Dose, fill = median_norm)) +
  geom_tile(color = "black", size = 0.4) +
  geom_text(aes(label = round(median_norm, 2)), size = 2.5, color = "black") +
  geom_text(aes(label = significance), vjust = 0.4, size = 6, color = "black", fontface = "bold") +
  scale_fill_gradient2(
    low = "#330597", mid = "white", high = "red", midpoint = 1,
    name = "Normalized\nMedian", limits = c(0, 2),  oob = scales::squish 
  ) +
  facet_grid(Sex ~ PFAS) +
scale_x_discrete(position = "top") + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
  text = element_text(size = 12, family = "Arial"),
  axis.text.x = element_text(angle = 45, hjust = 0, size = 12),
  axis.text.y = element_text(size = 12),
  panel.grid = element_blank(),
strip.text = element_text(face = "bold", size = 12)
)+ coord_fixed(ratio = 1)

n_markers <- length(unique(heatmap_with_sig$Marker))
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
n_doses <- length(dose_levels)
tile_width_in <- 1
tile_height_in <- 1
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in 

ggsave(
  filename = "../invivo-pfas-immunotox/R input 56d/plots/thymus_heatmap.png",
  plot = heatmap_thymus,
  width = plot_width,
  height = plot_height,
  dpi = 300,
  bg = "white"
)
print(heatmap_thymus)
##########################################################################################################################

#Dose-response curve
pfas_order <- c("PFOS", "PFOA")
marker_levels <- c("DN", "DN.CD25", "DN.DN", "DP","CD3.CD69.","CD3.CD69..2", "CD3.CD69..1", "CD3.", "CD69.", "SP4", "SP4.CD69", "SP8", "SP8.CD69", "Macrophages", "Dendritic.Cells", "B.Cells")

data_thymus$PFAS <- factor(data_thymus$PFAS, levels = pfas_order)
data_thymus$Dose <- factor(data_thymus$Dose, levels = dose_levels)
data_thymus$Marker <- factor(data_thymus$Marker, levels = marker_levels)

n_markers <- length(unique(heatmap_with_sig$Marker))/2
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
n_doses <- length(dose_levels)
tile_width_in <- 2.5
tile_height_in <- 2.5
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in * n_sex * n_pfas


summary_data <- data_thymus %>%
  group_by(Sex, PFAS, Marker, Dose) %>%
  summarise(
    median_stat = median(Value, na.rm = TRUE),
    Q1 = quantile(Value, 0.25, na.rm = TRUE),
    Q3 = quantile(Value, 0.75, na.rm = TRUE),
    IQR = Q3 - Q1,
    lower = median_stat - 1.5 * IQR,
    upper = median_stat + 1.5 * IQR,
    .groups = "drop"
  ) %>%
  mutate(
    y_position_label = upper + 1,
    Marker = factor(Marker, levels = marker_levels),
    Dose_factor = factor(Dose, levels = dose_levels)
  )

summary_data <- summary_data %>%
  left_join(
    significance_df_non_parametric %>%
      dplyr::select(PFAS, Marker, group1, significance) %>%
      dplyr::rename(Dose = group1),
    by = c("PFAS", "Marker", "Dose")
  )
vehicle_medians <- data_thymus %>%
  filter(Dose == "Vehicle") %>%
  group_by(Sex, PFAS, Marker) %>%
  summarise(vehicle_median = median(Value, na.rm = TRUE), .groups = "drop")
summary_data <- summary_data %>%
  left_join(vehicle_medians, by = c("Sex", "PFAS", "Marker"))

summary_data$Marker <- factor(summary_data$Marker, levels = marker_levels)

custom_colors_named <- c(
  "Naive"   = "#330597",
  "Vehicle" = "#8405a7",
  "0.166"   = "#b12a90",
  "0.5"     = "#d35171",
  "1"       = "#f68f44",
  "1.5"     = "#fec029"
)

sex_colors <- c("Male" = "#1f77b4", "Female" = "#e377c2")

plot <- ggplot(data_thymus, aes(x = interaction(Dose, Sex), y = Value)) +
  geom_jitter(
    aes(color = Dose),
    size = 1, alpha = 0.4, width = 0.2
  ) +
  geom_boxplot(
    aes(group = interaction(Dose, Sex, Marker), fill = Dose),
    outlier.shape = NA, alpha = 0.3, color = "black", width = 0.6,
    position = position_dodge(width = 0.75)
  ) +
  geom_hline(
    data = summary_data,
    aes(yintercept = vehicle_median, color = Sex, group = interaction(Sex, Marker)),
    linetype = "dotted", size = 0.8, alpha = 0.7,
    inherit.aes = FALSE
  ) +
  facet_wrap(PFAS ~ Marker, scales = "free_y", nrow = 4) +
  scale_color_manual(
    name = "Color",
    values = c(custom_colors_named, sex_colors)
  ) +
  scale_fill_manual(
    name = "Dose",
    values = custom_colors_named
  ) +
  labs(
    title = "Normalized Response by Dose and Sex",
    x = "Dose and Sex",
    y = "Value"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank())

print(plot)
ggsave(filename = "../invivo-pfas-immunotox/R input 56d/plots/thymus.png", plot = plot,
  width = plot_width,
  height = 14,
  dpi = 300,
  bg = "white")
replicate_summary <- data_thymus%>%
  group_by(Sex, Dose, PFAS, Marker) %>%  
  summarise(n = n(), .groups = "drop")

min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)

cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```

##Cytokine stats and plot
```{r}
data_cyto <- read.csv("../invivo-pfas-immunotox/R input 56d/Cytokine.csv")
data_cyto <- data_cyto[, !(names(data_cyto) %in% c("GM.CSF", "IL.9", "MIP.1b", "IL.6"))]

data_cyto <- data_cyto %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_cyto <- data_cyto %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

controls <- data_cyto %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_cyto <- data_cyto %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_cyto <- data_cyto %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose),
    names_to = "Marker",
    values_to = "Value"
  )

data_cyto <- data_cyto %>% filter(!is.na(Value))

data_cyto$Value <- as.numeric(data_cyto$Value)
data_female <- data_cyto %>% filter(Sex == "Female")
data_male <- data_cyto %>% filter(Sex == "Male")

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              P.adj >= 0.05 & P.adj < 0.099 ~ ".",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}


sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")

significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)
##########################################################################################################################
#Normalize 
data_cyto <- data_cyto %>%
  group_by(Sex, PFAS, Marker) %>%
  mutate(vehicle_median = median(Value[Dose == "Vehicle"], na.rm = TRUE),
         normalized = Value / vehicle_median,
         percent_of_vehicle = (Value / vehicle_median) * 100) %>%
  ungroup()
data_female <- data_cyto %>% filter(Sex == "Female")
data_male <- data_cyto %>% filter(Sex == "Male")

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      kw_test <- kruskal.test(normalized ~ Dose, data = subset_data)

      if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {
        dunn_result <- dunnTest(normalized ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              P.adj >= 0.05 & P.adj < 0.099 ~ ".",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$normalized, na.rm = TRUE)
          increment <- max_y * 0.1
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + 10)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")

significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)

##########################################################################################################################
#Heatmap
sig_for_heatmap <- significance_df_non_parametric %>%
  mutate(
    Dose = str_remove(group1, ".* "),  
    Dose = ifelse(group1 %in% c("Naive", "Vehicle"), group1, Dose),
    Marker = as.character(Marker)  # ensure type consistency
  ) %>%
  dplyr::select(Sex, PFAS, Marker, Dose, significance)
heatmap_data <- data_cyto %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(median_norm = median(normalized, na.rm = TRUE), .groups = "drop")
heatmap_with_sig <- heatmap_data %>%
  left_join(sig_for_heatmap, by = c("Sex", "PFAS", "Marker", "Dose"))

heatmap_with_sig$Dose <- factor(heatmap_with_sig$Dose, levels = c( "1.5", "1", "0.5", "0.166","Vehicle", "Naive"))
heatmap_with_sig$Marker <- factor(heatmap_with_sig$Marker, levels = c("G.CSF", "IL.3", "IL.5", "IL.10", "IL.4", "IL.13", "IL.17a", "Eotaxin", "KC", "MCP.1", "RANTES", "MIP.1a", "MIP.1b", "IL.1a", "IL.1b", "IL.6", "TNF.a", "IFN.g", "IL.2", "IL.12.p40.", "IL.12.p70."
))
                                  
heatmap_cyto <- ggplot(heatmap_with_sig, aes(x = Marker, y = Dose, fill = median_norm)) +
  geom_tile(color = "black", size = 0.4) +
  geom_text(aes(label = round(median_norm, 2)), size = 2.5, color = "black") +
  geom_text(aes(label = significance), vjust = 0.4, size = 6, color = "black", fontface = "bold") +
  scale_fill_gradient2(
    low = "#330597", mid = "white", high = "red", midpoint = 1,
    name = "Normalized\nMedian", limits = c(0, 3),  oob = scales::squish 
  ) +
  facet_grid(Sex ~ PFAS) +
scale_x_discrete(position = "top") + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
  text = element_text(size = 12, family = "Arial"),
  axis.text.x = element_text(angle = 45, hjust = 0, size = 12),
  axis.text.y = element_text(size = 12),
  panel.grid = element_blank(),
  strip.text = element_text(face = "bold", size = 12)
)+ coord_fixed(ratio = 1)

n_markers <- length(unique(heatmap_with_sig$Marker))
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
n_doses <- length(dose_levels)
tile_width_in <- 1
tile_height_in <- 1
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in 


ggsave(
  filename = "../invivo-pfas-immunotox/R input 56d/plots/cyto_heatmap.png",
  plot = heatmap_cyto,
  width = plot_width,
  height = plot_height,
  dpi = 300,
  bg = "white",limitsize = FALSE
)
##########################################################################################################################
#Dose-response curve
pfas_order <- c("PFOS", "PFOA")
marker_levels <- c("G.CSF", "GM.CSF", "IL.9", "IL.3", "IL.5", "IL.10", "IL.4", "IL.13", "IL.17a", "Eotaxin", "KC", "MCP.1", "RANTES", "MIP.1a", "IL.1a", "IL.1b", "IL.6", "TNF.a", "IFN.g", "IL.2", "IL.12.p40.", "IL.12.p70."
)

data_cyto$PFAS <- factor(data_cyto$PFAS, levels = pfas_order)
data_cyto$Dose <- factor(data_cyto$Dose, levels = dose_levels)
data_cyto$Marker <- factor(data_cyto$Marker, levels = marker_levels)

n_markers <- length(unique(heatmap_with_sig$Marker))/4
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
n_doses <- length(dose_levels)
tile_width_in <- 2.5
tile_height_in <- 2.5
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in * n_sex * n_pfas

summary_data <- data_cyto %>%
  group_by(Sex, PFAS, Marker, Dose) %>%
  summarise(
    median_stat = median(Value, na.rm = TRUE),
    Q1 = quantile(Value, 0.25, na.rm = TRUE),
    Q3 = quantile(Value, 0.75, na.rm = TRUE),
    IQR = Q3 - Q1,
    lower = median_stat - 1.5 * IQR,
    upper = median_stat + 1.5 * IQR,
    .groups = "drop"
  ) %>%
  mutate(
    y_position_label = upper + 1,
    Marker = factor(Marker, levels = marker_levels),
    Dose_factor = factor(Dose, levels = dose_levels)
  )

summary_data <- summary_data %>%
  left_join(
    significance_df_non_parametric %>%
      dplyr::select(PFAS, Marker, group1, significance) %>%
      dplyr::rename(Dose = group1),
    by = c("PFAS", "Marker", "Dose")
  )
vehicle_medians <- data_cyto %>%
  filter(Dose == "Vehicle") %>%
  group_by(Sex, PFAS, Marker) %>%
  summarise(vehicle_median = median(Value, na.rm = TRUE), .groups = "drop")
summary_data <- summary_data %>%
  left_join(vehicle_medians, by = c("Sex", "PFAS", "Marker"))

summary_data$Marker <- factor(summary_data$Marker, levels = marker_levels)

custom_colors_named <- c(
  "Naive"   = "#330597",
  "Vehicle" = "#8405a7",
  "0.166"   = "#b12a90",
  "0.5"     = "#d35171",
  "1"       = "#f68f44",
  "1.5"     = "#fec029"
)

sex_colors <- c("Male" = "#1f77b4", "Female" = "#e377c2")

plot <- ggplot(data_cyto, aes(x = interaction(Dose, Sex), y = Value)) +
  geom_jitter(
    aes(color = Dose),
    size = 1, alpha = 0.4, width = 0.2
  ) +
  geom_boxplot(
    aes(group = interaction(Dose, Sex, Marker), fill = Dose),
    outlier.shape = NA, alpha = 0.3, color = "black", width = 0.6,
    position = position_dodge(width = 0.75)
  ) +
  geom_hline(
    data = summary_data,
    aes(yintercept = vehicle_median, color = Sex, group = interaction(Sex, Marker)),
    linetype = "dotted", size = 0.8, alpha = 0.7,
    inherit.aes = FALSE
  ) +
  facet_wrap(PFAS ~ Marker, scales = "free_y", nrow = 8) +
  scale_color_manual(
    name = "Color",
    values = c(custom_colors_named, sex_colors)
  ) +
  scale_fill_manual(
    name = "Dose",
    values = custom_colors_named
  ) +
  labs(
    title = "Normalized Response by Dose and Sex",
    x = "Dose and Sex",
    y = "Value"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )
print(plot)
ggsave(filename = "../invivo-pfas-immunotox/R input 56d/plots/cyto_dr.png", plot = plot,
  width = plot_width,
  height = 28,
  dpi = 300,
  bg = "white",limitsize = FALSE)
replicate_summary <- data_cyto%>%
  group_by(Sex, Dose, PFAS, Marker) %>% 
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```

##TDAR stats and plot
```{r}
data_tdar <- read.csv("../invivo-pfas-immunotox/R input 56d/TDAR.csv")

data_tdar <- data_tdar %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_tdar <- data_tdar %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

controls <- data_tdar %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_tdar <- data_tdar %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_tdar <- data_tdar %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose),
    names_to = "Marker",
    values_to = "Value"
  )

data_tdar <- data_tdar %>% filter(!is.na(Value))
data_tdar$Value <- as.numeric(data_tdar$Value)

data_female <- data_tdar %>% filter(Sex == "Female")
data_male <- data_tdar %>% filter(Sex == "Male")

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")

significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)
unique_markers <- unique(data_tdar$Marker)

plot_data <- data_tdar %>%
    mutate(PFAS_Dose = case_when(
    Dose %in% c("Naive", "Vehicle") ~ Dose,
    TRUE ~ paste(PFAS, Dose)))

dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
plot_data$Dose <- factor(plot_data$Dose, levels = dose_levels)
data_tdar$Dose <- factor(data_tdar$Dose, levels = dose_levels)
y_max <- max(plot_data$Value, na.rm = TRUE)

custom_colors_named <- c(
  "Naive"   = "#330597",
  "Vehicle" = "#8405a7",
  "0.166"   = "#b12a90",
  "0.5"     = "#d35171",
  "1"       = "#f68f44",
  "1.5"     = "#fec029"
)

sex_colors <- c("Male" = "#1f77b4", "Female" = "#e377c2")
vehicle_medians <- data_tdar %>%
  filter(Dose == "Vehicle") %>%
  group_by(Sex, PFAS, Marker) %>%
  summarise(vehicle_median = median(Value, na.rm = TRUE), .groups = "drop")
plot_data <- plot_data %>%
  left_join(vehicle_medians, by = c("Sex", "PFAS", "Marker"))

plot <- ggplot(data_tdar, aes(x = interaction(Dose, Sex), y = Value)) +
  geom_jitter(
    aes(color = Dose),
    size = 1, alpha = 0.4, width = 0.2
  ) +
    geom_hline(
    data = plot_data,
    aes(yintercept = vehicle_median, color = Sex, group = interaction(Sex, Marker)),
    linetype = "dotted", size = 0.8, alpha = 0.7,
    inherit.aes = FALSE
  ) +
  geom_boxplot(
    aes(group = interaction(Dose, Sex, Marker), fill = Dose),
    outlier.shape = NA, alpha = 0.3, color = "black", width = 0.6,
    position = position_dodge(width = 0.75)
  ) +

  facet_wrap(PFAS ~ Marker, scales = "free_y", nrow = 1) +
  scale_color_manual(
    name = "Color",
    values = c(custom_colors_named, sex_colors)
  ) +
  scale_fill_manual(
    name = "Dose",
    values = custom_colors_named
  ) +
  labs(
    title = "Normalized Response by Dose and Sex",
    x = "Dose and Sex",
    y = "Value"
  ) +
    coord_cartesian(ylim = c(0, 3000)) +  
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )

print(plot)

ggsave(
  filename = "../invivo-pfas-immunotox/R input 56d/plots/tdar_boxplot_all_PFAS_all_markers.png",
  plot = plot,
  width = 7,
  height = 6,
  dpi = 300,
  bg = "white"
)

replicate_summary <- data_tdar%>%
  group_by(Sex, Dose, PFAS, Marker) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```


#Liver tox
##Biochem stats and plot
```{r}
data_bio <- read.csv("../invivo-pfas-immunotox/R input 56d/biochemistry.csv")

data_bio <- data_bio %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_bio <- data_bio %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

controls <- data_bio %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_bio <- data_bio %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_bio <- data_bio %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose),
    names_to = "Marker",
    values_to = "Value"
  )


data_bio <- data_bio %>% filter(!is.na(Value))
data_bio$Value <- as.numeric(data_bio$Value)

data_female <- data_bio %>% filter(Sex == "Female")
data_male <- data_bio %>% filter(Sex == "Male")

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
         P.adj >= 0.05 & P.adj < 0.099 ~ ".",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}


sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")

significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)

##########################################################################################################################
#Normalize 
data_bio <- data_bio %>%
  group_by(Sex, PFAS, Marker) %>%
  mutate(vehicle_median = median(Value[Dose == "Vehicle"], na.rm = TRUE),
         normalized = Value / vehicle_median,
         percent_of_vehicle = (Value / vehicle_median) * 100) %>%
  ungroup()
data_female <- data_bio %>% filter(Sex == "Female")
data_male <- data_bio %>% filter(Sex == "Male")


get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      kw_test <- kruskal.test(normalized ~ Dose, data = subset_data)

      if (kw_test$p.value < 0.05) {
        dunn_result <- dunnTest(normalized ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
         P.adj >= 0.05 & P.adj < 0.099 ~ ".",
              
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$normalized, na.rm = TRUE)
          increment <- max_y * 0.1
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + 10)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}


sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")

significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)

##########################################################################################################################
#Heatmap
sig_for_heatmap <- significance_df_non_parametric %>%
  mutate(
    Dose = str_remove(group1, ".* "), 
    Dose = ifelse(group1 %in% c("Naive", "Vehicle"), group1, Dose),
    Marker = as.character(Marker) 
  ) %>%
  dplyr::select(Sex, PFAS, Marker, Dose, significance)
heatmap_data <- data_bio %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(median_norm = median(normalized, na.rm = TRUE), .groups = "drop")
heatmap_with_sig <- heatmap_data %>%
  left_join(sig_for_heatmap, by = c("Sex", "PFAS", "Marker", "Dose"))

heatmap_with_sig$Dose <- factor(heatmap_with_sig$Dose, levels = c( "1.5", "1", "0.5", "0.166","Vehicle", "Naive"))
heatmap_with_sig$Marker <- factor(heatmap_with_sig$Marker, levels = c("ALP",	"ALT",	"CA",	"CHOL",	"FT4", "LDH","TBI",	"TGL"))
                                  
heatmap_bio <- ggplot(heatmap_with_sig, aes(x = Marker, y = Dose, fill = median_norm)) +
  geom_tile(color = "black", size = 0.4) +
  geom_text(aes(label = round(median_norm, 2)), size = 2.5, color = "black") +
  geom_text(aes(label = significance), vjust = 0.4, size = 6, color = "black", fontface = "bold") +
  scale_fill_gradient2(
    low = "#330597", mid = "white", high = "red", midpoint = 1,
    name = "Normalized\nMedian", limits = c(0, 4),  oob = scales::squish 
  ) +
  facet_grid(Sex ~ PFAS) +
scale_x_discrete(position = "top") + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
   theme_minimal(base_size = 12) +
  theme(
  text = element_text(size = 12, family = "Arial"),
  axis.text.x = element_text(angle = 45, hjust = 0, size = 12),
  axis.text.y = element_text(size = 12),
  panel.grid = element_blank(),
strip.text = element_text(face = "bold", size = 12)
)+ coord_fixed(ratio = 1)

n_markers <- length(unique(heatmap_with_sig$Marker))
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
n_doses <- length(dose_levels)
tile_width_in <- 1
tile_height_in <- 1
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in 

ggsave(
  filename = "../invivo-pfas-immunotox/R input 56d/plots/bio_heatmap.png",
  plot = heatmap_bio,
  width = plot_width,
  height = plot_height,
  dpi = 300,
  bg = "white"
)
print(heatmap_bio)
##########################################################################################################################
#Dose-response curve
pfas_order <- c("PFOS", "PFOA")
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
marker_levels <- c("ALP",	"ALT",	"CA",	"CHOL",	"FT4", "LDH","TBI",	"TGL")

data_bio$PFAS <- factor(data_bio$PFAS, levels = pfas_order)
data_bio$Dose <- factor(data_bio$Dose, levels = dose_levels)
data_bio$Marker <- factor(data_bio$Marker, levels = marker_levels)

n_markers <- length(unique(heatmap_with_sig$Marker))/2
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
n_doses <- length(dose_levels)
tile_width_in <- 2.5
tile_height_in <- 2.5
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in * n_sex * n_pfas

summary_data <- data_bio %>%
  group_by(Sex, PFAS, Marker, Dose) %>%
  summarise(
    median_stat = median(Value, na.rm = TRUE),
    Q1 = quantile(Value, 0.25, na.rm = TRUE),
    Q3 = quantile(Value, 0.75, na.rm = TRUE),
    IQR = Q3 - Q1,
    lower = median_stat - 1.5 * IQR,
    upper = median_stat + 1.5 * IQR,
    .groups = "drop"
  ) %>%
  mutate(
    y_position_label = upper + 1,
    Marker = factor(Marker, levels = marker_levels),
    Dose_factor = factor(Dose, levels = dose_levels)
  )

summary_data <- summary_data %>%
  left_join(
    significance_df_non_parametric %>%
      dplyr::select(PFAS, Marker, group1, significance) %>%
      dplyr::rename(Dose = group1),
    by = c("PFAS", "Marker", "Dose")
  )
vehicle_medians <- data_bio %>%
  filter(Dose == "Vehicle") %>%
  group_by(Sex, PFAS, Marker) %>%
  summarise(vehicle_median = median(Value, na.rm = TRUE), .groups = "drop")
summary_data <- summary_data %>%
  left_join(vehicle_medians, by = c("Sex", "PFAS", "Marker"))

summary_data$Marker <- factor(summary_data$Marker, levels = marker_levels)

custom_colors_named <- c(
  "Naive"   = "#330597",
  "Vehicle" = "#8405a7",
  "0.166"   = "#b12a90",
  "0.5"     = "#d35171",
  "1"       = "#f68f44",
  "1.5"     = "#fec029"
)

sex_colors <- c("Male" = "#1f77b4", "Female" = "#e377c2")

plot <- ggplot(data_bio, aes(x = interaction(Dose, Sex), y = Value)) +
  geom_jitter(
    aes(color = Dose),
    size = 1, alpha = 0.4, width = 0.2
  ) +
  geom_boxplot(
    aes(group = interaction(Dose, Sex, Marker), fill = Dose),
    outlier.shape = NA, alpha = 0.3, color = "black", width = 0.6,
    position = position_dodge(width = 0.75)
  ) +
  geom_hline(
    data = summary_data,
    aes(yintercept = vehicle_median, color = Sex, group = interaction(Sex, Marker)),
    linetype = "dotted", size = 0.8, alpha = 0.7,
    inherit.aes = FALSE
  ) +
  facet_wrap(PFAS ~ Marker, scales = "free_y", nrow = 4) +
  scale_color_manual(
    name = "Color",
    values = c(custom_colors_named, sex_colors)
  ) +
  scale_fill_manual(
    name = "Dose",
    values = custom_colors_named
  ) +
  labs(
    title = "Normalized Response by Dose and Sex",
    x = "Dose and Sex",
    y = "Value"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )
print(plot)
ggsave(filename = "../invivo-pfas-immunotox/R input 56d/plots/bio_dr.png", plot = plot,
  width = plot_width,
  height = 14,
  dpi = 300,
  bg = "white")
replicate_summary <- data_bio%>%
  group_by(Sex, Dose, PFAS, Marker) %>% 
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```
##Tissue weight stats and plot
```{r}
data_tissue <- read.csv("../invivo-pfas-immunotox/R input 56d/tissue weight norm.csv")

data_tissue <- data_tissue %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_tissue <- data_tissue %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

controls <- data_tissue %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_tissue <- data_tissue %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_tissue <- data_tissue %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose),
    names_to = "Marker",
    values_to = "Value"
  )


data_tissue <- data_tissue %>% filter(!is.na(Value))
data_tissue$Value <- as.numeric(data_tissue$Value)

data_female <- data_tissue %>% filter(Sex == "Female")
data_male <- data_tissue %>% filter(Sex == "Male")

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
               P.adj >= 0.05 & P.adj < 0.099 ~ ".",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        # Add y-position for plotting
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)

##########################################################################################################################
#Normalize 
data_tissue <- data_tissue %>%
  group_by(Sex, PFAS, Marker) %>%
  mutate(vehicle_median = median(Value[Dose == "Vehicle"], na.rm = TRUE),
         normalized = Value / vehicle_median,
         percent_of_vehicle = (Value / vehicle_median) * 100) %>%
  ungroup()
data_female <- data_tissue %>% filter(Sex == "Female")
data_male <- data_tissue %>% filter(Sex == "Male")

get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      kw_test <- kruskal.test(normalized ~ Dose, data = subset_data)

      if (kw_test$p.value < 0.05) {
    
        dunn_result <- dunnTest(normalized ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
               P.adj >= 0.05 & P.adj < 0.099 ~ ".",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$normalized, na.rm = TRUE)
          increment <- max_y * 0.1
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + 10)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")

significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)
print(significance_df_non_parametric)
##########################################################################################################################
#Heatmap
sig_for_heatmap <- significance_df_non_parametric %>%
  mutate(
    Dose = str_remove(group1, ".* "),  
    Dose = ifelse(group1 %in% c("Naive", "Vehicle"), group1, Dose),
    Marker = as.character(Marker)  
  ) %>%
  dplyr::select(Sex, PFAS, Marker, Dose, significance)
heatmap_data <- data_tissue %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(median_norm = median(normalized, na.rm = TRUE), .groups = "drop")
heatmap_with_sig <- heatmap_data %>%
  left_join(sig_for_heatmap, by = c("Sex", "PFAS", "Marker", "Dose"))

heatmap_with_sig$Dose <- factor(heatmap_with_sig$Dose, levels = c( "1.5", "1", "0.5", "0.166","Vehicle", "Naive"))
heatmap_with_sig$Marker <- factor(heatmap_with_sig$Marker, levels = c("Liver", "Pancreas", "Spleen", "Thymus", "Kidneys", "GI.Tract"))
                                  
heatmap_tissue <- ggplot(heatmap_with_sig, aes(x = Marker, y = Dose, fill = median_norm)) +
  geom_tile(color = "black", size = 0.4) +
  geom_text(aes(label = round(median_norm, 2)), size = 2.5, color = "black") +
  geom_text(aes(label = significance), vjust = 0.4, size = 6, color = "black", fontface = "bold") +
  scale_fill_gradient2(
    low = "#330597", mid = "white", high = "red", midpoint = 1,
    name = "Normalized\nMedian", limits = c(0, 2),  oob = scales::squish 
  ) +
  facet_grid(Sex ~ PFAS) +
scale_x_discrete(position = "top") + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
  text = element_text(size = 12, family = "Arial"),
  axis.text.x = element_text(angle = 45, hjust = 0, size = 12),
  axis.text.y = element_text(size = 12),
  panel.grid = element_blank(),
 strip.text = element_text(face = "bold", size = 12)
)+ coord_fixed(ratio = 1)

n_markers <- length(unique(heatmap_with_sig$Marker))
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
n_doses <- length(dose_levels)

tile_width_in <- 1
tile_height_in <- 1
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in 


ggsave(
  filename = "../invivo-pfas-immunotox/R input 56d/plots/tissue_heatmap.png",
  plot = heatmap_tissue,
  width = plot_width,
  height = plot_height,
  dpi = 300,
  bg = "white",limitsize = FALSE
)
print(heatmap_tissue)
##########################################################################################################################
#Dose-response curve
pfas_order <- c("PFOS", "PFOA")
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
marker_levels <- c("Liver", "Pancreas", "Spleen", "Thymus", "Kidneys", "GI.Tract")


data_tissue$PFAS <- factor(data_tissue$PFAS, levels = pfas_order)
data_tissue$Dose <- factor(data_tissue$Dose, levels = dose_levels)
data_tissue$Marker <- factor(data_tissue$Marker, levels = marker_levels)

n_markers <- length(unique(heatmap_with_sig$Marker))
n_sex <- length(unique(heatmap_with_sig$Sex))
n_pfas <- length(unique(heatmap_with_sig$PFAS))
n_doses <- length(dose_levels)
tile_width_in <- 2.5
tile_height_in <- 2.5
plot_width <- n_markers * tile_width_in
plot_height <- n_doses * tile_height_in * n_sex * n_pfas


summary_data <- data_tissue %>%
  group_by(Sex, PFAS, Marker, Dose) %>%
  summarise(
    median_stat = median(Value, na.rm = TRUE),
    Q1 = quantile(Value, 0.25, na.rm = TRUE),
    Q3 = quantile(Value, 0.75, na.rm = TRUE),
    IQR = Q3 - Q1,
    lower = median_stat - 1.5 * IQR,
    upper = median_stat + 1.5 * IQR,
    .groups = "drop"
  ) %>%
  mutate(
    y_position_label = upper + 1,
    Marker = factor(Marker, levels = marker_levels),
    Dose_factor = factor(Dose, levels = dose_levels)
  )

summary_data <- summary_data %>%
  left_join(
    significance_df_non_parametric %>%
      dplyr::select(PFAS, Marker, group1, significance) %>%
      dplyr::rename(Dose = group1),
    by = c("PFAS", "Marker", "Dose")
  )
vehicle_medians <- data_tissue %>%
  filter(Dose == "Vehicle") %>%
  group_by(Sex, PFAS, Marker) %>%
  summarise(vehicle_median = median(Value, na.rm = TRUE), .groups = "drop")
summary_data <- summary_data %>%
  left_join(vehicle_medians, by = c("Sex", "PFAS", "Marker"))

summary_data$Marker <- factor(summary_data$Marker, levels = marker_levels)

custom_colors_named <- c(
  "Naive"   = "#330597",
  "Vehicle" = "#8405a7",
  "0.166"   = "#b12a90",
  "0.5"     = "#d35171",
  "1"       = "#f68f44",
  "1.5"     = "#fec029"
)

sex_colors <- c("Male" = "#1f77b4", "Female" = "#e377c2")

plot <- ggplot(data_tissue, aes(x = interaction(Dose, Sex), y = Value)) +
  geom_jitter(
    aes(color = Dose),
    size = 1, alpha = 0.4, width = 0.2
  ) +
  geom_boxplot(
    aes(group = interaction(Dose, Sex, Marker), fill = Dose),
    outlier.shape = NA, alpha = 0.3, color = "black", width = 0.6,
    position = position_dodge(width = 0.75)
  ) +
  geom_hline(
    data = summary_data,
    aes(yintercept = vehicle_median, color = Sex, group = interaction(Sex, Marker)),
    linetype = "dotted", size = 0.8, alpha = 0.7,
    inherit.aes = FALSE
  ) +
  facet_wrap(PFAS ~ Marker, scales = "free_y", nrow = 2) +
  scale_color_manual(
    name = "Color",
    values = c(custom_colors_named, sex_colors)
  ) +
  scale_fill_manual(
    name = "Dose",
    values = custom_colors_named
  ) +
  labs(
    title = "Normalized Response by Dose and Sex",
    x = "Dose and Sex",
    y = "Value"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )

print(plot)
ggsave(filename = "../invivo-pfas-immunotox/R input 56d/plots/tissue_dr.png", plot = plot,
  width = plot_width,
  height = 7,
  dpi = 300,
  bg = "white")
replicate_summary <- data_tissue%>%
  group_by(Sex, Dose, PFAS, Marker) %>% 
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```

##Liver toxicity using real values
```{r}
#If multiple RR used first (checked that they were similar)

data_conc <- read.csv("../invivo-pfas-immunotox/R input 56d/Liver PFAS values phase 2 and 3.csv")
data_bio <- read.csv("../invivo-pfas-immunotox/R input 56d/biochemistry.csv")

doses <- c("Naive", "Vehicle", "PFOA 0.166", "PFOA 0.5", "PFOA 1", " PFOA 1.5", "PFOS 0.166", "PFOS 0.5", "PFOS 1", " PFOS 1.5")
pfas_cols <- c(
  "PFOA", "PFOS", "PFBA", "PFPeA", "PFHxA", "PFHpA", "PFNA", "PFDA", "PFUdA", "PFDoA", "PFTrDA", "PFTeDA",
  "PFBS", "PFPeS", "PFHxS", "PFHpS", "PFNS", "PFDS",
  "X4_2.FTS", "X6_2_FTS", "X8_2.FTS", "N.MeFOSAA", "N.EtFOSAA", "FOSA"
)

mdls_naive_vehicle <- c(
  PFOA = 0.184, PFOS = 0.285, PFBA = 0.139, PFPeA = 0.164, PFHxA = 0.138,
  PFHpA = 0.107, PFNA = 0.153, PFDA = 0.114, PFUdA = 0.115, PFDoA = 0.087,
  PFTrDA = 0.104, PFTeDA = 0.145, PFBS = 0.526, PFPeS = 0.297, PFHxS = 0.758,
  PFHpS = 0.251, PFNS = 0.232, PFDS = 0.202, `X4_2.FTS` = 0.211, `X6_2_FTS` = 0.306,
  `X8_2.FTS` = 0.231
)

mdls_dose_0166_05 <- c(
  PFOA = 0.156, PFOS = 0.230, PFBA = 0.078, PFPeA = 0.085, PFHxA = 0.115,
  PFHpA = 0.047, PFNA = 0.153, PFDA = 0.206, PFUdA = 0.074, PFDoA = 0.115,
  PFTrDA = 0.105, PFTeDA = 0.112, PFBS = 0.150, PFPeS = 0.253, PFHxS = 0.155,
  PFHpS = 0.186, PFNS = 0.164, PFDS = 0.262, `X4_2.FTS` = 0.074, `X6_2_FTS` = 0.276,
  `X8_2.FTS` = 0.271, N.MeFOSAA = 0.291, N.EtFOSAA = 0.171, FOSA = 0.103
)

mdls_dose_1_15 <-  c(
  PFOA = 0.781, PFOS = 1.148, PFBA = 0.392, PFPeA = 0.426, PFHxA = 0.573,
  PFHpA = 0.233, PFNA = 0.766, PFDA = 1.030, PFUdA = 0.372, PFDoA = 0.575,
  PFTrDA = 0.524, PFTeDA = 0.562, PFBS = 0.748, PFPeS = 1.263, PFHxS = 0.776,
  PFHpS = 0.932, PFNS = 0.822, PFDS = 1.309, `X4_2.FTS` = 0.369, `X6_2_FTS` = 1.381,
  `X8_2.FTS` = 1.354, N.MeFOSAA = 1.455, N.EtFOSAA = 0.854, FOSA = 0.513
)

mdls_df <- bind_rows(
  tibble(Group = "Naive", !!!mdls_naive_vehicle),
  tibble(Group = "Vehicle", !!!mdls_naive_vehicle),
  tibble(Group = "0.166", !!!mdls_dose_0166_05),
  tibble(Group = "0.5", !!!mdls_dose_0166_05),
  tibble(Group = "1", !!!mdls_dose_1_15),
  tibble(Group = "1.5", !!!mdls_dose_1_15)
) %>%
  pivot_longer(
    -Group,
    names_to = "PFAS",
    values_to = "MDL"
  )

pfas_cols <- mdls_df$PFAS %>% unique()
data_conc[pfas_cols] <- lapply(data_conc[pfas_cols], as.character)

for (pfas_name in unique(mdls_df$PFAS)) {
  if (pfas_name %in% colnames(data_conc)) {
    for (dose_level in unique(mdls_df$Group)) {
      mdl_val <- mdls_df %>%
        filter(PFAS == pfas_name, Group == dose_level) %>%
        pull(MDL)

      if (length(mdl_val) == 1 && !is.na(mdl_val)) {
        dose_match <- trimws(gsub("^.*\\s", "", data_conc$Group))
        idx <- which(dose_match == dose_level & data_conc[[pfas_name]] == "<MDL")

        if (length(idx) > 0) {
          data_conc[idx, pfas_name] <- mdl_val / 2
        }
      }
    }
  }
}


pfas_cols <- unique(mdls_df$PFAS)
data_conc[pfas_cols] <- lapply(data_conc[pfas_cols], as.numeric)
pfas_cols <- unique(mdls_df$PFAS)

data_conc[data_conc$Group %in% c("Naive", "Vehicle"), pfas_cols] <-
  data_conc[data_conc$Group %in% c("Naive", "Vehicle"), pfas_cols] / 1000

data_conc_subset <- data_conc %>%
  dplyr::select(Mouse.ID, Sex, Group, all_of(pfas_cols))

write.csv(data_conc, file = "../invivo-pfas-immunotox/R input 56d/Liver_PFAS_values_fixed_56d.csv", row.names = FALSE)

other_pfas <- setdiff(pfas_cols, c("PFOS", "PFOA"))
plasma_colors <- viridis(length(other_pfas), option = "plasma")
names(plasma_colors) <- other_pfas

custom_colors <- c(
  "PFOS" = "red",  
  "PFOA" = "blue",    
  plasma_colors          
)

group_levels <- c(
  "Naive", "Vehicle",
  paste("PFOS", c("0.166", "0.5", "1", "1.5")),
  paste("PFOA", c("0.166", "0.5", "1", "1.5"))
)

data_combined_long <- data_conc %>%
  pivot_longer(
    cols = all_of(pfas_cols),
    names_to = "PFAS_name",
    values_to = "PFAS_conc"
  ) %>%
  filter(!is.na(PFAS_conc)) %>%
  mutate(
    PFAS_conc = as.numeric(PFAS_conc),
    group = factor(Group, levels = group_levels),
    PFAS_name = factor(PFAS_name, levels = names(custom_colors)) 
  )
average_pfas <- data_conc %>%
  group_by(Group) %>%
  summarise(
    Mean_PFOS = format(mean(PFOS, na.rm = TRUE), scientific = FALSE),
    Mean_PFOA = format(mean(PFOA, na.rm = TRUE), scientific = FALSE),
    .groups = "drop"
  )

print(average_pfas)
# Plot
p <-ggplot(data_combined_long, aes(x = group, y = PFAS_conc, color =  PFAS_name , shape= Sex)) +
    geom_jitter(alpha = 0.7, size = 2.2, width = 0.2, height = 0) +
  scale_color_manual(values = custom_colors) +
  labs(
    x = "Group",
    y = "Liver PFAS concentration (mg/kg)",
    color = "PFAS"
  ) +
  coord_cartesian(ylim = c(0, 800)) +  
  theme_minimal() +
  theme(
        text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "none",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank()
  )
print(p)
ggsave(filename = "../invivo-pfas-immunotox/R input 56d/plots/liver_conc.png", plot = p, width = 12.5, height = 5, dpi = 300,bg = "white")
replicate_summary <- data_combined_long%>%
  group_by(Group, PFAS_name) %>% 
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
##########################################################################################################################
data_bio <- data_bio %>%
  dplyr::rename(`Mouse.ID` = `Sample.`)
data_combined <- data_bio %>%
  left_join(data_conc %>% dplyr::select(Mouse.ID, PFOA, PFOS), by = "Mouse.ID")

data_combined <- data_combined %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group)) %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)


controls <- data_combined %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
    dplyr::slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_combined <- data_combined %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_combined <- data_combined %>%
  pivot_longer(
    cols = -c(Mouse.ID, Sex, group, PFAS, Dose, PFOA, PFOS),
    names_to = "Marker",
    values_to = "Value"
  ) 

############################################################################################
#drc
data_combined <- data_combined %>%
  filter(Marker %in% c("ALP", "ALT", "TGL", "CA"))

data_clean <- data_combined %>%
  mutate(
    Value = as.numeric(as.character(Value)),
    # Vehicle → 0; else numeric
    Dose_num = ifelse(Dose == "Vehicle",
                      0,
                      as.numeric(as.character(Dose)))
  ) %>%
  mutate(
    Cumulative_Dose     = Dose_num * 56,
    Cumulative_Dose_adj = Cumulative_Dose + 1
  ) %>%
  filter(!is.na(Dose_num) & is.finite(Dose_num))

avg_measured <- data_clean %>%
  filter(PFAS == "PFOS") %>%
  group_by(Dose_num) %>%
  summarize(
   
    Mean_Measured = mean(PFOS, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(Measured_adj = Mean_Measured + 1)  

nested <- data_clean %>%
  filter(PFAS == "PFOS") %>%
  left_join(avg_measured, by = "Dose_num") %>%
  mutate(Measured_adj = Mean_Measured + 1) %>%
 
  filter(
    !is.na(Cumulative_Dose_adj),
    !is.na(Measured_adj),
    !is.na(Value),
    is.finite(Cumulative_Dose_adj),
    is.finite(Measured_adj),
    is.finite(Value)
  ) %>%
  group_by(Marker) %>%
  nest()

safe_model_predict <- function(df, dose_col) {
  doses <- df[[dose_col]]
  resp  <- df$Value

  if (length(unique(doses)) < 3 || var(resp, na.rm=TRUE) == 0) return(NULL)
  
  mod <- tryCatch(
    drm(resp ~ doses, fct = LL.4(), data = data.frame(doses, resp)),
    error = function(e) NULL
  )
  if (is.null(mod)) return(NULL)
  
  newdose <- seq(min(doses), max(doses), length.out = 100)
  pred_df <- data.frame(Dose = newdose)
  pred_df$fit <- tryCatch(
    predict(mod, newdata = data.frame(doses = newdose)),
    error = function(e) rep(NA, length(newdose))
  )
  return(pred_df)
}

models_nominal <- nested %>%
  mutate(pred = map(data, ~safe_model_predict(.x, "Cumulative_Dose_adj"))) %>%
 filter(!map_lgl(pred, is.null)) %>%    
  unnest(pred) %>%
  mutate(Source = "Nominal Dose")

models_measured <- nested %>%
  mutate(pred = map(data, ~safe_model_predict(.x, "Measured_adj"))) %>%
 filter(!map_lgl(pred, is.null)) %>%    
  unnest(pred) %>%
  mutate(Source = "Measured PFOS")

models_combined <- bind_rows(models_nominal, models_measured)

raw_nominal  <- nested %>%
  unnest(data) %>%
  mutate(x = Cumulative_Dose_adj, Source = "Nominal Dose")

raw_measured <- nested %>%
  unnest(data) %>%
  mutate(x = Measured_adj, Source = "Measured PFOS")

raw_combined <- bind_rows(raw_nominal, raw_measured)

pfos_plot <- ggplot() +
  geom_point(data = raw_combined,
             aes(x = x, y = Value, color = Source, shape = Sex),
             alpha = 0.6, size = 1.8) +
  geom_line(data = models_combined,
            aes(x = Dose,       # <— here
                y = fit,
                color = Source,
                linetype = Source),
            size = 1) +
  facet_wrap(~ Marker, scales = "free_y", nrow = 1) +
  scale_x_log10() +
scale_color_manual(
    name = "Plasma",
    values = c("Measured PFOS" = "#8405a7", "Nominal Dose" = "#f68f44")) +
  labs(
    title = "PFOS: Nominal vs Measured Dose–Response (LL.4)",
    x = "Dose (log10 scale, +1)",
    y = "Response (Value)",
    color = "Source",
    shape = "Source",
    linetype = "Source"
  ) +
  theme_minimal(base_size = 12) +
  theme(strip.text = element_text(face = "bold"))


print(pfos_plot)

ggsave(filename = "../invivo-pfas-immunotox/R input 56d/plots/pfos_drc.png", plot = pfos_plot, width = 9, height = 3, dpi = 300,bg = "white")

avg_measured <- data_clean %>%
  filter(PFAS == "PFOA") %>%
  group_by(Dose_num) %>%
  summarize(
    Mean_Measured = mean(PFOA, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(Measured_adj = Mean_Measured + 1)

nested <- data_clean %>%
  filter(PFAS == "PFOA") %>%
  left_join(avg_measured, by = "Dose_num") %>%
  mutate(Measured_adj = Mean_Measured + 1) %>%
  filter(
    !is.na(Cumulative_Dose_adj),
    !is.na(Measured_adj),
    !is.na(Value),
    is.finite(Cumulative_Dose_adj),
    is.finite(Measured_adj),
    is.finite(Value)
  ) %>%
  group_by(Marker) %>%
  nest()

safe_model_predict <- function(df, dose_col) {
  doses <- df[[dose_col]]
  resp  <- df$Value
 
  if (length(unique(doses)) < 3 || var(resp, na.rm=TRUE) == 0) return(NULL)
  
  mod <- tryCatch(
    drm(resp ~ doses, fct = LL.4(), data = data.frame(doses, resp)),
    error = function(e) NULL
  )
  if (is.null(mod)) return(NULL)
  
  newdose <- seq(min(doses), max(doses), length.out = 100)
  pred_df <- data.frame(Dose = newdose)
  pred_df$fit <- tryCatch(
    predict(mod, newdata = data.frame(doses = newdose)),
    error = function(e) rep(NA, length(newdose))
  )
  return(pred_df)
}

models_nominal <- nested %>%
  mutate(pred = map(data, ~safe_model_predict(.x, "Cumulative_Dose_adj"))) %>%
 filter(!map_lgl(pred, is.null)) %>%    
  unnest(pred) %>%
  mutate(Source = "Nominal Dose")

models_measured <- nested %>%
  mutate(pred = map(data, ~safe_model_predict(.x, "Measured_adj"))) %>%
 filter(!map_lgl(pred, is.null)) %>%    
  unnest(pred) %>%
  mutate(Source = "Measured PFOA")

models_combined <- bind_rows(models_nominal, models_measured)

raw_nominal  <- nested %>%
  unnest(data) %>%
  mutate(x = Cumulative_Dose_adj, Source = "Nominal Dose")

raw_measured <- nested %>%
  unnest(data) %>%
  mutate(x = Measured_adj, Source = "Measured PFOA")

raw_combined <- bind_rows(raw_nominal, raw_measured)

pfoa_plot <- ggplot() +
  geom_point(data = raw_combined,
             aes(x = x, y = Value, color = Source, shape = Sex),
             alpha = 0.6, size = 1.8) +
  geom_line(data = models_combined,
            aes(x = Dose,       # <— here
                y = fit,
                color = Source,
                linetype = Source),
            size = 1) +
  facet_wrap(~ Marker, scales = "free_y", nrow = 1) +
  scale_x_log10() +
scale_color_manual(
    name = "Plasma",
    values = c("Measured PFOA" = "#8405a7", "Nominal Dose" = "#f68f44")) +
  labs(
    title = "PFOA: Nominal vs Measured Dose–Response (LL.4)",
    x = "Dose (log10 scale, +1)",
    y = "Response (Value)",
    color = "Source",
    shape = "Source",
    linetype = "Source"
  ) +
  theme_minimal(base_size = 12) +
  theme(strip.text = element_text(face = "bold"))


print(pfoa_plot)

ggsave(filename = "../invivo-pfas-immunotox/R input 56d/plots/pfoa_drc.png", plot = pfoa_plot, width = 9, height = 3, dpi = 300,bg = "white")
```



#Water consumption
```{r}
data_water <- read.csv("../invivo-pfas-immunotox/R input 56d/water consumption.csv")

data_water <- data_water %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"), paste("control", group), group)) %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

data_water$Dose <- factor(data_water$Dose, levels = c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5"))

controls <- data_water %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_water <- data_water %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls) %>%
  filter(PFAS %in% c("PFOS", "PFOA")) %>%
  mutate(across(matches("^Baseline$|^Week[0-9]+$"), as.numeric))

data_water <- data_water %>%
  pivot_longer(cols = -c(Sample., Sex, group, PFAS, Dose),
               names_to = "Marker", values_to = "Value") %>%
  filter(!is.na(Value)) %>%
  mutate(Value = as.numeric(Value),
         Marker = factor(Marker, levels = c("Baseline", paste0("Week", 1:8))))

data_water <- data_water %>%
  group_by(Sample.) %>%
  mutate(Change_from_baseline = Value - Value[Marker == "Baseline"]) %>%
  ungroup()

data_water <- data_water %>%
  mutate(DoseSex = case_when(
    Sex == "Male" & Dose == "Vehicle" ~ "Vehicle",
    Sex == "Male" & Dose %in% c("0.166", "0.5", "1", "1.5") ~ "HighM",
    Sex == "Female" & Dose == "Vehicle" ~ "Vehicle",
    Sex == "Female" & Dose %in% c("0.166", "0.5", "1", "1.5") ~ "HighF",
    TRUE ~ as.character(Dose)
  ))


get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      subset_data <- data %>% filter(PFAS == chem, Marker == marker)
      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
      pairwise_results <- dunn_result$res %>%
        filter(str_detect(Comparison, "Vehicle")) %>%
        mutate(
          group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
          group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
          significance = case_when(
            P.adj < 0.001 ~ "***",
            P.adj < 0.01 ~ "**",
            P.adj < 0.05 ~ "*",
            P.adj >= 0.05 & P.adj < 0.099 ~ ".",
            TRUE ~ "ns"
          ),
          PFAS = chem,
          Marker = marker,
          Sex = sex_label
        )
      if (nrow(pairwise_results) > 0) {
        max_y <- max(subset_data$Value, na.rm = TRUE)
        pairwise_results <- pairwise_results %>%
          mutate(y.position = max_y + (row_number() - 1) * 2 + 20)
        results[[paste(sex_label, chem, marker, sep = "_")]] <- pairwise_results
      }
    }
  }
  bind_rows(results)
}

data_female <- data_water %>% filter(Sex == "Female")
data_male <- data_water %>% filter(Sex == "Male")

sig_female_pfos <- get_significance_non_parametric(data_female %>% filter(PFAS == "PFOS"), "Female")
sig_female_pfoa <- get_significance_non_parametric(data_female %>% filter(PFAS == "PFOA"), "Female")
sig_male_pfos   <- get_significance_non_parametric(data_male %>% filter(PFAS == "PFOS"), "Male")
sig_male_pfoa   <- get_significance_non_parametric(data_male %>% filter(PFAS == "PFOA"), "Male")

significance_df_non_parametric <- bind_rows(
  sig_female_pfos, sig_female_pfoa, sig_male_pfos, sig_male_pfoa
)
print(significance_df_non_parametric)

summary_stats <- data_water %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(
    median = median(Change_from_baseline, na.rm = TRUE),
    Q1 = quantile(Change_from_baseline, 0.25, na.rm = TRUE),
    Q3 = quantile(Change_from_baseline, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    DoseSex = paste0(Dose, "_", substr(Sex, 1, 1)),
    lower = Q1,
    upper = Q3
  )

female_colors <- c(
  "Naive"   = "#fee2e2",
"Vehicle" = "black",
"0.166"   = "#fecaca",
"0.5"     = "#fca5a5",
"1"       = "#f87171",
"1.5"     = "#e53e3e"
)

male_colors <- c(
  "Naive"   = "#eff6ff",
"Vehicle" = "black",
"0.166"   = "#bfdbfe",
"0.5"     = "#93c5fd",
"1"       = "#60a5fa",
"1.5"     = "#3b82f6"
)


dose_levels <- names(female_colors)

dose_sex_colors <- c(
  setNames(female_colors, paste0(dose_levels, "_F")),
  setNames(male_colors, paste0(dose_levels, "_M"))
)
p <- ggplot(summary_stats, aes(x = Marker, y = median, group = DoseSex, color = DoseSex)) +
  geom_line(size = 1, linetype = "solid") +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  facet_wrap(Sex ~ PFAS, scales = "free_y") +
  scale_color_manual(values = dose_sex_colors) +
  labs(
    title = "Median Body Weight Change Over Time (± IQR)",
    x = "Week",
    y = "Δwater (ml)"
  ) +
  coord_cartesian(ylim = c(-20, 30)) + 
  theme_minimal() +
  theme(
        text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "none",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank()
  )

print(p)
ggsave(filename = "../invivo-pfas-immunotox/R input 56d/plots/water_consumption.png", plot = p, width = 9, height = 5, dpi = 300, bg = "white")
replicate_summary <- data_water %>%
  filter(Sex == "Female") %>%  
  group_by(group, Marker, PFAS) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d FEMALE mice/group\n", min_n, max_n))

replicate_summary <- data_water %>%
  filter(Sex == "Male") %>% 
  group_by(group, Marker, PFAS) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d male mice/group\n", min_n, max_n))
```

#Plasma toxicity using real values
```{r}
#If multiple RR used first (checked that they were similar)

data_conc <- read.csv("../invivo-pfas-immunotox//R input 56d/plasma 56d.csv")
doses <- c("Naive", "Vehicle", "PFOA 0.166", "PFOA 0.5", "PFOA 1", " PFOA 1.5", "PFOS 0.166", "PFOS 0.5", "PFOS 1", " PFOS 1.5")
colnames(data_conc)
pfas_cols <- c(
  "PFOA", "PFOS", "PFBA", "PFPeA", "PFHxA", "PFHpA", "PFNA", "PFDA", "PFUdA", "PFDoA",
  "PFTrDA", "PFTeDA", "PFBS", "PFPeS", "PFHxS_T", "PFHpS", "PFNS", "PFDS",
  "X4_2.FTS", "X6_2_FTS", "X8_2.FTS", "N.MeFOSAA", "N.EtFOSAA", "FOSA"
)

mdls_naive_vehicle <- c(
  PFOS = 0.284, PFOA = 0.219, PFBA = 0.146, PFPeA = 0.231, PFHxA = 0.168,
  PFHpA = 0.096, PFNA = 0.123, PFDA = 0.130, PFUdA = 0.124, PFDoA = 0.131,
  PFTrDA = 0.103, PFTeDA = 0.101, PFBS = 0.134, PFPeS = 0.161, PFHxS_T = 0.188,
  PFHpS = 0.170, PFNS = 0.227, PFDS = 0.242, `X4_2.FTS` = 0.175, `X6_2_FTS` = 0.250,
  `X8_2.FTS` = 0.271, `N.MeFOSAA` = NA, `N.EtFOSAA` = NA, FOSA = NA
)


mdls_dose_0166_05 <- c(
  PFOS = 0.046, PFOA = 0.031, PFBA = 0.016, PFPeA = 0.017, PFHxA = 0.023,
  PFHpA = 0.009, PFNA = 0.031, PFDA = 0.041, PFUdA = 0.015, PFDoA = 0.023,
  PFTrDA = 0.021, PFTeDA = 0.022, PFBS = 0.030, PFPeS = 0.051, PFHxS_T = 0.031,
  PFHpS = 0.037, PFNS = 0.033, PFDS = 0.052, `X4_2.FTS` = 0.015, `X6_2_FTS` = 0.055,
  `X8_2.FTS` = 0.054, `N.MeFOSAA` = 0.058, `N.EtFOSAA` = 0.034, FOSA = 0.021
)


mdls_dose_1_15 <-  c(
  PFOS = 0.230, PFOA = 0.156, PFBA = 0.078, PFPeA = 0.085, PFHxA = 0.115,
  PFHpA = 0.047, PFNA = 0.153, PFDA = 0.206, PFUdA = 0.074, PFDoA = 0.115,
  PFTrDA = 0.105, PFTeDA = 0.112, PFBS = 0.150, PFPeS = 0.253, PFHxS_T = 0.155,
  PFHpS = 0.186, PFNS = 0.164, PFDS = 0.262, `X4_2.FTS` = 0.074, `X6_2_FTS` = 0.276,
  `X8_2.FTS` = 0.271, `N.MeFOSAA` = 0.291, `N.EtFOSAA` = 0.171, FOSA = 0.103
)

mdls_df <- bind_rows(
  tibble(Group = "Naive", !!!mdls_naive_vehicle),
  tibble(Group = "Vehicle", !!!mdls_naive_vehicle),
  tibble(Group = "0.166", !!!mdls_dose_0166_05),
  tibble(Group = "0.5", !!!mdls_dose_0166_05),
  tibble(Group = "1", !!!mdls_dose_1_15),
  tibble(Group = "1.5", !!!mdls_dose_1_15)
) %>%
  pivot_longer(
    -Group,
    names_to = "PFAS",
    values_to = "MDL"
  )

pfas_cols <- mdls_df$PFAS %>% unique()
data_conc[pfas_cols] <- lapply(data_conc[pfas_cols], as.character)

for (pfas_name in unique(mdls_df$PFAS)) {
  if (pfas_name %in% colnames(data_conc)) {
    for (dose_level in unique(mdls_df$Group)) {
      mdl_val <- mdls_df %>%
        filter(PFAS == pfas_name, Group == dose_level) %>%
        pull(MDL)

      if (length(mdl_val) == 1 && !is.na(mdl_val)) {
        dose_match <- trimws(gsub("^.*\\s", "", data_conc$Group))
        idx <- which(dose_match == dose_level & data_conc[[pfas_name]] == "<MDL")

        if (length(idx) > 0) {
          data_conc[idx, pfas_name] <- mdl_val / 2
        }
      }
    }
  }
}

pfas_cols <- unique(mdls_df$PFAS)
data_conc[pfas_cols] <- lapply(data_conc[pfas_cols], as.numeric)


data_conc[data_conc$Group %in% c("Naive", "Vehicle"), pfas_cols] <-
  data_conc[data_conc$Group %in% c("Naive", "Vehicle"), pfas_cols] / 1000
pfas_cols <- unique(mdls_df$PFAS)

data_conc_subset <- data_conc %>%
  dplyr::select(Mouse.ID, Sex, Group, all_of(pfas_cols))

#write.csv(data_conc, file = "../invivo-pfas-immunotox/R input 56d/Plasma_PFAS_values_fixed_56d.csv", row.names = FALSE)

other_pfas <- setdiff(pfas_cols, c("PFOS", "PFOA"))
plasma_colors <- viridis(length(other_pfas), option = "plasma")
names(plasma_colors) <- other_pfas

custom_colors <- c(
  "PFOS" = "red",   
  "PFOA" = "blue",   
  plasma_colors          
)

group_levels <- c(
  "Naive", "Vehicle",
  paste("PFOS", c("0.166", "0.5", "1", "1.5")),
  paste("PFOA", c("0.166", "0.5", "1", "1.5"))
)

data_combined_long <- data_conc %>%
  pivot_longer(
    cols = all_of(pfas_cols),
    names_to = "PFAS_name",
    values_to = "PFAS_conc"
  ) %>%
  filter(!is.na(PFAS_conc)) %>%
  mutate(
    PFAS_conc = as.numeric(PFAS_conc),
    group = factor(Group, levels = group_levels),
    PFAS_name = factor(PFAS_name, levels = names(custom_colors)) 
  )

average_pfas <- data_conc %>%
  group_by(Group) %>%
  summarise(
    Mean_PFOS = format(mean(PFOS, na.rm = TRUE), scientific = FALSE),
    Mean_PFOA = format(mean(PFOA, na.rm = TRUE), scientific = FALSE),
    .groups = "drop"
  )

print(average_pfas)
# Plot
p <-ggplot(data_combined_long, aes(x = group, y = PFAS_conc, color =  PFAS_name, shape= Sex)) +
    geom_jitter(alpha = 0.7, size = 2.2, width = 0.2, height = 0) +
  scale_color_manual(values = custom_colors) +
  labs(
    x = "Group",
    y = "Liver PFAS concentration (mg/kg)",
    color = "PFAS"
  ) +
  coord_cartesian(ylim = c(0, 300)) +  
  theme_minimal() +
  theme(
        text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "none",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank()
  )
print(p)
ggsave(filename = "../invivo-pfas-immunotox/R input 56d/plots/plasma_conc.png", plot = p, width = 12.5, height = 5, dpi = 300,bg = "white")
replicate_summary <- data_conc%>%
  group_by(Group) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```

#Body weight
```{r}
data_bw <- read.csv("../invivo-pfas-immunotox/R input 56d/Body weight.csv")

data_bw <- data_bw %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"), paste("control", group), group)) %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

data_bw$Dose <- factor(data_bw$Dose, levels = c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5"))

controls <- data_bw %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  dplyr::slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_bw <- data_bw %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls) %>%
  filter(PFAS %in% c("PFOS", "PFOA")) %>%
  mutate(across(matches("^Baseline$|^Week[0-9]+$"), as.numeric))

data_bw <- data_bw %>%
  pivot_longer(cols = -c(Sample., Sex, group, PFAS, Dose),
               names_to = "Marker", values_to = "Value") %>%
  filter(!is.na(Value)) %>%
  mutate(Value = as.numeric(Value),
         Marker = factor(Marker, levels = c("Baseline", paste0("Week", 1:8))))

data_bw <- data_bw %>%
  group_by(Sample.) %>%
  mutate(Change_from_baseline = Value - Value[Marker == "Baseline"]) %>%
  ungroup()

data_bw <- data_bw %>%
  mutate(DoseSex = case_when(
    Sex == "Male" & Dose == "Vehicle" ~ "Vehicle",
    Sex == "Male" & Dose %in% c("0.166", "0.5", "1", "1.5") ~ "HighM",
    Sex == "Female" & Dose == "Vehicle" ~ "Vehicle",
    Sex == "Female" & Dose %in% c("0.166", "0.5", "1", "1.5") ~ "HighF",
    TRUE ~ as.character(Dose)
  ))

# Function for Kruskal-Wallis and Dunn's test
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      subset_data <- data %>% filter(PFAS == chem, Marker == marker)
      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
      pairwise_results <- dunn_result$res %>%
        filter(str_detect(Comparison, "Vehicle")) %>%
        mutate(
          group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
          group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
          significance = case_when(
            P.adj < 0.001 ~ "***",
            P.adj < 0.01 ~ "**",
            P.adj < 0.05 ~ "*",
            P.adj >= 0.05 & P.adj < 0.099 ~ ".",
            TRUE ~ "ns"
          ),
          PFAS = chem,
          Marker = marker,
          Sex = sex_label
        )
      if (nrow(pairwise_results) > 0) {
        max_y <- max(subset_data$Value, na.rm = TRUE)
        pairwise_results <- pairwise_results %>%
          mutate(y.position = max_y + (row_number() - 1) * 2 + 20)
        results[[paste(sex_label, chem, marker, sep = "_")]] <- pairwise_results
      }
    }
  }
  bind_rows(results)
}


data_female <- data_bw %>% filter(Sex == "Female")
data_male <- data_bw %>% filter(Sex == "Male")

sig_female_pfos <- get_significance_non_parametric(data_female %>% filter(PFAS == "PFOS"), "Female")
sig_female_pfoa <- get_significance_non_parametric(data_female %>% filter(PFAS == "PFOA"), "Female")
sig_male_pfos   <- get_significance_non_parametric(data_male %>% filter(PFAS == "PFOS"), "Male")
sig_male_pfoa   <- get_significance_non_parametric(data_male %>% filter(PFAS == "PFOA"), "Male")

significance_df_non_parametric <- bind_rows(
  sig_female_pfos, sig_female_pfoa, sig_male_pfos, sig_male_pfoa
)
print(significance_df_non_parametric)

summary_stats <- data_bw %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(
    median = median(Change_from_baseline, na.rm = TRUE),
    Q1 = quantile(Change_from_baseline, 0.25, na.rm = TRUE),
    Q3 = quantile(Change_from_baseline, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    DoseSex = paste0(Dose, "_", substr(Sex, 1, 1)),
    lower = Q1,
    upper = Q3
  )

female_colors <- c(
  "Naive"   = "#fee2e2",
"Vehicle" = "black",
"0.166"   = "#fecaca",
"0.5"     = "#fca5a5",
"1"       = "#f87171",
"1.5"     = "#e53e3e"
)

male_colors <- c(
  "Naive"   = "#eff6ff",
"Vehicle" = "black",
"0.166"   = "#bfdbfe",
"0.5"     = "#93c5fd",
"1"       = "#60a5fa",
"1.5"     = "#3b82f6"
)


dose_levels <- names(female_colors)

dose_sex_colors <- c(
  setNames(female_colors, paste0(dose_levels, "_F")),
  setNames(male_colors, paste0(dose_levels, "_M"))
)

p <- ggplot(summary_stats, aes(x = Marker, y = median, group = DoseSex, color = DoseSex)) +
  geom_line(size = 1, linetype = "solid") +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  facet_wrap(Sex ~ PFAS, scales = "free_y") +
  scale_color_manual(values = dose_sex_colors) +
  labs(
    title = "Median Body Weight Change Over Time (± IQR)",
    x = "Week",
    y = "body weight (g)"
  ) +
  coord_cartesian(ylim = c(-5, 5)) + 
  theme_minimal() +
  theme(
        text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "none",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank()
  )

print(p)
ggsave(filename = "../invivo-pfas-immunotox/R input 56d/plots/body_weight.png", plot = p, width = 9, height = 5, dpi = 300, bg = "white")
ggsave(filename = "../invivo-pfas-immunotox/R input 28d/plots/body_weight.png", plot = p, width = 7, height = 5, dpi = 300, bg = "white")
replicate_summary <- data_bw%>%
  group_by(Dose, PFAS, Sex, Marker) %>%  
  summarise(n = n(), .groups = "drop")

min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```

