#Load libraries
```{r}
library(readxl)
library(forcats) 
library(tidyr)  
library(dplyr)  
library(ggsignif)
library(ggplot2)
library(broom) 
library(rstatix)
library(ggpubr)
library(stringr)
library(viridis)
library(emmeans)
library(purrr)
library(car)
library(extrafont)
library(plotrix)
library(FSA)  # for dunnTest
library(ggpubr)  # optionally for stat_pvalue_manual
```

#Spleen stats and plot
```{r}
#Read in df
data_spleen <- read.csv("../invivo-pfas-immunotox/Flow Results Spleen.csv")
colnames(data_spleen)
#data_spleen <- data_spleen[ , !(names(data_spleen) %in% c("CD25..CD4", "DN.T.Cells"))]

#Pre-process
data_spleen <- data_spleen %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_spleen <- data_spleen %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

#Duplicate Naive and Vehicle for statistics
controls <- data_spleen %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

#Making the the PFAS groups correct
data_spleen <- data_spleen %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_spleen <- data_spleen %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose),
    names_to = "Marker",
    values_to = "Value"
  )

#Removing NAs
data_spleen <- data_spleen %>% filter(!is.na(Value))
#Just making sure everything is numeric
data_spleen$Value <- as.numeric(data_spleen$Value)
#Filter out females
data_female <- data_spleen %>% filter(Sex == "Female")
#Filter out males
data_male <- data_spleen %>% filter(Sex == "Male")
# Function to run Kruskal-Wallis + Dunn's Test and return pairwise comparisons
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      # Run Kruskal-Wallis Test
      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

      # Add this line to check that p.value is not NA
if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

        # Run Dunn's Test
        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        # Filter for comparisons involving "Vehicle"
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        # Add y-position for plotting
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

#Run for both sexes
sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
#Combine all pairwise comparisons
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)

unique_markers <- unique(data_spleen$Marker)

for (m in unique(data_spleen$Marker)) {

plot_data <- data_spleen %>%
    filter(Marker == m) %>%
    filter(!(Dose %in% c("Naive", "Vehicle") & PFAS == "PFOA"))

plot_data <- plot_data %>%
    mutate(PFAS_Dose = case_when(
    Dose %in% c("Naive", "Vehicle") ~ Dose,
    TRUE ~ paste(PFAS, Dose)))

plot_data$PFAS_Dose <- factor(plot_data$PFAS_Dose,levels = c( "Naive", "Vehicle","PFOS 0.166", "PFOS 0.5", "PFOS 1", "PFOS 1.5", "PFOA 0.166", "PFOA 0.5", "PFOA 1", "PFOA 1.5"))
 
label_map <- c("Naive" = "Naive", "Vehicle" = "Vehicle", "PFOS 0.166" = "0.166 mg/kg/day", "PFOS 0.5" = "0.5 mg/kg/day", "PFOS 1" = "1 mg/kg/day", "PFOS 1.5" = "1.5 mg/kg/day", "PFOA 0.166" = "0.166 mg/kg/day", "PFOA 0.5" = "0.5 mg/kg/day", "PFOA 1" = "1 mg/kg/day", "PFOA 1.5" = "1.5 mg/kg/day")

sig_data <- significance_df_non_parametric %>%
    filter(Marker == m) %>%
    mutate(group1 = case_when(
      group1 %in% c("Naive", "Vehicle") ~ group1,
      TRUE ~ paste(PFAS, group1)))

y_max <- max(plot_data$Value, na.rm = TRUE)

if (nrow(sig_data) > 0) {
  sig_data$y.position <- ifelse(
    sig_data$Sex == "Female",
    y_max * 1.02,  # Female stars 2% above max
    y_max * 1.05   # Male stars 5% above max
  )
}
  plot <- ggplot(plot_data, aes(x = PFAS_Dose, y = Value, color = Sex)) +
    geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
    geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
                alpha = 0.7, size = 1.5) +
    scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
    scale_x_discrete(labels = label_map) +
    labs(x = NULL, y = NULL, title = paste("Marker:", m)) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA)
    )

  if (nrow(sig_data) > 0) {
    plot <- plot + geom_text(
      data = sig_data,
      aes(x = group1, y = y.position, label = significance),
      color = ifelse(sig_data$Sex == "Female", "red", "blue"),
      inherit.aes = FALSE,
      size = 6,
      position = position_dodge(width = 0.75)
    )
  }

  plot <- plot +
    labs(caption = "                PFOS                               PFOA") +
    theme(
      plot.caption = element_text(hjust = 0.5, face = "bold", size = 10),
      plot.margin = margin(t = 10, r = 10, b = 40, l = 10)
    )

#ggsave(filename = paste0("plots/spleen_boxplot_", gsub(" ", "_", m), ".png"),plot = plot,width = 8, height = 6,dpi = 300,bg = "white")

  print(plot)
}

##########################################################################################################################
#Normalize 
data_spleen <- data_spleen %>%
  group_by(Sex, PFAS, Marker) %>%
  mutate(vehicle_median = median(Value[Dose == "Vehicle"], na.rm = TRUE),
         normalized = Value / vehicle_median,
         percent_of_vehicle = (Value / vehicle_median) * 100) %>%
  ungroup()
data_female <- data_spleen %>% filter(Sex == "Female")
data_male <- data_spleen %>% filter(Sex == "Male")

# Function to run Kruskal-Wallis + Dunn's Test and return pairwise comparisons
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      # Run Kruskal-Wallis Test
      kw_test <- kruskal.test(normalized ~ Dose, data = subset_data)

      if (kw_test$p.value < 0.05) {
        # Run Dunn's Test
        dunn_result <- dunnTest(normalized ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        # Filter for comparisons involving "Vehicle"
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        # Add y-position for plotting
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$normalized, na.rm = TRUE)
          increment <- max_y * 0.1
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + 10)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

#Run for both sexes (Non-parametric)
sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
#Combine all pairwise comparisons
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)

for (m in unique(data_spleen$Marker)) {
  plot_data <- data_spleen %>%
    filter(Marker == m) %>%
    filter(!(Dose %in% c("Naive", "Vehicle") & PFAS == "PFOA"))

plot_data <- plot_data %>%
    mutate(PFAS_Dose = case_when(
      Dose %in% c("Naive", "Vehicle") ~ Dose,
      TRUE ~ paste(PFAS, Dose)))

plot_data$PFAS_Dose <- factor(
    plot_data$PFAS_Dose,
    levels = c( "Naive", "Vehicle","PFOS 0.166", "PFOS 0.5", "PFOS 1", "PFOS 1.5", "PFOA 0.166", "PFOA 0.5", "PFOA 1", "PFOA 1.5"))
 
label_map <- c("Naive" = "Naive", "Vehicle" = "Vehicle", "PFOS 0.166" = "0.166 mg/kg/day", "PFOS 0.5" = "0.5 mg/kg/day", "PFOS 1" = "1 mg/kg/day", "PFOS 1.5" = "1.5 mg/kg/day", "PFOA 0.166" = "0.166 mg/kg/day", "PFOA 0.5" = "0.5 mg/kg/day", "PFOA 1" = "1 mg/kg/day", "PFOA 1.5" = "1.5 mg/kg/day")

sig_data <- significance_df_non_parametric %>%
    filter(Marker == m) %>%
    mutate(group1 = case_when(
      group1 %in% c("Naive", "Vehicle") ~ group1,
      TRUE ~ paste(PFAS, group1)))

y_max <- max(plot_data$normalized, na.rm = TRUE)

if (nrow(sig_data) > 0) {
  sig_data$y.position <- ifelse(
    sig_data$Sex == "Female",
    y_max * 1.02,  # Female stars 2% above max
    y_max * 1.05   # Male stars 5% above max
  )
}
 norm_plot <- ggplot(plot_data, aes(x = PFAS_Dose, y = normalized, color = Sex)) +
    geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
    geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
                alpha = 0.7, size = 1.5) +
    scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
    scale_x_discrete(labels = label_map) +
    labs(x = NULL, y = "Normalized", title = paste("Marker:", m)) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA)
    )

  if (nrow(sig_data) > 0) {
    norm_plot <- norm_plot + geom_text(
      data = sig_data,
      aes(x = group1, y = y.position, label = significance),
      color = ifelse(sig_data$Sex == "Female", "red", "blue"),
      inherit.aes = FALSE,
      size = 6,
      position = position_dodge(width = 0.75)
    )
  }

  norm_plot <- norm_plot +
    labs(caption = "                PFOS                               PFOA") +
    theme(
      plot.caption = element_text(hjust = 0.5, face = "bold", size = 10),
      plot.margin = margin(t = 10, r = 10, b = 40, l = 10)
    )

#ggsave(filename = paste0("plots/spleen_boxplot_norm_", gsub(" ", "_", m), ".png"),plot = norm_plot,width = 8, height = 6,dpi = 300,bg = "white")

  print(norm_plot)
}

##########################################################################################################################
#Heatmap
sig_for_heatmap <- significance_df_non_parametric %>%
  mutate(
    Dose = str_remove(group1, ".* "),  # gets just the dose part like "0.166"
    Dose = ifelse(group1 %in% c("Naive", "Vehicle"), group1, Dose),
    Marker = as.character(Marker)  # ensure type consistency
  ) %>%
  select(Sex, PFAS, Marker, Dose, significance)
heatmap_data <- data_spleen %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(median_norm = median(normalized, na.rm = TRUE), .groups = "drop")
heatmap_with_sig <- heatmap_data %>%
  left_join(sig_for_heatmap, by = c("Sex", "PFAS", "Marker", "Dose"))

heatmap_with_sig$Marker <- factor(heatmap_with_sig$Marker, levels = c("B.Cells","B220..F4.80.","B220.macs","CD4.CD25.CD69.ve","CD4.CD69","CD4.DP","CD4.T.cells","CD4.DCs","CD8","CD8.CD69","CD8dcs","DCs","NK","T.cells"))
heatmap_with_sig$Dose <- factor(heatmap_with_sig$Dose, levels = c( "1.5", "1", "0.5", "0.166","Vehicle", "Naive"))
colnames(data_spleen)
                                  
heatmap_spleen <- ggplot(heatmap_with_sig, aes(x = Marker, y = Dose, fill = median_norm)) +
  geom_tile(color = "black", size = 0.4) +
  geom_text(aes(label = round(median_norm, 2)), size = 2.5, color = "black") +
  #geom_text(aes(label = significance), vjust = 0.4, size = 6, color = "black", fontface = "bold") +
  scale_fill_gradient2(
    low = "#330597", mid = "white", high = "red", midpoint = 1,
    name = "Normalized\nMedian", limits = c(0, 3),  oob = scales::squish 
  ) +
  facet_grid(Sex ~ PFAS) +
scale_x_discrete(position = "top") + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_size = 11) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 0),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    strip.text = element_text(face = "bold"))
#Print
ggsave(filename = "plots/spleen_heatmap.png", plot = heatmap_spleen, width = 7, height = 5, dpi = 300,bg = "white")
print(heatmap_spleen)

##########################################################################################################################
#Dose-response curve
#Define PFAS order and dose order
custom_colors <- c("#0d0887","#330597","#5102a3","#6e00a8","#8707a6","#a01a9c","#b537b5","#d7566c","#e56b5d","#f1814d","#f9983e","#fdb22f","#fcce25","#fde92c"
)

pfas_order <- c("PFOS", "PFOA")
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
marker_levels <- c("B.Cells","B220..F4.80.","B220.macs","CD4.CD25.CD69.ve","CD4.CD69","CD4.DP","CD4.T.cells","CD4.DCs","CD8","CD8.CD69","CD8dcs","DCs","NK","T.cells")

#Factor levels
data_spleen$PFAS <- factor(data_spleen$PFAS, levels = pfas_order)
data_spleen$Dose <- factor(data_spleen$Dose, levels = dose_levels)
data_spleen$Marker <- factor(data_spleen$Marker, levels = marker_levels)

#Compute summary stats with Sex
mean_data <- data_spleen %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(
    mean_stat = median(normalized, na.rm = TRUE),
    se_stat = std.error(normalized) * 2.365,  # 95% CI
    .groups = "drop"
  ) %>%
  mutate(
    Chemical = PFAS,
    significance = NA_character_,
    y_position_label = mean_stat + se_stat + 1,
    Dose_factor = Dose)

#Join significance annotations
mean_data <- mean_data %>%
  left_join(
    significance_df_non_parametric %>%
      select(PFAS, Marker, group1, significance) %>%
      rename(Dose = group1),
    by = c("PFAS", "Marker", "Dose")
  ) %>%
  mutate(
    y_position_label = mean_stat + se_stat + 1)
mean_data <- mean_data %>%
  mutate(
    Marker = factor(Marker, levels = marker_levels),
    Dose_factor = factor(Dose_factor, levels = dose_levels)
  )
#Split by sex
data_spleen_male <- data_spleen %>% filter(Sex == "Male")
data_spleen_female <- data_spleen%>% filter(Sex == "Female")
mean_data_male <- mean_data %>% filter(Sex == "Male")
mean_data_female <- mean_data %>% filter(Sex == "Female")

#Plot
make_plot_by_sex <- function(data, summary, sex_label) {
  ggplot() +
    geom_jitter(
      data = data,
      aes(x = Dose, y = normalized, color = Marker),
      size = 1, alpha = 0.4, width = 0.2
    ) +
    geom_line(
      data = summary,
      aes(x = Dose_factor, y = mean_stat, group = interaction(Marker, PFAS), color = Marker),
      size = 0.8
    ) +
    geom_errorbar(
      data = summary,
      aes(x = Dose_factor, ymin = mean_stat - se_stat, ymax = mean_stat + se_stat, color = Marker),
      width = 0.5
    ) +
    geom_hline(yintercept = 1, linetype = "dotted", size = 1, alpha = 0.4) +
   # geom_text(
   #   data = summary[!is.na(summary$significance.y), ],
   #   aes(x = Dose_factor, y = y_position_label, label = significance.y, color = Marker),
   #   size = 6,
   #   show.legend = FALSE
   # ) +
    facet_grid(PFAS ~ Marker, scales = "free") +
    scale_color_manual(values = custom_colors) +
    labs(
      title = paste("Normalized Response -", sex_label),
      x = NULL,
      y = NULL,
      color = "Marker"
    ) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "bottom",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank()
    )
}

#Print plots
plot_male <- make_plot_by_sex(data_spleen_male, mean_data_male, "Male")
plot_female <- make_plot_by_sex(data_spleen_female, mean_data_female, "Female")
print(plot_male)
ggsave(filename = "plots/spleen_dr_male.png", plot = plot_male, width = 7, height = 5, dpi = 300,bg = "white")
print(plot_female)
ggsave(filename = "plots/spleen_dr_feamle.png", plot = plot_female, width = 7, height = 5, dpi = 300,bg = "white")
```
#Blood stats and plot
```{r}
#Read in df
data_blood <- read.csv("../invivo-pfas-immunotox/Blood_flow.csv")
data_blood <- data_blood[ , !(names(data_blood) %in% c("CD25..CD4", "DN.T.Cells"))]
data_blood <- data_blood[ , !(names(data_blood) %in% c("DN.DP", "DN.CD3"))]

#Pre-process
data_blood <- data_blood %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_blood <- data_blood %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

#Duplicate Naive and Vehicle for statistics
controls <- data_blood %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

#Making the the PFAS groups correct
data_blood <- data_blood %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_blood <- data_blood %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose, Organ, Phase),
    names_to = "Marker",
    values_to = "Value"
  )

#Removing NAs
data_blood <- data_blood %>% filter(!is.na(Value))
#Just making sure everything is numeric
data_blood$Value <- as.numeric(data_blood$Value)
#Filter out females
data_female <- data_blood %>% filter(Sex == "Female")
#Filter out males
data_male <- data_blood %>% filter(Sex == "Male")
# Function to run Kruskal-Wallis + Dunn's Test and return pairwise comparisons
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      # Run Kruskal-Wallis Test
      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

      # Add this line to check that p.value is not NA
if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

        # Run Dunn's Test
        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        # Filter for comparisons involving "Vehicle"
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        # Add y-position for plotting
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

#Run for both sexes
sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
#Combine all pairwise comparisons
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)

unique_markers <- unique(data_blood$Marker)

for (m in unique(data_blood$Marker)) {

plot_data <- data_blood %>%
    filter(Marker == m) %>%
    filter(!(Dose %in% c("Naive", "Vehicle") & PFAS == "PFOA"))

plot_data <- plot_data %>%
    mutate(PFAS_Dose = case_when(
    Dose %in% c("Naive", "Vehicle") ~ Dose,
    TRUE ~ paste(PFAS, Dose)))

plot_data$PFAS_Dose <- factor(plot_data$PFAS_Dose,levels = c( "Naive", "Vehicle","PFOS 0.166", "PFOS 0.5", "PFOS 1", "PFOS 1.5", "PFOA 0.166", "PFOA 0.5", "PFOA 1", "PFOA 1.5"))
 
label_map <- c("Naive" = "Naive", "Vehicle" = "Vehicle", "PFOS 0.166" = "0.166 mg/kg/day", "PFOS 0.5" = "0.5 mg/kg/day", "PFOS 1" = "1 mg/kg/day", "PFOS 1.5" = "1.5 mg/kg/day", "PFOA 0.166" = "0.166 mg/kg/day", "PFOA 0.5" = "0.5 mg/kg/day", "PFOA 1" = "1 mg/kg/day", "PFOA 1.5" = "1.5 mg/kg/day")

sig_data <- significance_df_non_parametric %>%
    filter(Marker == m) %>%
    mutate(group1 = case_when(
      group1 %in% c("Naive", "Vehicle") ~ group1,
      TRUE ~ paste(PFAS, group1)))

y_max <- max(plot_data$Value, na.rm = TRUE)

if (nrow(sig_data) > 0) {
  sig_data$y.position <- ifelse(
    sig_data$Sex == "Female",
    y_max * 1.02,  # Female stars 2% above max
    y_max * 1.05   # Male stars 5% above max
  )
}
  plot <- ggplot(plot_data, aes(x = PFAS_Dose, y = Value, color = Sex)) +
    geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
    geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
                alpha = 0.7, size = 1.5) +
    scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
    scale_x_discrete(labels = label_map) +
    labs(x = NULL, y = NULL, title = paste("Marker:", m)) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA)
    )

  if (nrow(sig_data) > 0) {
    plot <- plot + geom_text(
      data = sig_data,
      aes(x = group1, y = y.position, label = significance),
      color = ifelse(sig_data$Sex == "Female", "red", "blue"),
      inherit.aes = FALSE,
      size = 6,
      position = position_dodge(width = 0.75)
    )
  }

  plot <- plot +
    labs(caption = "                PFOS                               PFOA") +
    theme(
      plot.caption = element_text(hjust = 0.5, face = "bold", size = 10),
      plot.margin = margin(t = 10, r = 10, b = 40, l = 10)
    )

#ggsave(filename = paste0("plots/blood_boxplot_", gsub(" ", "_", m), ".png"),plot = plot,width = 8, height = 6,dpi = 300,bg = "white")

  print(plot)
}

##########################################################################################################################
#Normalize 
data_blood <- data_blood %>%
  group_by(Sex, PFAS, Marker) %>%
  mutate(vehicle_median = median(Value[Dose == "Vehicle"], na.rm = TRUE),
         normalized = Value / vehicle_median,
         percent_of_vehicle = (Value / vehicle_median) * 100) %>%
  ungroup()
data_female <- data_blood %>% filter(Sex == "Female")
data_male <- data_blood %>% filter(Sex == "Male")

# Function to run Kruskal-Wallis + Dunn's Test and return pairwise comparisons
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      # Run Kruskal-Wallis Test
      kw_test <- kruskal.test(normalized ~ Dose, data = subset_data)

      if (kw_test$p.value < 0.05) {
        # Run Dunn's Test
        dunn_result <- dunnTest(normalized ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        # Filter for comparisons involving "Vehicle"
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        # Add y-position for plotting
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$normalized, na.rm = TRUE)
          increment <- max_y * 0.1
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + 10)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

#Run for both sexes (Non-parametric)
sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
#Combine all pairwise comparisons
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)

for (m in unique(data_blood$Marker)) {
  plot_data <- data_blood %>%
    filter(Marker == m) %>%
    filter(!(Dose %in% c("Naive", "Vehicle") & PFAS == "PFOA"))

plot_data <- plot_data %>%
    mutate(PFAS_Dose = case_when(
      Dose %in% c("Naive", "Vehicle") ~ Dose,
      TRUE ~ paste(PFAS, Dose)))

plot_data$PFAS_Dose <- factor(
    plot_data$PFAS_Dose,
    levels = c( "Naive", "Vehicle","PFOS 0.166", "PFOS 0.5", "PFOS 1", "PFOS 1.5", "PFOA 0.166", "PFOA 0.5", "PFOA 1", "PFOA 1.5"))
 
label_map <- c("Naive" = "Naive", "Vehicle" = "Vehicle", "PFOS 0.166" = "0.166 mg/kg/day", "PFOS 0.5" = "0.5 mg/kg/day", "PFOS 1" = "1 mg/kg/day", "PFOS 1.5" = "1.5 mg/kg/day", "PFOA 0.166" = "0.166 mg/kg/day", "PFOA 0.5" = "0.5 mg/kg/day", "PFOA 1" = "1 mg/kg/day", "PFOA 1.5" = "1.5 mg/kg/day")

sig_data <- significance_df_non_parametric %>%
    filter(Marker == m) %>%
    mutate(group1 = case_when(
      group1 %in% c("Naive", "Vehicle") ~ group1,
      TRUE ~ paste(PFAS, group1)))

y_max <- max(plot_data$normalized, na.rm = TRUE)

if (nrow(sig_data) > 0) {
  sig_data$y.position <- ifelse(
    sig_data$Sex == "Female",
    y_max * 1.02,  # Female stars 2% above max
    y_max * 1.05   # Male stars 5% above max
  )
}
 norm_plot <- ggplot(plot_data, aes(x = PFAS_Dose, y = normalized, color = Sex)) +
    geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
    geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
                alpha = 0.7, size = 1.5) +
    scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
    scale_x_discrete(labels = label_map) +
    labs(x = NULL, y = "Normalized", title = paste("Marker:", m)) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA)
    )

  if (nrow(sig_data) > 0) {
    norm_plot <- norm_plot + geom_text(
      data = sig_data,
      aes(x = group1, y = y.position, label = significance),
      color = ifelse(sig_data$Sex == "Female", "red", "blue"),
      inherit.aes = FALSE,
      size = 6,
      position = position_dodge(width = 0.75)
    )
  }

  norm_plot <- norm_plot +
    labs(caption = "                PFOS                               PFOA") +
    theme(
      plot.caption = element_text(hjust = 0.5, face = "bold", size = 10),
      plot.margin = margin(t = 10, r = 10, b = 40, l = 10)
    )

#ggsave(filename = paste0("plots/blood_boxplot_norm_", gsub(" ", "_", m), ".png"),plot = norm_plot,width = 8, height = 6,dpi = 300,bg = "white")

  print(norm_plot)
}

##########################################################################################################################
#Heatmap
sig_for_heatmap <- significance_df_non_parametric %>%
  mutate(
    Dose = str_remove(group1, ".* "),  # gets just the dose part like "0.166"
    Dose = ifelse(group1 %in% c("Naive", "Vehicle"), group1, Dose),
    Marker = as.character(Marker)  # ensure type consistency
  ) %>%
  select(Sex, PFAS, Marker, Dose, significance)
heatmap_data <- data_blood %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(median_norm = median(normalized, na.rm = TRUE), .groups = "drop")
heatmap_with_sig <- heatmap_data %>%
  left_join(sig_for_heatmap, by = c("Sex", "PFAS", "Marker", "Dose"))

heatmap_with_sig$Marker <- factor(heatmap_with_sig$Marker, levels = c("B.Cells","T.Cells","CD4","CD8","Monocytes"))
heatmap_with_sig$Dose <- factor(heatmap_with_sig$Dose, levels = c( "1.5", "1", "0.5", "0.166","Vehicle", "Naive"))
               
heatmap_blood <- ggplot(heatmap_with_sig, aes(x = Marker, y = Dose, fill = median_norm)) +
  geom_tile(color = "black", size = 0.4) +
  geom_text(aes(label = round(median_norm, 2)), size = 2.5, color = "black") +
  #geom_text(aes(label = significance), vjust = 0.4, size = 6, color = "black", fontface = "bold") +
  scale_fill_gradient2(
    low = "#330597", mid = "white", high = "red", midpoint = 1,
    name = "Normalized\nMedian", limits = c(0, 1.5),  oob = scales::squish 
  ) +
  facet_grid(Sex ~ PFAS) +
scale_x_discrete(position = "top") + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_size = 11) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 0),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    strip.text = element_text(face = "bold"))

#Print
ggsave(filename = "plots/blood_heatmap.png", plot = heatmap_blood, width = 7, height = 5, dpi = 300,bg = "white")
print(heatmap_blood)

##########################################################################################################################
#Dose-response curve
#Define PFAS order and dose order
custom_colors <- c("#0d0887","#6101a6","#bc2981","#f16b37","#fcdf27")

pfas_order <- c("PFOS", "PFOA")
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
marker_levels <- c("B.Cells","T.Cells","CD4","CD8","Monocytes")

#Factor levels
data_blood$PFAS <- factor(data_blood$PFAS, levels = pfas_order)
data_blood$Dose <- factor(data_blood$Dose, levels = dose_levels)
data_blood$Marker <- factor(data_blood$Marker, levels = marker_levels)

#Compute summary stats with Sex
mean_data <- data_blood %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(
    mean_stat = median(normalized, na.rm = TRUE),
    se_stat = std.error(normalized) * 2.365,  # 95% CI
    .groups = "drop"
  ) %>%
  mutate(
    Chemical = PFAS,
    significance = NA_character_,
    y_position_label = mean_stat + se_stat + 1,
    Dose_factor = Dose)

#Join significance annotations
mean_data <- mean_data %>%
  left_join(
    significance_df_non_parametric %>%
      select(PFAS, Marker, group1, significance) %>%
      rename(Dose = group1),
    by = c("PFAS", "Marker", "Dose")
  ) %>%
  mutate(
    y_position_label = mean_stat + se_stat + 1)
mean_data <- mean_data %>%
  mutate(
    Marker = factor(Marker, levels = marker_levels),
    Dose_factor = factor(Dose_factor, levels = dose_levels)
  )
#Split by sex
data_blood_male <- data_blood %>% filter(Sex == "Male")
data_blood_female <- data_blood %>% filter(Sex == "Female")
mean_data_male <- mean_data %>% filter(Sex == "Male")
mean_data_female <- mean_data %>% filter(Sex == "Female")

#Plot
make_plot_by_sex <- function(data, summary, sex_label) {
  ggplot() +
    geom_jitter(
      data = data,
      aes(x = Dose, y = normalized, color = Marker),
      size = 1, alpha = 0.4, width = 0.2
    ) +
    geom_line(
      data = summary,
      aes(x = Dose_factor, y = mean_stat, group = interaction(Marker, PFAS), color = Marker),
      size = 0.8
    ) +
    geom_errorbar(
      data = summary,
      aes(x = Dose_factor, ymin = mean_stat - se_stat, ymax = mean_stat + se_stat, color = Marker),
      width = 0.5
    ) +
    geom_hline(yintercept = 1, linetype = "dotted", size = 1, alpha = 0.4) +
   # geom_text(
   #   data = summary[!is.na(summary$significance.y), ],
   #   aes(x = Dose_factor, y = y_position_label, label = significance.y, color = Marker),
   #   size = 6,
   #   show.legend = FALSE
   # ) +
    facet_grid(PFAS ~ Marker, scales = "free") +
    scale_color_manual(values = custom_colors) +
    labs(
      title = paste("Normalized Response -", sex_label),
      x = NULL,
      y = NULL,
      color = "Marker"
    ) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "bottom",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank()
    )
}

#Print plots
plot_male <- make_plot_by_sex(data_blood_male, mean_data_male, "Male")
plot_female <- make_plot_by_sex(data_blood_female, mean_data_female, "Female")
print(plot_male)
ggsave(filename = "plots/blood_dr_male.png", plot = plot_male, width = 7, height = 5, dpi = 300,bg = "white")
print(plot_female)
ggsave(filename = "plots/blood_dr_feamle.png", plot = plot_female, width = 7, height = 5, dpi = 300,bg = "white")
```

#Thymus stats and plot
```{r}
#Read in df
data_thymus <- read.csv("../invivo-pfas-immunotox/Thymus_flow.csv")
data_thymus <- data_thymus[ , !(names(data_thymus) %in% c("DN.DP", "DN.CD3"))]

#Pre-process
data_thymus <- data_thymus %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_thymus <- data_thymus %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

#Duplicate Naive and Vehicle for statistics
controls <- data_thymus %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

#Making the the PFAS groups correct
data_thymus <- data_thymus %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_thymus <- data_thymus %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose, Phase),
    names_to = "Marker",
    values_to = "Value"
  )

#Removing NAs
data_thymus <- data_thymus %>% filter(!is.na(Value))
#Just making sure everything is numeric
data_thymus$Value <- as.numeric(data_thymus$Value)
#Filter out females
data_female <- data_thymus %>% filter(Sex == "Female")
#Filter out males
data_male <- data_thymus %>% filter(Sex == "Male")
# Function to run Kruskal-Wallis + Dunn's Test and return pairwise comparisons
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      # Run Kruskal-Wallis Test
      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

      # Add this line to check that p.value is not NA
if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

        # Run Dunn's Test
        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        # Filter for comparisons involving "Vehicle"
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        # Add y-position for plotting
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

#Run for both sexes
sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
#Combine all pairwise comparisons
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)

unique_markers <- unique(data_thymus$Marker)

for (m in unique(data_thymus$Marker)) {

plot_data <- data_thymus %>%
    filter(Marker == m) %>%
    filter(!(Dose %in% c("Naive", "Vehicle") & PFAS == "PFOA"))

plot_data <- plot_data %>%
    mutate(PFAS_Dose = case_when(
    Dose %in% c("Naive", "Vehicle") ~ Dose,
    TRUE ~ paste(PFAS, Dose)))

plot_data$PFAS_Dose <- factor(plot_data$PFAS_Dose,levels = c( "Naive", "Vehicle","PFOS 0.166", "PFOS 0.5", "PFOS 1", "PFOS 1.5", "PFOA 0.166", "PFOA 0.5", "PFOA 1", "PFOA 1.5"))
 
label_map <- c("Naive" = "Naive", "Vehicle" = "Vehicle", "PFOS 0.166" = "0.166 mg/kg/day", "PFOS 0.5" = "0.5 mg/kg/day", "PFOS 1" = "1 mg/kg/day", "PFOS 1.5" = "1.5 mg/kg/day", "PFOA 0.166" = "0.166 mg/kg/day", "PFOA 0.5" = "0.5 mg/kg/day", "PFOA 1" = "1 mg/kg/day", "PFOA 1.5" = "1.5 mg/kg/day")

sig_data <- significance_df_non_parametric %>%
    filter(Marker == m) %>%
    mutate(group1 = case_when(
      group1 %in% c("Naive", "Vehicle") ~ group1,
      TRUE ~ paste(PFAS, group1)))

y_max <- max(plot_data$Value, na.rm = TRUE)

if (nrow(sig_data) > 0) {
  sig_data$y.position <- ifelse(
    sig_data$Sex == "Female",
    y_max * 1.02,  # Female stars 2% above max
    y_max * 1.05   # Male stars 5% above max
  )
}
  plot <- ggplot(plot_data, aes(x = PFAS_Dose, y = Value, color = Sex)) +
    geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
    geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
                alpha = 0.7, size = 1.5) +
    scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
    scale_x_discrete(labels = label_map) +
    labs(x = NULL, y = NULL, title = paste("Marker:", m)) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA)
    )

  if (nrow(sig_data) > 0) {
    plot <- plot + geom_text(
      data = sig_data,
      aes(x = group1, y = y.position, label = significance),
      color = ifelse(sig_data$Sex == "Female", "red", "blue"),
      inherit.aes = FALSE,
      size = 6,
      position = position_dodge(width = 0.75)
    )
  }

  plot <- plot +
    labs(caption = "                PFOS                               PFOA") +
    theme(
      plot.caption = element_text(hjust = 0.5, face = "bold", size = 10),
      plot.margin = margin(t = 10, r = 10, b = 40, l = 10)
    )

#ggsave(filename = paste0("plots/thymus_boxplot_", gsub(" ", "_", m), ".png"),plot = plot,width = 8, height = 6,dpi = 300,bg = "white")

  print(plot)
}

##########################################################################################################################
#Normalize 
data_thymus <- data_thymus %>%
  group_by(Sex, PFAS, Marker) %>%
  mutate(vehicle_median = median(Value[Dose == "Vehicle"], na.rm = TRUE),
         normalized = Value / vehicle_median,
         percent_of_vehicle = (Value / vehicle_median) * 100) %>%
  ungroup()
data_female <- data_thymus %>% filter(Sex == "Female")
data_male <- data_thymus %>% filter(Sex == "Male")

# Function to run Kruskal-Wallis + Dunn's Test and return pairwise comparisons
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      # Run Kruskal-Wallis Test
      kw_test <- kruskal.test(normalized ~ Dose, data = subset_data)

      if (kw_test$p.value < 0.05) {
        # Run Dunn's Test
        dunn_result <- dunnTest(normalized ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        # Filter for comparisons involving "Vehicle"
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        # Add y-position for plotting
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$normalized, na.rm = TRUE)
          increment <- max_y * 0.1
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + 10)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

#Run for both sexes (Non-parametric)
sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
#Combine all pairwise comparisons
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)

for (m in unique(data_thymus$Marker)) {
  plot_data <- data_thymus %>%
    filter(Marker == m) %>%
    filter(!(Dose %in% c("Naive", "Vehicle") & PFAS == "PFOA"))

plot_data <- plot_data %>%
    mutate(PFAS_Dose = case_when(
      Dose %in% c("Naive", "Vehicle") ~ Dose,
      TRUE ~ paste(PFAS, Dose)))

plot_data$PFAS_Dose <- factor(
    plot_data$PFAS_Dose,
    levels = c( "Naive", "Vehicle","PFOS 0.166", "PFOS 0.5", "PFOS 1", "PFOS 1.5", "PFOA 0.166", "PFOA 0.5", "PFOA 1", "PFOA 1.5"))
 
label_map <- c("Naive" = "Naive", "Vehicle" = "Vehicle", "PFOS 0.166" = "0.166 mg/kg/day", "PFOS 0.5" = "0.5 mg/kg/day", "PFOS 1" = "1 mg/kg/day", "PFOS 1.5" = "1.5 mg/kg/day", "PFOA 0.166" = "0.166 mg/kg/day", "PFOA 0.5" = "0.5 mg/kg/day", "PFOA 1" = "1 mg/kg/day", "PFOA 1.5" = "1.5 mg/kg/day")

sig_data <- significance_df_non_parametric %>%
    filter(Marker == m) %>%
    mutate(group1 = case_when(
      group1 %in% c("Naive", "Vehicle") ~ group1,
      TRUE ~ paste(PFAS, group1)))

y_max <- max(plot_data$normalized, na.rm = TRUE)

if (nrow(sig_data) > 0) {
  sig_data$y.position <- ifelse(
    sig_data$Sex == "Female",
    y_max * 1.02,  # Female stars 2% above max
    y_max * 1.05   # Male stars 5% above max
  )
}
 norm_plot <- ggplot(plot_data, aes(x = PFAS_Dose, y = normalized, color = Sex)) +
    geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
    geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
                alpha = 0.7, size = 1.5) +
    scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
    scale_x_discrete(labels = label_map) +
    labs(x = NULL, y = "Normalized", title = paste("Marker:", m)) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA)
    )

  if (nrow(sig_data) > 0) {
    norm_plot <- norm_plot + geom_text(
      data = sig_data,
      aes(x = group1, y = y.position, label = significance),
      color = ifelse(sig_data$Sex == "Female", "red", "blue"),
      inherit.aes = FALSE,
      size = 6,
      position = position_dodge(width = 0.75)
    )
  }

  norm_plot <- norm_plot +
    labs(caption = "                PFOS                               PFOA") +
    theme(
      plot.caption = element_text(hjust = 0.5, face = "bold", size = 10),
      plot.margin = margin(t = 10, r = 10, b = 40, l = 10)
    )

#ggsave(filename = paste0("plots/thymus_boxplot_norm_", gsub(" ", "_", m), ".png"),plot = norm_plot,width = 8, height = 6,dpi = 300,bg = "white")

  print(norm_plot)
}

##########################################################################################################################
#Heatmap
sig_for_heatmap <- significance_df_non_parametric %>%
  mutate(
    Dose = str_remove(group1, ".* "),  # gets just the dose part like "0.166"
    Dose = ifelse(group1 %in% c("Naive", "Vehicle"), group1, Dose),
    Marker = as.character(Marker)  # ensure type consistency
  ) %>%
  select(Sex, PFAS, Marker, Dose, significance)
heatmap_data <- data_thymus %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(median_norm = median(normalized, na.rm = TRUE), .groups = "drop")
heatmap_with_sig <- heatmap_data %>%
  left_join(sig_for_heatmap, by = c("Sex", "PFAS", "Marker", "Dose"))

heatmap_with_sig$Marker <- factor(heatmap_with_sig$Marker, levels = c("DN", "DN.CD25", "DN.DN", "DP", "DP.CD69", "SP4", "SP4.CD69", "SP8", "SP8.CD69", "Macrophages", "Dendritic.Cells", "B.Cells"))
heatmap_with_sig$Dose <- factor(heatmap_with_sig$Dose, levels = c( "1.5", "1", "0.5", "0.166","Vehicle", "Naive"))
                             
heatmap_thymus <- ggplot(heatmap_with_sig, aes(x = Marker, y = Dose, fill = median_norm)) +
  geom_tile(color = "black", size = 0.4) +
  geom_text(aes(label = round(median_norm, 2)), size = 2.5, color = "black") +
  #geom_text(aes(label = significance), vjust = 0.4, size = 6, color = "black", fontface = "bold") +
  scale_fill_gradient2(
    low = "#330597", mid = "white", high = "red", midpoint = 1,
    name = "Normalized\nMedian", limits = c(0, 2),  oob = scales::squish 
  ) +
  facet_grid(Sex ~ PFAS) +
scale_x_discrete(position = "top") + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_size = 11) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 0),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    strip.text = element_text(face = "bold"))

#Print
ggsave(filename = "plots/thymus_heatmap.png", plot = heatmap_thymus, width = 7, height = 5, dpi = 300,bg = "white")
print(heatmap_thymus)

##########################################################################################################################
#Dose-response curve
#Define PFAS order and dose order
custom_colors <- c("#0d0887","#3c049b","#6001a6","#8104a7","#a01a9c","#ba3388","#cf4c74","#e26561","#f0804e","#fa9e3b","#fec029","#f7e425"
)

pfas_order <- c("PFOS", "PFOA")
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
marker_levels <- c("DN", "DN.CD25", "DN.DN", "DP", "DP.CD69", "SP4", "SP4.CD69", "SP8", "SP8.CD69", "Macrophages", "Dendritic.Cells", "B.Cells")

#Factor levels
data_thymus$PFAS <- factor(data_thymus$PFAS, levels = pfas_order)
data_thymus$Dose <- factor(data_thymus$Dose, levels = dose_levels)
data_thymus$Marker <- factor(data_thymus$Marker, levels = marker_levels)

#Compute summary stats with Sex
mean_data <- data_thymus %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(
    mean_stat = median(normalized, na.rm = TRUE),
    se_stat = std.error(normalized) * 2.365,  # 95% CI
    .groups = "drop"
  ) %>%
  mutate(
    Chemical = PFAS,
    significance = NA_character_,
    y_position_label = mean_stat + se_stat + 1,
    Dose_factor = Dose)

#Join significance annotations
mean_data <- mean_data %>%
  left_join(
    significance_df_non_parametric %>%
      select(PFAS, Marker, group1, significance) %>%
      rename(Dose = group1),
    by = c("PFAS", "Marker", "Dose")
  ) %>%
  mutate(
    y_position_label = mean_stat + se_stat + 1)
mean_data <- mean_data %>%
  mutate(
    Marker = factor(Marker, levels = marker_levels),
    Dose_factor = factor(Dose_factor, levels = dose_levels)
  )
#Split by sex
data_thymus_male <- data_thymus %>% filter(Sex == "Male")
data_thymus_female <- data_thymus %>% filter(Sex == "Female")
mean_data_male <- mean_data %>% filter(Sex == "Male")
mean_data_female <- mean_data %>% filter(Sex == "Female")

#Plot
make_plot_by_sex <- function(data, summary, sex_label) {
  ggplot() +
    geom_jitter(
      data = data,
      aes(x = Dose, y = normalized, color = Marker),
      size = 1, alpha = 0.4, width = 0.2
    ) +
    geom_line(
      data = summary,
      aes(x = Dose_factor, y = mean_stat, group = interaction(Marker, PFAS), color = Marker),
      size = 0.8
    ) +
    geom_errorbar(
      data = summary,
      aes(x = Dose_factor, ymin = mean_stat - se_stat, ymax = mean_stat + se_stat, color = Marker),
      width = 0.5
    ) +
    geom_hline(yintercept = 1, linetype = "dotted", size = 1, alpha = 0.4) +
   # geom_text(
   #   data = summary[!is.na(summary$significance.y), ],
   #   aes(x = Dose_factor, y = y_position_label, label = significance.y, color = Marker),
   #   size = 6,
   #   show.legend = FALSE
   # ) +
    facet_grid(PFAS ~ Marker, scales = "free") +
    scale_color_manual(values = custom_colors) +
    labs(
      title = paste("Normalized Response -", sex_label),
      x = NULL,
      y = NULL,
      color = "Marker"
    ) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "bottom",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank()
    )
}

#Print plots
plot_male <- make_plot_by_sex(data_thymus_male, mean_data_male, "Male")
plot_female <- make_plot_by_sex(data_thymus_female, mean_data_female, "Female")
print(plot_male)
ggsave(filename = "plots/thymus_dr_male.png", plot = plot_male, width = 7, height = 5, dpi = 300,bg = "white")
print(plot_female)
ggsave(filename = "plots/thymus_dr_feamle.png", plot = plot_female, width = 7, height = 5, dpi = 300,bg = "white")
```


#Cytokine stats and plot
```{r}
#Read in df
data_cyto <- read.csv("../invivo-pfas-immunotox/Cytokine.csv")

#Pre-process
data_cyto <- data_cyto %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_cyto <- data_cyto %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

#Duplicate Naive and Vehicle for statistics
controls <- data_cyto %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

#Making the the PFAS groups correct
data_cyto <- data_cyto %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_cyto <- data_cyto %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose),
    names_to = "Marker",
    values_to = "Value"
  )

#Removing NAs
data_cyto <- data_cyto %>% filter(!is.na(Value))
#Just making sure everything is numeric
data_cyto$Value <- as.numeric(data_cyto$Value)
#Filter out females
data_female <- data_cyto %>% filter(Sex == "Female")
#Filter out males
data_male <- data_cyto %>% filter(Sex == "Male")
# Function to run Kruskal-Wallis + Dunn's Test and return pairwise comparisons
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      # Run Kruskal-Wallis Test
      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

      # Add this line to check that p.value is not NA
if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

        # Run Dunn's Test
        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        # Filter for comparisons involving "Vehicle"
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        # Add y-position for plotting
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

#Run for both sexes
sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
#Combine all pairwise comparisons
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)

unique_markers <- unique(data_cyto$Marker)

for (m in unique(data_cyto$Marker)) {

plot_data <- data_cyto %>%
    filter(Marker == m) %>%
    filter(!(Dose %in% c("Naive", "Vehicle") & PFAS == "PFOA"))

plot_data <- plot_data %>%
    mutate(PFAS_Dose = case_when(
    Dose %in% c("Naive", "Vehicle") ~ Dose,
    TRUE ~ paste(PFAS, Dose)))

plot_data$PFAS_Dose <- factor(plot_data$PFAS_Dose,levels = c( "Naive", "Vehicle","PFOS 0.166", "PFOS 0.5", "PFOS 1", "PFOS 1.5", "PFOA 0.166", "PFOA 0.5", "PFOA 1", "PFOA 1.5"))
 
label_map <- c("Naive" = "Naive", "Vehicle" = "Vehicle", "PFOS 0.166" = "0.166 mg/kg/day", "PFOS 0.5" = "0.5 mg/kg/day", "PFOS 1" = "1 mg/kg/day", "PFOS 1.5" = "1.5 mg/kg/day", "PFOA 0.166" = "0.166 mg/kg/day", "PFOA 0.5" = "0.5 mg/kg/day", "PFOA 1" = "1 mg/kg/day", "PFOA 1.5" = "1.5 mg/kg/day")

sig_data <- significance_df_non_parametric %>%
    filter(Marker == m) %>%
    mutate(group1 = case_when(
      group1 %in% c("Naive", "Vehicle") ~ group1,
      TRUE ~ paste(PFAS, group1)))

y_max <- max(plot_data$Value, na.rm = TRUE)

if (nrow(sig_data) > 0) {
  sig_data$y.position <- ifelse(
    sig_data$Sex == "Female",
    y_max * 1.02,  # Female stars 2% above max
    y_max * 1.05   # Male stars 5% above max
  )
}
  plot <- ggplot(plot_data, aes(x = PFAS_Dose, y = Value, color = Sex)) +
    geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
    geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
                alpha = 0.7, size = 1.5) +
    scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
    scale_x_discrete(labels = label_map) +
    labs(x = NULL, y = NULL, title = paste("Marker:", m)) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA)
    )

  if (nrow(sig_data) > 0) {
    plot <- plot + geom_text(
      data = sig_data,
      aes(x = group1, y = y.position, label = significance),
      color = ifelse(sig_data$Sex == "Female", "red", "blue"),
      inherit.aes = FALSE,
      size = 6,
      position = position_dodge(width = 0.75)
    )
  }

  plot <- plot +
    labs(caption = "                PFOS                               PFOA") +
    theme(
      plot.caption = element_text(hjust = 0.5, face = "bold", size = 10),
      plot.margin = margin(t = 10, r = 10, b = 40, l = 10)
    )

#ggsave(filename = paste0("plots/cyto_boxplot_", gsub(" ", "_", m), ".png"),plot = plot,width = 8, height = 6,dpi = 300,bg = "white")

  print(plot)
}

##########################################################################################################################
#Normalize 
data_cyto <- data_cyto %>%
  group_by(Sex, PFAS, Marker) %>%
  mutate(vehicle_median = median(Value[Dose == "Vehicle"], na.rm = TRUE),
         normalized = Value / vehicle_median,
         percent_of_vehicle = (Value / vehicle_median) * 100) %>%
  ungroup()
data_female <- data_cyto %>% filter(Sex == "Female")
data_male <- data_cyto %>% filter(Sex == "Male")

# Function to run Kruskal-Wallis + Dunn's Test and return pairwise comparisons
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      # Run Kruskal-Wallis Test
      kw_test <- kruskal.test(normalized ~ Dose, data = subset_data)

      if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {
        # Run Dunn's Test
        dunn_result <- dunnTest(normalized ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        # Filter for comparisons involving "Vehicle"
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        # Add y-position for plotting
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$normalized, na.rm = TRUE)
          increment <- max_y * 0.1
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + 10)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

#Run for both sexes (Non-parametric)
sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
#Combine all pairwise comparisons
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)

for (m in unique(data_cyto$Marker)) {
  plot_data <- data_cyto %>%
    filter(Marker == m) %>%
    filter(!(Dose %in% c("Naive", "Vehicle") & PFAS == "PFOA"))

plot_data <- plot_data %>%
    mutate(PFAS_Dose = case_when(
      Dose %in% c("Naive", "Vehicle") ~ Dose,
      TRUE ~ paste(PFAS, Dose)))

plot_data$PFAS_Dose <- factor(
    plot_data$PFAS_Dose,
    levels = c( "Naive", "Vehicle","PFOS 0.166", "PFOS 0.5", "PFOS 1", "PFOS 1.5", "PFOA 0.166", "PFOA 0.5", "PFOA 1", "PFOA 1.5"))
 
label_map <- c("Naive" = "Naive", "Vehicle" = "Vehicle", "PFOS 0.166" = "0.166 mg/kg/day", "PFOS 0.5" = "0.5 mg/kg/day", "PFOS 1" = "1 mg/kg/day", "PFOS 1.5" = "1.5 mg/kg/day", "PFOA 0.166" = "0.166 mg/kg/day", "PFOA 0.5" = "0.5 mg/kg/day", "PFOA 1" = "1 mg/kg/day", "PFOA 1.5" = "1.5 mg/kg/day")

sig_data <- significance_df_non_parametric %>%
    filter(Marker == m) %>%
    mutate(group1 = case_when(
      group1 %in% c("Naive", "Vehicle") ~ group1,
      TRUE ~ paste(PFAS, group1)))

y_max <- max(plot_data$normalized, na.rm = TRUE)

if (nrow(sig_data) > 0) {
  sig_data$y.position <- ifelse(
    sig_data$Sex == "Female",
    y_max * 1.02,  # Female stars 2% above max
    y_max * 1.05   # Male stars 5% above max
  )
}
 norm_plot <- ggplot(plot_data, aes(x = PFAS_Dose, y = normalized, color = Sex)) +
    geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
    geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
                alpha = 0.7, size = 1.5) +
    scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
    scale_x_discrete(labels = label_map) +
    labs(x = NULL, y = "Normalized", title = paste("Marker:", m)) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA)
    )

  if (nrow(sig_data) > 0) {
    norm_plot <- norm_plot + geom_text(
      data = sig_data,
      aes(x = group1, y = y.position, label = significance),
      color = ifelse(sig_data$Sex == "Female", "red", "blue"),
      inherit.aes = FALSE,
      size = 6,
      position = position_dodge(width = 0.75))
  }

  norm_plot <- norm_plot +
    labs(caption = "                PFOS                               PFOA") +
    theme(
      plot.caption = element_text(hjust = 0.5, face = "bold", size = 10),
      plot.margin = margin(t = 10, r = 10, b = 40, l = 10)
    )

#ggsave(filename = paste0("plots/cyto_boxplot_norm_", gsub(" ", "_", m), ".png"),plot = norm_plot,width = 8, height = 6,dpi = 300,bg = "white")

  print(norm_plot)
}

##########################################################################################################################
#Heatmap
sig_for_heatmap <- significance_df_non_parametric %>%
  mutate(
    Dose = str_remove(group1, ".* "),  # gets just the dose part like "0.166"
    Dose = ifelse(group1 %in% c("Naive", "Vehicle"), group1, Dose),
    Marker = as.character(Marker)  # ensure type consistency
  ) %>%
  select(Sex, PFAS, Marker, Dose, significance)
heatmap_data <- data_cyto %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(median_norm = median(normalized, na.rm = TRUE), .groups = "drop")
heatmap_with_sig <- heatmap_data %>%
  left_join(sig_for_heatmap, by = c("Sex", "PFAS", "Marker", "Dose"))

heatmap_with_sig$Dose <- factor(heatmap_with_sig$Dose, levels = c( "1.5", "1", "0.5", "0.166","Vehicle", "Naive"))
heatmap_with_sig$Marker <- factor(heatmap_with_sig$Marker, levels = c("G.CSF", "GM.CSF", "IL.9", "IL.3", "IL.5", "IL.10", "IL.4", "IL.13", "IL.17a", "Eotaxin", "KC", "MCP.1", "RANTES", "MIP.1a", "MIP.1b", "IL.1a", "IL.1b", "IL.6", "TNF.a", "IFN.g", "IL.2", "IL.12.p40.", "IL.12.p70."
))
                                  
heatmap_cyto <- ggplot(heatmap_with_sig, aes(x = Marker, y = Dose, fill = median_norm)) +
  geom_tile(color = "black", size = 0.4) +
  geom_text(aes(label = round(median_norm, 2)), size = 2.5, color = "black") +
  #geom_text(aes(label = significance), vjust = 0.4, size = 6, color = "black", fontface = "bold") +
  scale_fill_gradient2(
    low = "#330597", mid = "white", high = "red", midpoint = 1,
    name = "Normalized\nMedian", limits = c(0, 3),  oob = scales::squish 
  ) +
  facet_grid(Sex ~ PFAS) +
scale_x_discrete(position = "top") + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_size = 11) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 0),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    strip.text = element_text(face = "bold"))
    strip.text = element_text(face = "bold")

#Print
ggsave(filename = "plots/cyto_heatmap.png", plot = heatmap_cyto, width = 7, height = 5, dpi = 300,bg = "white")
print(heatmap_cyto)

##########################################################################################################################
#Dose-response curve
#Define PFAS order and dose order
custom_colors <- c("#0d0887","#220690","#320597","#42039d","#5102a3","#5f01a6","#6c00a8","#7905a6","#8610a2","#931a9c","#9f2494","#ab2e8d","#b83885","#c5427c","#d24c74","#dd566c","#e86164","#f26b5c","#f97554","#fd8349","#fe9341","#fca636","#f2b52e")

pfas_order <- c("PFOS", "PFOA")
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
marker_levels <- c("G.CSF", "GM.CSF", "IL.9", "IL.3", "IL.5", "IL.10", "IL.4", "IL.13", "IL.17a", "Eotaxin", "KC", "MCP.1", "RANTES", "MIP.1a", "MIP.1b", "IL.1a", "IL.1b", "IL.6", "TNF.a", "IFN.g", "IL.2", "IL.12.p40.", "IL.12.p70."
)

#Factor levels
data_cyto$PFAS <- factor(data_cyto$PFAS, levels = pfas_order)
data_cyto$Dose <- factor(data_cyto$Dose, levels = dose_levels)
data_cyto$Marker <- factor(data_cyto$Marker, levels = marker_levels)

#Compute summary stats with Sex
mean_data <- data_cyto %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(
    mean_stat = median(normalized, na.rm = TRUE),
    se_stat = std.error(normalized) * 2.365,  # 95% CI
    .groups = "drop"
  ) %>%
  mutate(
    Chemical = PFAS,
    significance = NA_character_,
    y_position_label = mean_stat + se_stat + 1,
    Dose_factor = Dose)

#Join significance annotations
mean_data <- mean_data %>%
  left_join(
    significance_df_non_parametric %>%
      select(PFAS, Marker, group1, significance) %>%
      rename(Dose = group1),
    by = c("PFAS", "Marker", "Dose")
  ) %>%
  mutate(
    y_position_label = mean_stat + se_stat + 1)

mean_data <- mean_data %>%
  mutate(
    Marker = factor(Marker, levels = marker_levels),
    Dose_factor = factor(Dose_factor, levels = dose_levels)
  )
#Split by sex
data_cyto_male <- data_cyto %>% filter(Sex == "Male")
data_cyto_female <- data_cyto %>% filter(Sex == "Female")
mean_data_male <- mean_data %>% filter(Sex == "Male")
mean_data_female <- mean_data %>% filter(Sex == "Female")

#Plot
make_plot_by_sex <- function(data, summary, sex_label) {
  ggplot() +
    geom_jitter(
      data = data,
      aes(x = Dose, y = normalized, color = Marker),
      size = 1, alpha = 0.4, width = 0.2
    ) +
    geom_line(
      data = summary,
      aes(x = Dose_factor, y = mean_stat, group = interaction(Marker, PFAS), color = Marker),
      size = 0.8
    ) +
    geom_errorbar(
      data = summary,
      aes(x = Dose_factor, ymin = mean_stat - se_stat, ymax = mean_stat + se_stat, color = Marker),
      width = 0.5
    ) +
    geom_hline(yintercept = 1, linetype = "dotted", size = 1, alpha = 0.4) +
   # geom_text(
   #   data = summary[!is.na(summary$significance.y), ],
   #   aes(x = Dose_factor, y = y_position_label, label = significance.y, color = Marker),
   #   size = 6,
   #   show.legend = FALSE
   # ) +
    facet_grid(PFAS ~ Marker, scales = "free") +
    scale_color_manual(values = custom_colors) +
    labs(
      title = paste("Normalized Response -", sex_label),
      x = NULL,
      y = NULL,
      color = "Marker"
    ) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "bottom",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank()
    )
}

#Print plots
plot_male <- make_plot_by_sex(data_cyto_male, mean_data_male, "Male")
plot_female <- make_plot_by_sex(data_cyto_female, mean_data_female, "Female")
print(plot_male)
ggsave(filename = "plots/cyto_dr_male.png", plot = plot_male, width = 7, height = 5, dpi = 300,bg = "white")
print(plot_female)
ggsave(filename = "plots/cyto_dr_feamle.png", plot = plot_female, width = 7, height = 5, dpi = 300,bg = "white")
```

#Biochem stats and plot
```{r}
#Read in df
data_bio <- read.csv("../invivo-pfas-immunotox/biochemistry.csv")

#Pre-process
data_bio <- data_bio %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_bio <- data_bio %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

#Duplicate Naive and Vehicle for statistics
controls <- data_bio %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

#Making the the PFAS groups correct
data_bio <- data_bio %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_bio <- data_bio %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose),
    names_to = "Marker",
    values_to = "Value"
  )

#Removing NAs
data_bio <- data_bio %>% filter(!is.na(Value))
#Just making sure everything is numeric
data_bio$Value <- as.numeric(data_bio$Value)
#Filter out females
data_female <- data_bio %>% filter(Sex == "Female")
#Filter out males
data_male <- data_bio %>% filter(Sex == "Male")
# Function to run Kruskal-Wallis + Dunn's Test and return pairwise comparisons
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      # Run Kruskal-Wallis Test
      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

      # Add this line to check that p.value is not NA
if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

        # Run Dunn's Test
        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        # Filter for comparisons involving "Vehicle"
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        # Add y-position for plotting
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

#Run for both sexes
sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
#Combine all pairwise comparisons
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)

unique_markers <- unique(data_bio$Marker)

for (m in unique(data_bio$Marker)) {

plot_data <- data_bio %>%
    filter(Marker == m) %>%
    filter(!(Dose %in% c("Naive", "Vehicle") & PFAS == "PFOA"))

plot_data <- plot_data %>%
    mutate(PFAS_Dose = case_when(
    Dose %in% c("Naive", "Vehicle") ~ Dose,
    TRUE ~ paste(PFAS, Dose)))

plot_data$PFAS_Dose <- factor(plot_data$PFAS_Dose,levels = c( "Naive", "Vehicle","PFOS 0.166", "PFOS 0.5", "PFOS 1", "PFOS 1.5", "PFOA 0.166", "PFOA 0.5", "PFOA 1", "PFOA 1.5"))
 
label_map <- c("Naive" = "Naive", "Vehicle" = "Vehicle", "PFOS 0.166" = "0.166 mg/kg/day", "PFOS 0.5" = "0.5 mg/kg/day", "PFOS 1" = "1 mg/kg/day", "PFOS 1.5" = "1.5 mg/kg/day", "PFOA 0.166" = "0.166 mg/kg/day", "PFOA 0.5" = "0.5 mg/kg/day", "PFOA 1" = "1 mg/kg/day", "PFOA 1.5" = "1.5 mg/kg/day")

sig_data <- significance_df_non_parametric %>%
    filter(Marker == m) %>%
    mutate(group1 = case_when(
      group1 %in% c("Naive", "Vehicle") ~ group1,
      TRUE ~ paste(PFAS, group1)))

y_max <- max(plot_data$Value, na.rm = TRUE)

if (nrow(sig_data) > 0) {
  sig_data$y.position <- ifelse(
    sig_data$Sex == "Female",
    y_max * 1.02,  # Female stars 2% above max
    y_max * 1.05   # Male stars 5% above max
  )
}
  plot <- ggplot(plot_data, aes(x = PFAS_Dose, y = Value, color = Sex)) +
    geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
    geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
                alpha = 0.7, size = 1.5) +
    scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
    scale_x_discrete(labels = label_map) +
    labs(x = NULL, y = NULL, title = paste("Marker:", m)) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA)
    )

  if (nrow(sig_data) > 0) {
    plot <- plot + geom_text(
      data = sig_data,
      aes(x = group1, y = y.position, label = significance),
      color = ifelse(sig_data$Sex == "Female", "red", "blue"),
      inherit.aes = FALSE,
      size = 6,
      position = position_dodge(width = 0.75)
    )
  }

  plot <- plot +
    labs(caption = "                PFOS                               PFOA") +
    theme(
      plot.caption = element_text(hjust = 0.5, face = "bold", size = 10),
      plot.margin = margin(t = 10, r = 10, b = 40, l = 10)
    )

#ggsave(filename = paste0("plots/bio_boxplot_", gsub(" ", "_", m), ".png"),plot = plot,width = 8, height = 6,dpi = 300,bg = "white")

  print(plot)
}

##########################################################################################################################
#Normalize 
data_bio <- data_bio %>%
  group_by(Sex, PFAS, Marker) %>%
  mutate(vehicle_median = median(Value[Dose == "Vehicle"], na.rm = TRUE),
         normalized = Value / vehicle_median,
         percent_of_vehicle = (Value / vehicle_median) * 100) %>%
  ungroup()
data_female <- data_bio %>% filter(Sex == "Female")
data_male <- data_bio %>% filter(Sex == "Male")

# Function to run Kruskal-Wallis + Dunn's Test and return pairwise comparisons
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      # Run Kruskal-Wallis Test
      kw_test <- kruskal.test(normalized ~ Dose, data = subset_data)

      if (kw_test$p.value < 0.05) {
        # Run Dunn's Test
        dunn_result <- dunnTest(normalized ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        # Filter for comparisons involving "Vehicle"
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        # Add y-position for plotting
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$normalized, na.rm = TRUE)
          increment <- max_y * 0.1
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + 10)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

#Run for both sexes (Non-parametric)
sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
#Combine all pairwise comparisons
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)

for (m in unique(data_bio$Marker)) {
  plot_data <- data_bio %>%
    filter(Marker == m) %>%
    filter(!(Dose %in% c("Naive", "Vehicle") & PFAS == "PFOA"))

plot_data <- plot_data %>%
    mutate(PFAS_Dose = case_when(
      Dose %in% c("Naive", "Vehicle") ~ Dose,
      TRUE ~ paste(PFAS, Dose)))

plot_data$PFAS_Dose <- factor(
    plot_data$PFAS_Dose,
    levels = c( "Naive", "Vehicle","PFOS 0.166", "PFOS 0.5", "PFOS 1", "PFOS 1.5", "PFOA 0.166", "PFOA 0.5", "PFOA 1", "PFOA 1.5"))
 
label_map <- c("Naive" = "Naive", "Vehicle" = "Vehicle", "PFOS 0.166" = "0.166 mg/kg/day", "PFOS 0.5" = "0.5 mg/kg/day", "PFOS 1" = "1 mg/kg/day", "PFOS 1.5" = "1.5 mg/kg/day", "PFOA 0.166" = "0.166 mg/kg/day", "PFOA 0.5" = "0.5 mg/kg/day", "PFOA 1" = "1 mg/kg/day", "PFOA 1.5" = "1.5 mg/kg/day")

sig_data <- significance_df_non_parametric %>%
    filter(Marker == m) %>%
    mutate(group1 = case_when(
      group1 %in% c("Naive", "Vehicle") ~ group1,
      TRUE ~ paste(PFAS, group1)))

y_max <- max(plot_data$normalized, na.rm = TRUE)

if (nrow(sig_data) > 0) {
  sig_data$y.position <- ifelse(
    sig_data$Sex == "Female",
    y_max * 1.02,  # Female stars 2% above max
    y_max * 1.05   # Male stars 5% above max
  )
}
 norm_plot <- ggplot(plot_data, aes(x = PFAS_Dose, y = normalized, color = Sex)) +
    geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
    geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
                alpha = 0.7, size = 1.5) +
    scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
    scale_x_discrete(labels = label_map) +
    labs(x = NULL, y = "Normalized", title = paste("Marker:", m)) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA)
    )

  if (nrow(sig_data) > 0) {
    norm_plot <- norm_plot + geom_text(
      data = sig_data,
      aes(x = group1, y = y.position, label = significance),
      color = ifelse(sig_data$Sex == "Female", "red", "blue"),
      inherit.aes = FALSE,
      size = 6,
      position = position_dodge(width = 0.75)
    )
  }

  norm_plot <- norm_plot +
    labs(caption = "                PFOS                               PFOA") +
    theme(
      plot.caption = element_text(hjust = 0.5, face = "bold", size = 10),
      plot.margin = margin(t = 10, r = 10, b = 40, l = 10)
    )

#ggsave(filename = paste0("plots/bio_boxplot_norm_", gsub(" ", "_", m), ".png"),plot = norm_plot,width = 8, height = 6,dpi = 300,bg = "white")

  print(norm_plot)
}

##########################################################################################################################
#Heatmap
sig_for_heatmap <- significance_df_non_parametric %>%
  mutate(
    Dose = str_remove(group1, ".* "),  # gets just the dose part like "0.166"
    Dose = ifelse(group1 %in% c("Naive", "Vehicle"), group1, Dose),
    Marker = as.character(Marker)  # ensure type consistency
  ) %>%
  select(Sex, PFAS, Marker, Dose, significance)
heatmap_data <- data_bio %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(median_norm = median(normalized, na.rm = TRUE), .groups = "drop")
heatmap_with_sig <- heatmap_data %>%
  left_join(sig_for_heatmap, by = c("Sex", "PFAS", "Marker", "Dose"))

heatmap_with_sig$Dose <- factor(heatmap_with_sig$Dose, levels = c( "1.5", "1", "0.5", "0.166","Vehicle", "Naive"))
heatmap_with_sig$Marker <- factor(heatmap_with_sig$Marker, levels = c("ALP",	"ALT",	"CA",	"CHOL",	"FT4", "LDH","TBI",	"TGL"))
                                  
heatmap_bio <- ggplot(heatmap_with_sig, aes(x = Marker, y = Dose, fill = median_norm)) +
  geom_tile(color = "black", size = 0.4) +
  geom_text(aes(label = round(median_norm, 2)), size = 2.5, color = "black") +
  #geom_text(aes(label = significance), vjust = 0.4, size = 6, color = "black", fontface = "bold") +
  scale_fill_gradient2(
    low = "#330597", mid = "white", high = "red", midpoint = 1,
    name = "Normalized\nMedian", limits = c(0, 4),  oob = scales::squish 
  ) +
  facet_grid(Sex ~ PFAS) +
scale_x_discrete(position = "top") + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_size = 11) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 0),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    strip.text = element_text(face = "bold"))
#Print
ggsave(filename = "plots/bio_heatmap.png", plot = heatmap_bio, width = 7, height = 5, dpi = 300,bg = "white")
print(heatmap_bio)

##########################################################################################################################
#Dose-response curve
#Define PFAS order and dose order
custom_colors <- c("#0d0887", "#7e03a8", "#b52f8c", "#cc4778", "#de5f65","#ed7953", "#f89540", "#fdb42f")
pfas_order <- c("PFOS", "PFOA")
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
marker_levels <- c("ALP",	"ALT",	"CA",	"CHOL",	"FT4", "LDH","TBI",	"TGL")

#Factor levels
data_bio$PFAS <- factor(data_bio$PFAS, levels = pfas_order)
data_bio$Dose <- factor(data_bio$Dose, levels = dose_levels)
data_bio$Marker <- factor(data_bio$Marker, levels = marker_levels)

#Compute summary stats with Sex
mean_data <- data_bio %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(
    mean_stat = median(normalized, na.rm = TRUE),
    se_stat = std.error(normalized) * 2.365,  # 95% CI
    .groups = "drop"
  ) %>%
  mutate(
    Chemical = PFAS,
    significance = NA_character_,
    y_position_label = mean_stat + se_stat + 1,
    Dose_factor = Dose)

#Join significance annotations
mean_data <- mean_data %>%
  left_join(
    significance_df_non_parametric %>%
      select(PFAS, Marker, group1, significance) %>%
      rename(Dose = group1),
    by = c("PFAS", "Marker", "Dose")
  ) %>%
  mutate(
    y_position_label = mean_stat + se_stat + 1)

#Split by sex
data_bio_male <- data_bio %>% filter(Sex == "Male")
data_bio_female <- data_bio %>% filter(Sex == "Female")
mean_data_male <- mean_data %>% filter(Sex == "Male")
mean_data_female <- mean_data %>% filter(Sex == "Female")

#Plot
make_plot_by_sex <- function(data, summary, sex_label) {
  ggplot() +
    geom_jitter(
      data = data,
      aes(x = Dose, y = normalized, color = Marker),
      size = 1, alpha = 0.4, width = 0.2
    ) +
    geom_line(
      data = summary,
      aes(x = Dose_factor, y = mean_stat, group = interaction(Marker, PFAS), color = Marker),
      size = 0.8
    ) +
    geom_errorbar(
      data = summary,
      aes(x = Dose_factor, ymin = mean_stat - se_stat, ymax = mean_stat + se_stat, color = Marker),
      width = 0.5
    ) +
    geom_hline(yintercept = 1, linetype = "dotted", size = 1, alpha = 0.4) +
   # geom_text(
   #   data = summary[!is.na(summary$significance.y), ],
   #   aes(x = Dose_factor, y = y_position_label, label = significance.y, color = Marker),
   #   size = 6,
   #   show.legend = FALSE
   # ) +
    facet_grid(PFAS ~ Marker, scales = "free") +
    scale_color_manual(values = custom_colors) +
    labs(
      title = paste("Normalized Response -", sex_label),
      x = NULL,
      y = NULL,
      color = "Marker"
    ) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "bottom",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank()
    )
}

#Print plots
plot_male <- make_plot_by_sex(data_bio_male, mean_data_male, "Male")
plot_female <- make_plot_by_sex(data_bio_female, mean_data_female, "Female")
print(plot_male)
ggsave(filename = "plots/bio_dr_male.png", plot = plot_male, width = 7, height = 5, dpi = 300,bg = "white")
print(plot_female)
ggsave(filename = "plots/bio_dr_feamle.png", plot = plot_female, width = 7, height = 5, dpi = 300,bg = "white")
```

#Liver toxicity using real values

```{r}
#Read in df
#If multipl RR used first (checked that they were similar)
#Converted ug/kg to mg/kg for naive and vehicle first 

#Have to set MDL 
data_conc <- read.csv("../invivo-pfas-immunotox/Liver PFAS values phase 2 and 3.csv")
# Rename column Sample. to Mouse ID
data_bio <- data_bio %>%
  rename(`Mouse.ID` = `Sample.`)
data_combined <- data_bio %>%
  left_join(
    data_conc %>% select(`Mouse.ID`, PFOA, PFOS), 
    by = c("Mouse.ID" = "Mouse.ID"))
```

#Tissue weight stats and plot
```{r}
#Read in df
data_tissue <- read.csv("../invivo-pfas-immunotox/tissue weight norm.csv")

#Pre-process
data_tissue <- data_tissue %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_tissue <- data_tissue %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

#Duplicate Naive and Vehicle for statistics
controls <- data_tissue %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

#Making the the PFAS groups correct
data_tissue <- data_tissue %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_tissue <- data_tissue %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose),
    names_to = "Marker",
    values_to = "Value"
  )

#Removing NAs
data_tissue <- data_tissue %>% filter(!is.na(Value))
#Just making sure everything is numeric
data_tissue$Value <- as.numeric(data_tissue$Value)
#Filter out females
data_female <- data_tissue %>% filter(Sex == "Female")
#Filter out males
data_male <- data_tissue %>% filter(Sex == "Male")
# Function to run Kruskal-Wallis + Dunn's Test and return pairwise comparisons
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      # Run Kruskal-Wallis Test
      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

      # Add this line to check that p.value is not NA
if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

        # Run Dunn's Test
        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        # Filter for comparisons involving "Vehicle"
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        # Add y-position for plotting
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

#Run for both sexes
sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
#Combine all pairwise comparisons
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)

unique_markers <- unique(data_tissue$Marker)

for (m in unique(data_tissue$Marker)) {

plot_data <- data_tissue %>%
    filter(Marker == m) %>%
    filter(!(Dose %in% c("Naive", "Vehicle") & PFAS == "PFOA"))

plot_data <- plot_data %>%
    mutate(PFAS_Dose = case_when(
    Dose %in% c("Naive", "Vehicle") ~ Dose,
    TRUE ~ paste(PFAS, Dose)))

plot_data$PFAS_Dose <- factor(plot_data$PFAS_Dose,levels = c( "Naive", "Vehicle","PFOS 0.166", "PFOS 0.5", "PFOS 1", "PFOS 1.5", "PFOA 0.166", "PFOA 0.5", "PFOA 1", "PFOA 1.5"))
 
label_map <- c("Naive" = "Naive", "Vehicle" = "Vehicle", "PFOS 0.166" = "0.166 mg/kg/day", "PFOS 0.5" = "0.5 mg/kg/day", "PFOS 1" = "1 mg/kg/day", "PFOS 1.5" = "1.5 mg/kg/day", "PFOA 0.166" = "0.166 mg/kg/day", "PFOA 0.5" = "0.5 mg/kg/day", "PFOA 1" = "1 mg/kg/day", "PFOA 1.5" = "1.5 mg/kg/day")

sig_data <- significance_df_non_parametric %>%
    filter(Marker == m) %>%
    mutate(group1 = case_when(
      group1 %in% c("Naive", "Vehicle") ~ group1,
      TRUE ~ paste(PFAS, group1)))

y_max <- max(plot_data$Value, na.rm = TRUE)

if (nrow(sig_data) > 0) {
  sig_data$y.position <- ifelse(
    sig_data$Sex == "Female",
    y_max * 1.02,  # Female stars 2% above max
    y_max * 1.05   # Male stars 5% above max
  )
}
  plot <- ggplot(plot_data, aes(x = PFAS_Dose, y = Value, color = Sex)) +
    geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
    geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
                alpha = 0.7, size = 1.5) +
    scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
    scale_x_discrete(labels = label_map) +
    labs(x = NULL, y = NULL, title = paste("Marker:", m)) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA)
    )

  if (nrow(sig_data) > 0) {
    plot <- plot + geom_text(
      data = sig_data,
      aes(x = group1, y = y.position, label = significance),
      color = ifelse(sig_data$Sex == "Female", "red", "blue"),
      inherit.aes = FALSE,
      size = 6,
      position = position_dodge(width = 0.75)
    )
  }

  plot <- plot +
    labs(caption = "                PFOS                               PFOA") +
    theme(
      plot.caption = element_text(hjust = 0.5, face = "bold", size = 10),
      plot.margin = margin(t = 10, r = 10, b = 40, l = 10)
    )

#ggsave(filename = paste0("plots/tissue_boxplot_", gsub(" ", "_", m), ".png"),plot = plot,width = 8, height = 6,dpi = 300,bg = "white")

  print(plot)
}

##########################################################################################################################
#Normalize 
data_tissue <- data_tissue %>%
  group_by(Sex, PFAS, Marker) %>%
  mutate(vehicle_median = median(Value[Dose == "Vehicle"], na.rm = TRUE),
         normalized = Value / vehicle_median,
         percent_of_vehicle = (Value / vehicle_median) * 100) %>%
  ungroup()
data_female <- data_tissue %>% filter(Sex == "Female")
data_male <- data_tissue %>% filter(Sex == "Male")

# Function to run Kruskal-Wallis + Dunn's Test and return pairwise comparisons
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      # Run Kruskal-Wallis Test
      kw_test <- kruskal.test(normalized ~ Dose, data = subset_data)

      if (kw_test$p.value < 0.05) {
        # Run Dunn's Test
        dunn_result <- dunnTest(normalized ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        # Filter for comparisons involving "Vehicle"
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              P.adj < 0.001 ~ "***",
              P.adj < 0.01 ~ "**",
              P.adj < 0.05 ~ "*",
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        # Add y-position for plotting
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$normalized, na.rm = TRUE)
          increment <- max_y * 0.1
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + 10)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

#Run for both sexes (Non-parametric)
sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
#Combine all pairwise comparisons
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)

for (m in unique(data_tissue$Marker)) {
  plot_data <- data_tissue %>%
    filter(Marker == m) %>%
    filter(!(Dose %in% c("Naive", "Vehicle") & PFAS == "PFOA"))

plot_data <- plot_data %>%
    mutate(PFAS_Dose = case_when(
      Dose %in% c("Naive", "Vehicle") ~ Dose,
      TRUE ~ paste(PFAS, Dose)))

plot_data$PFAS_Dose <- factor(
    plot_data$PFAS_Dose,
    levels = c( "Naive", "Vehicle","PFOS 0.166", "PFOS 0.5", "PFOS 1", "PFOS 1.5", "PFOA 0.166", "PFOA 0.5", "PFOA 1", "PFOA 1.5"))
 
label_map <- c("Naive" = "Naive", "Vehicle" = "Vehicle", "PFOS 0.166" = "0.166 mg/kg/day", "PFOS 0.5" = "0.5 mg/kg/day", "PFOS 1" = "1 mg/kg/day", "PFOS 1.5" = "1.5 mg/kg/day", "PFOA 0.166" = "0.166 mg/kg/day", "PFOA 0.5" = "0.5 mg/kg/day", "PFOA 1" = "1 mg/kg/day", "PFOA 1.5" = "1.5 mg/kg/day")

sig_data <- significance_df_non_parametric %>%
    filter(Marker == m) %>%
    mutate(group1 = case_when(
      group1 %in% c("Naive", "Vehicle") ~ group1,
      TRUE ~ paste(PFAS, group1)))

y_max <- max(plot_data$normalized, na.rm = TRUE)

if (nrow(sig_data) > 0) {
  sig_data$y.position <- ifelse(
    sig_data$Sex == "Female",
    y_max * 1.02,  # Female stars 2% above max
    y_max * 1.05   # Male stars 5% above max
  )
}
 norm_plot <- ggplot(plot_data, aes(x = PFAS_Dose, y = normalized, color = Sex)) +
    geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
    geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
                alpha = 0.7, size = 1.5) +
    scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
    scale_x_discrete(labels = label_map) +
    labs(x = NULL, y = "Normalized", title = paste("Marker:", m)) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA)
    )

  if (nrow(sig_data) > 0) {
    norm_plot <- norm_plot + geom_text(
      data = sig_data,
      aes(x = group1, y = y.position, label = significance),
      color = ifelse(sig_data$Sex == "Female", "red", "blue"),
      inherit.aes = FALSE,
      size = 6,
      position = position_dodge(width = 0.75)
    )
  }

  norm_plot <- norm_plot +
    labs(caption = "                PFOS                               PFOA") +
    theme(
      plot.caption = element_text(hjust = 0.5, face = "bold", size = 10),
      plot.margin = margin(t = 10, r = 10, b = 40, l = 10)
    )

#ggsave(filename = paste0("plots/tissue_boxplot_norm_", gsub(" ", "_", m), ".png"),plot = norm_plot,width = 8, height = 6,dpi = 300,bg = "white")

  print(norm_plot)
}

##########################################################################################################################
#Heatmap
sig_for_heatmap <- significance_df_non_parametric %>%
  mutate(
    Dose = str_remove(group1, ".* "),  # gets just the dose part like "0.166"
    Dose = ifelse(group1 %in% c("Naive", "Vehicle"), group1, Dose),
    Marker = as.character(Marker)  # ensure type consistency
  ) %>%
  select(Sex, PFAS, Marker, Dose, significance)
heatmap_data <- data_tissue %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(median_norm = median(normalized, na.rm = TRUE), .groups = "drop")
heatmap_with_sig <- heatmap_data %>%
  left_join(sig_for_heatmap, by = c("Sex", "PFAS", "Marker", "Dose"))

heatmap_with_sig$Dose <- factor(heatmap_with_sig$Dose, levels = c( "1.5", "1", "0.5", "0.166","Vehicle", "Naive"))
heatmap_with_sig$Marker <- factor(heatmap_with_sig$Marker, levels = c("Liver", "Pancreas", "Spleen", "Thymus", "Kidneys", "GI.Tract"))
                                  
heatmap_tissue <- ggplot(heatmap_with_sig, aes(x = Marker, y = Dose, fill = median_norm)) +
  geom_tile(color = "black", size = 0.4) +
  geom_text(aes(label = round(median_norm, 2)), size = 2.5, color = "black") +
  #geom_text(aes(label = significance), vjust = 0.4, size = 6, color = "black", fontface = "bold") +
  scale_fill_gradient2(
    low = "#330597", mid = "white", high = "red", midpoint = 1,
    name = "Normalized\nMedian", limits = c(0, 2),  oob = scales::squish 
  ) +
  facet_grid(Sex ~ PFAS) +
scale_x_discrete(position = "top") + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_size = 11) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 0),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    strip.text = element_text(face = "bold"))

#Print
ggsave(filename = "plots/tissue_heatmap.png", plot = heatmap_tissue, width = 7, height = 5, dpi = 300,bg = "white")
print(heatmap_tissue)

##########################################################################################################################
#Dose-response curve
#Define PFAS order and dose order
custom_colors <- c("#330597", "#8405a7", "#b12a90", "#d35171", "#f68f44", "#fec029")
pfas_order <- c("PFOS", "PFOA")
dose_levels <- c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5")
marker_levels <- c("Liver", "Pancreas", "Spleen", "Thymus", "Kidneys", "GI.Tract")

#Factor levels
data_tissue$PFAS <- factor(data_tissue$PFAS, levels = pfas_order)
data_tissue$Dose <- factor(data_tissue$Dose, levels = dose_levels)
data_tissue$Marker <- factor(data_tissue$Marker, levels = marker_levels)

#Compute summary stats with Sex
mean_data <- data_tissue %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(
    mean_stat = median(normalized, na.rm = TRUE),
    se_stat = std.error(normalized) * 2.365,  # 95% CI
    .groups = "drop"
  ) %>%
  mutate(
    Chemical = PFAS,
    significance = NA_character_,
    y_position_label = mean_stat + se_stat + 0.5,
    Dose_factor = Dose)

#Join significance annotations
mean_data <- mean_data %>%
  left_join(
    significance_df_non_parametric %>%
      select(PFAS, Marker, group1, significance) %>%
      rename(Dose = group1),
    by = c("PFAS", "Marker", "Dose")
  ) 
mean_data <- mean_data %>%
  mutate(
    Marker = factor(Marker, levels = marker_levels),
    Dose_factor = factor(Dose_factor, levels = dose_levels)
  )
#Split by sex
data_tissue_male <- data_tissue %>% filter(Sex == "Male")
data_tissue_female <- data_tissue %>% filter(Sex == "Female")
mean_data_male <- mean_data %>% filter(Sex == "Male")
mean_data_female <- mean_data %>% filter(Sex == "Female")

#Plot
make_plot_by_sex <- function(data, summary, sex_label) {
  ggplot() +
    geom_jitter(data = data,
  aes(x = Dose, y = normalized, color = Marker),
  size = 1, alpha = 0.4,
  position = position_dodge(width = 0.2)) +
    geom_line(
      data = summary,
      aes(x = Dose_factor, y = mean_stat, group = interaction(Marker, PFAS), color = Marker),
      size = 0.8
    ) +
    geom_errorbar(
      data = summary,
      aes(x = Dose_factor, ymin = mean_stat - se_stat, ymax = mean_stat + se_stat, color = Marker),
      width = 0.5
    ) +
    geom_hline(yintercept = 1, linetype = "dotted", size = 1, alpha = 0.4) +
   # geom_text(
   #   data = summary[!is.na(summary$significance.y), ],
   #   aes(x = Dose_factor, y = y_position_label, label = significance.y, color = Marker),
   #   size = 6,
   #   show.legend = FALSE
   # ) +
    facet_grid(PFAS ~ Marker, scales = "free_y") +
    scale_color_manual(values = custom_colors) +
    labs(
      title = paste("Normalized Response -", sex_label),
      x = NULL,
      y = NULL,
      color = "Marker"
    ) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "bottom",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank()
    )
}

#Print plots
plot_male <- make_plot_by_sex(data_tissue_male, mean_data_male, "Male")
plot_female <- make_plot_by_sex(data_tissue_female, mean_data_female, "Female")
print(plot_male)
ggsave(filename = "plots/tissue_dr_male.png", plot = plot_male, width = 20, height = 7, dpi = 300,bg = "white")
print(plot_female)
ggsave(filename = "plots/tissue_dr_feamle.png", plot = plot_female, width = 7, height = 5, dpi = 300,bg = "white")
```

#TDAR stats and plot
```{r}
#Read in df
data_tdar <- read.csv("../invivo-pfas-immunotox/TDAR.csv")

#Pre-process
data_tdar <- data_tdar %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"),
                         paste("control", group),
                         group))
data_tdar <- data_tdar %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

#Duplicate Naive and Vehicle for statistics
controls <- data_tdar %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

#Making the the PFAS groups correct
data_tdar <- data_tdar %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

data_tdar <- data_tdar %>%
  pivot_longer(
    cols = -c(Sample., Sex, group, PFAS, Dose),
    names_to = "Marker",
    values_to = "Value"
  )

#Removing NAs
data_tdar <- data_tdar %>% filter(!is.na(Value))
#Just making sure everything is numeric
data_tdar$Value <- as.numeric(data_tdar$Value)
#Filter out females
data_female <- data_tdar %>% filter(Sex == "Female")
#Filter out males
data_male <- data_tdar %>% filter(Sex == "Male")
# Function to run Kruskal-Wallis + Dunn's Test and return pairwise comparisons
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      
      subset_data <- data %>%
        filter(PFAS == chem, Marker == marker)

      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next

      # Run Kruskal-Wallis Test
      kw_test <- kruskal.test(Value ~ Dose, data = subset_data)

      # Add this line to check that p.value is not NA
if (!is.na(kw_test$p.value) && kw_test$p.value < 0.05) {

        # Run Dunn's Test
        dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
        pairwise_results <- dunn_result$res

        # Filter for comparisons involving "Vehicle"
        vehicle_comparisons <- pairwise_results %>%
          filter(str_detect(Comparison, "Vehicle")) %>%
          mutate(
            group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
            group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
            significance = case_when(
              TRUE ~ ""
            ),
            PFAS = chem,
            Marker = marker,
            Sex = sex_label
          )

        # Add y-position for plotting
        if (nrow(vehicle_comparisons) > 0) {
          max_y <- max(subset_data$Value, na.rm = TRUE)
          increment <- max_y + 5
          vehicle_comparisons <- vehicle_comparisons %>%
            mutate(y.position = max_y + (row_number() - 1) +20)
          results[[paste(chem, marker, sep = "_")]] <- vehicle_comparisons
        }
      }
    }
  }

  bind_rows(results)
}

#Run for both sexes
sig_female_non_parametric <- get_significance_non_parametric(data_female, "Female")
sig_male_non_parametric <- get_significance_non_parametric(data_male, "Male")
#Combine all pairwise comparisons
significance_df_non_parametric <- bind_rows(sig_female_non_parametric, sig_male_non_parametric)

unique_markers <- unique(data_tdar$Marker)

for (m in unique(data_tdar$Marker)) {

plot_data <- data_tdar %>%
    filter(Marker == m) %>%
    filter(!(Dose %in% c("Naive", "Vehicle") & PFAS == "PFOA"))

plot_data <- plot_data %>%
    mutate(PFAS_Dose = case_when(
    Dose %in% c("Naive", "Vehicle") ~ Dose,
    TRUE ~ paste(PFAS, Dose)))

plot_data$PFAS_Dose <- factor(plot_data$PFAS_Dose,levels = c( "Naive", "Vehicle","PFOS 0.166", "PFOS 0.5", "PFOS 1", "PFOS 1.5", "PFOA 0.166", "PFOA 0.5", "PFOA 1", "PFOA 1.5"))
 
label_map <- c("Naive" = "Naive", "Vehicle" = "Vehicle", "PFOS 0.166" = "0.166 mg/kg/day", "PFOS 0.5" = "0.5 mg/kg/day", "PFOS 1" = "1 mg/kg/day", "PFOS 1.5" = "1.5 mg/kg/day", "PFOA 0.166" = "0.166 mg/kg/day", "PFOA 0.5" = "0.5 mg/kg/day", "PFOA 1" = "1 mg/kg/day", "PFOA 1.5" = "1.5 mg/kg/day")

sig_data <- significance_df_non_parametric %>%
    filter(Marker == m) %>%
    mutate(group1 = case_when(
      group1 %in% c("Naive", "Vehicle") ~ group1,
      TRUE ~ paste(PFAS, group1)))

y_max <- max(plot_data$Value, na.rm = TRUE)

if (nrow(sig_data) > 0) {
  sig_data$y.position <- ifelse(
    sig_data$Sex == "Female",
    y_max * 1.02,  # Female stars 2% above max
    y_max * 1.05   # Male stars 5% above max
  )
}
  plot <- ggplot(plot_data, aes(x = PFAS_Dose, y = Value, color = Sex)) +
    geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.75)) +
    geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
                alpha = 0.7, size = 1.5) +
    scale_color_manual(values = c("Female" = "red", "Male" = "blue")) +
    scale_x_discrete(labels = label_map) +
    labs(x = NULL, y = NULL, title = paste("Marker:", m)) +
    theme_minimal() +
    theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA)
    )

  if (nrow(sig_data) > 0) {
    plot <- plot + geom_text(
      data = sig_data,
      aes(x = group1, y = y.position, label = significance),
      color = ifelse(sig_data$Sex == "Female", "red", "blue"),
      inherit.aes = FALSE,
      size = 6,
      position = position_dodge(width = 0.75)
    )
  }

  plot <- plot +
    labs(caption = "                PFOS                               PFOA") +
    theme(
      plot.caption = element_text(hjust = 0.5, face = "bold", size = 10),
      plot.margin = margin(t = 10, r = 10, b = 40, l = 10)
    )

ggsave(filename = paste0("plots/tdar_boxplot_", gsub(" ", "_", m), ".png"),plot = plot,width = 8, height = 6,dpi = 300,bg = "white")

  print(plot)
}
```
#Body weight
```{r}
# Read and preprocess data
data_bw <- read.csv("../invivo-pfas-immunotox/Body weight.csv")

data_bw <- data_bw %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"), paste("control", group), group)) %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

data_bw$Dose <- factor(data_bw$Dose, levels = c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5"))

controls <- data_bw %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_bw <- data_bw %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls) %>%
  filter(PFAS %in% c("PFOS", "PFOA")) %>%
  mutate(across(matches("^Baseline$|^Week[0-9]+$"), as.numeric))

# Pivot to long format
data_bw <- data_bw %>%
  pivot_longer(cols = -c(Sample., Sex, group, PFAS, Dose),
               names_to = "Marker", values_to = "Value") %>%
  filter(!is.na(Value)) %>%
  mutate(Value = as.numeric(Value),
         Marker = factor(Marker, levels = c("Baseline", paste0("Week", 1:8))))

# Calculate change from baseline
data_bw <- data_bw %>%
  group_by(Sample.) %>%
  mutate(Change_from_baseline = Value - Value[Marker == "Baseline"]) %>%
  ungroup()

# Add DoseSex variable
data_bw <- data_bw %>%
  mutate(DoseSex = case_when(
    Sex == "Male" & Dose == "Vehicle" ~ "Vehicle",
    Sex == "Male" & Dose %in% c("0.166", "0.5", "1", "1.5") ~ "HighM",
    Sex == "Female" & Dose == "Vehicle" ~ "Vehicle",
    Sex == "Female" & Dose %in% c("0.166", "0.5", "1", "1.5") ~ "HighF",
    TRUE ~ as.character(Dose)
  ))

# Function for Kruskal-Wallis and Dunn's test
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      subset_data <- data %>% filter(PFAS == chem, Marker == marker)
      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
      pairwise_results <- dunn_result$res %>%
        filter(str_detect(Comparison, "Vehicle")) %>%
        mutate(
          group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
          group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
          significance = case_when(
            P.adj < 0.001 ~ "***",
            P.adj < 0.01 ~ "**",
            P.adj < 0.05 ~ "*",
            TRUE ~ "ns"
          ),
          PFAS = chem,
          Marker = marker,
          Sex = sex_label
        )
      if (nrow(pairwise_results) > 0) {
        max_y <- max(subset_data$Value, na.rm = TRUE)
        pairwise_results <- pairwise_results %>%
          mutate(y.position = max_y + (row_number() - 1) * 2 + 20)
        results[[paste(sex_label, chem, marker, sep = "_")]] <- pairwise_results
      }
    }
  }
  bind_rows(results)
}

# Split and test by sex and PFAS
data_female <- data_bw %>% filter(Sex == "Female")
data_male <- data_bw %>% filter(Sex == "Male")

sig_female_pfos <- get_significance_non_parametric(data_female %>% filter(PFAS == "PFOS"), "Female")
sig_female_pfoa <- get_significance_non_parametric(data_female %>% filter(PFAS == "PFOA"), "Female")
sig_male_pfos   <- get_significance_non_parametric(data_male %>% filter(PFAS == "PFOS"), "Male")
sig_male_pfoa   <- get_significance_non_parametric(data_male %>% filter(PFAS == "PFOA"), "Male")

significance_df_non_parametric <- bind_rows(
  sig_female_pfos, sig_female_pfoa, sig_male_pfos, sig_male_pfoa
)

#Summary 
summary_stats <- data_bw %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(
    median = median(Change_from_baseline, na.rm = TRUE),
    Q1 = quantile(Change_from_baseline, 0.25, na.rm = TRUE),
    Q3 = quantile(Change_from_baseline, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    DoseSex = paste0(Dose, "_", substr(Sex, 1, 1)),
    lower = Q1,
    upper = Q3
  )

female_colors <- c(
  "Naive"   = "black",
"Vehicle" = "#fee2e2",
"0.166"   = "#fecaca",
"0.5"     = "#fca5a5",
"1"       = "#f87171",
"1.5"     = "#e53e3e"
)

male_colors <- c(
  "Naive"   = "black",
"Vehicle" = "#eff6ff",
"0.166"   = "#bfdbfe",
"0.5"     = "#93c5fd",
"1"       = "#60a5fa",
"1.5"     = "#3b82f6"
)

dose_levels <- names(female_colors)

dose_sex_colors <- c(
  setNames(female_colors, paste0(dose_levels, "_F")),
  setNames(male_colors, paste0(dose_levels, "_M"))
)

#Plot
p <- ggplot(summary_stats, aes(x = Marker, y = median, group = DoseSex, color = DoseSex)) +
  geom_line(size = 1, linetype = "solid") +  # solid lines for all
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  facet_wrap(Sex ~ PFAS, scales = "free_y") +
  scale_color_manual(values = dose_sex_colors) +
  labs(
    title = "Median Body Weight Change Over Time (± IQR)",
    x = "Week",
    y = "Δ Body Weight (g)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(p)
ggsave(filename = "plots/body_weight.png", plot = p, width = 7, height = 5, dpi = 300, bg = "white")
```

#Water consumption
```{r}
# Read and preprocess data
data_water <- read.csv("../invivo-pfas-immunotox/water consumption.csv")

data_water <- data_water %>%
  mutate(group = if_else(group %in% c("Naive", "Vehicle"), paste("control", group), group)) %>%
  separate(group, into = c("PFAS", "Dose"), sep = " ", remove = FALSE)

data_water$Dose <- factor(data_water$Dose, levels = c("Naive", "Vehicle", "0.166", "0.5", "1", "1.5"))

controls <- data_water %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

data_water <- data_water %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls) %>%
  filter(PFAS %in% c("PFOS", "PFOA")) %>%
  mutate(across(matches("^Baseline$|^Week[0-9]+$"), as.numeric))

# Pivot to long format
data_water <- data_water %>%
  pivot_longer(cols = -c(Sample., Sex, group, PFAS, Dose),
               names_to = "Marker", values_to = "Value") %>%
  filter(!is.na(Value)) %>%
  mutate(Value = as.numeric(Value),
         Marker = factor(Marker, levels = c("Baseline", paste0("Week", 1:8))))

# Calculate change from baseline
data_water <- data_water %>%
  group_by(Sample.) %>%
  mutate(Change_from_baseline = Value - Value[Marker == "Baseline"]) %>%
  ungroup()

# Add DoseSex variable
data_water <- data_water %>%
  mutate(DoseSex = case_when(
    Sex == "Male" & Dose == "Vehicle" ~ "Vehicle",
    Sex == "Male" & Dose %in% c("0.166", "0.5", "1", "1.5") ~ "HighM",
    Sex == "Female" & Dose == "Vehicle" ~ "Vehicle",
    Sex == "Female" & Dose %in% c("0.166", "0.5", "1", "1.5") ~ "HighF",
    TRUE ~ as.character(Dose)
  ))

# Function for Kruskal-Wallis and Dunn's test
get_significance_non_parametric <- function(data, sex_label) {
  results <- list()
  for (chem in unique(data$PFAS)) {
    for (marker in unique(data$Marker)) {
      subset_data <- data %>% filter(PFAS == chem, Marker == marker)
      if (nrow(subset_data) == 0 || length(unique(subset_data$Dose)) < 2) next
      dunn_result <- dunnTest(Value ~ Dose, data = subset_data, method = "bh")
      pairwise_results <- dunn_result$res %>%
        filter(str_detect(Comparison, "Vehicle")) %>%
        mutate(
          group1 = str_split(Comparison, " - ", simplify = TRUE)[,1],
          group2 = str_split(Comparison, " - ", simplify = TRUE)[,2],
          significance = case_when(
            P.adj < 0.001 ~ "***",
            P.adj < 0.01 ~ "**",
            P.adj < 0.05 ~ "*",
            TRUE ~ "ns"
          ),
          PFAS = chem,
          Marker = marker,
          Sex = sex_label
        )
      if (nrow(pairwise_results) > 0) {
        max_y <- max(subset_data$Value, na.rm = TRUE)
        pairwise_results <- pairwise_results %>%
          mutate(y.position = max_y + (row_number() - 1) * 2 + 20)
        results[[paste(sex_label, chem, marker, sep = "_")]] <- pairwise_results
      }
    }
  }
  bind_rows(results)
}

# Split and test by sex and PFAS
data_female <- data_water %>% filter(Sex == "Female")
data_male <- data_water %>% filter(Sex == "Male")

sig_female_pfos <- get_significance_non_parametric(data_female %>% filter(PFAS == "PFOS"), "Female")
sig_female_pfoa <- get_significance_non_parametric(data_female %>% filter(PFAS == "PFOA"), "Female")
sig_male_pfos   <- get_significance_non_parametric(data_male %>% filter(PFAS == "PFOS"), "Male")
sig_male_pfoa   <- get_significance_non_parametric(data_male %>% filter(PFAS == "PFOA"), "Male")

significance_df_non_parametric <- bind_rows(
  sig_female_pfos, sig_female_pfoa, sig_male_pfos, sig_male_pfoa
)

# Summary
summary_stats <- data_water %>%
  group_by(Sex, PFAS, Dose, Marker) %>%
  summarise(
    median = median(Change_from_baseline, na.rm = TRUE),
    Q1 = quantile(Change_from_baseline, 0.25, na.rm = TRUE),
    Q3 = quantile(Change_from_baseline, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    DoseSex = paste0(Dose, "_", substr(Sex, 1, 1)),
    lower = Q1,
    upper = Q3
  )

female_colors <- c(
"Naive"   = "black",
"Vehicle" = "#fee2e2",
"0.166"   = "#fecaca",
"0.5"     = "#fca5a5",
"1"       = "#f87171",
"1.5"     = "#e53e3e"
)

male_colors <- c(
  "Naive"   = "black",
"Vehicle" = "#eff6ff",
"0.166"   = "#bfdbfe",
"0.5"     = "#93c5fd",
"1"       = "#60a5fa",
"1.5"     = "#3b82f6"
)

dose_levels <- names(female_colors)

dose_sex_colors <- c(
  setNames(female_colors, paste0(dose_levels, "_F")),
  setNames(male_colors, paste0(dose_levels, "_M"))
)

# Plot
p <- ggplot(summary_stats, aes(x = Marker, y = median, group = DoseSex, color = DoseSex)) +
  geom_line(size = 1, linetype = "solid") +  # solid lines for all
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  facet_wrap(Sex ~ PFAS, scales = "free_y") +
  scale_color_manual(values = dose_sex_colors) +
  labs(
    title = "Median Body Weight Change Over Time (± IQR)",
    x = "Week",
    y = "Δ Body Weight (g)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(p)
ggsave(filename = "plots/water_consumption.png", plot = p, width = 7, height = 5, dpi = 300, bg = "white")
```
